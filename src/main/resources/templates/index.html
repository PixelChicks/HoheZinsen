<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Interest Rate Offers</title>
    <script defer src="/js/theme-persistence.js"></script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/styles.css" rel="stylesheet">
    <link href="/css/index.css" rel="stylesheet">
    <link href="/css/dark-mode.css" rel="stylesheet">
    <style>
        @import url('https://api.fonts.coollabs.io/css2?family=Mona+Sans:wght@200;300;400;500;600;700;800;900&display=swap');

        * {
            font-family: 'Mona Sans', sans-serif !important;
        }
    </style>
</head>
<body th:classappend="${#authorization.expression('isAuthenticated()')} ? 'authenticated' : 'guest'">

<nav class="top-navigation">
    <div class="container">
        <div class="nav-content">
            <div class="nav-logo">Logo</div>
            <div class="nav-links">
                <a class="nav-link" href="#">Compare</a>
                <a class="nav-link" href="#">FAQs</a>
                <div id="darkModeToggleContainer" class="theme-segmented-switch">
                    <button id="lightModeBtn"
                            class="switch-segment active-segment"
                            aria-label="Activate light mode"
                            onclick="window.darkModeControls.disable()">
                        <svg class="sun-icon" viewBox="0 0 24 24">‚òº</svg>
                    </button>

                    <button id="darkModeBtn"
                            class="switch-segment"
                            aria-label="Activate dark mode"
                            onclick="window.darkModeControls.enable()">
                        <svg class="moon-icon" viewBox="0 0 24 24">‚òæ</svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
</nav>

<!-- Hero Section -->
<div class="hero-section">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-7 col-md-6">
                <div class="hero-content">
                    <h1>Top-Zinsen sichern:<br>Jetzt mehr aus Ihrem Geld machen</h1>
                    <p>Die aktuell h√∂chsten Zinsangebote f√ºr Ihr Erspartes ‚Äì transparent und objektiv.</p>
                </div>
            </div>
            <div class="col-lg-5 col-md-6 d-flex justify-content-center">
                <img alt="Illustration showing financial growth and percentages"
                     class="hero-illustration-image"
                     src="/images/hero-illustration.png"
                     style="max-width: 90%; height: auto;">
            </div>
        </div>
    </div>
</div>
<div class="vergleichen-section">
    <div class="card-body py-2">
        <small>
            <button class="nav-logo" id="quickCompareBtn" onclick="quickStartComparison()">
                Vergleichen
            </button>
        </small>
        <span th:text="${lastUpdateMessage}">Last updated 20 hours ago</span>
    </div>
</div>
<div class="vergleichen-section">
    <div class="card-body py-2">
        <div class="comparison-section" id="comparisonSection" style="display: none;">
            <div class="comparison-header">
            </div>

            <div class="comparison-limit-warning" id="comparisonWarning">
                Sie k√∂nnen maximal 3 Zinss√§tze gleichzeitig vergleichen. Entfernen Sie einen Vergleich, um einen neuen
                hinzuzuf√ºgen.
            </div>

            <div class="comparison-container" id="comparisonContainer">
                <!-- Comparison layout will be populated here -->
            </div>

            <div class="empty-comparison-state" id="emptyComparisonState">
                <p>click a provider from the table below to add to compare</p>
            </div>
        </div>
    </div>
</div>
<div class="container py-4">
    <!-- View Toggle for Mobile -->
    <div class="view-toggle d-md-none">
        <div aria-label="View toggle" class="btn-group" role="group">
            <button class="btn btn-outline-primary active" id="stackedView" type="button">
                üì± Card View
            </button>
            <button class="btn btn-outline-primary" id="scrollView" type="button">
                üìä Table View
            </button>
        </div>
    </div>

    <div class="filter-section" id="filterSection">
        <div class="filter-content" id="filterContent">
            <div class="active-filters" id="activeFilters">
            </div>
            <div class="filter-grid" id="filterGrid">
            </div>
        </div>
    </div>

    <div class="table-with-checkboxes-container">
        <!-- Checkbox column - positioned absolutely to left of table -->
        <div class="external-checkboxes-column" id="externalCheckboxes">
            <!-- Checkboxes will be populated here by JavaScript -->
        </div>
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-spinner"></div>
        </div>

        <div class="scroll-indicator" id="scrollIndicator">‚Üê Scroll horizontally to see more ‚Üí</div>

        <div class="table-responsive" id="tableContainer">
            <table class="table table-sm" id="mainTable">
                <thead class="table">
                <tr id="column-header-row">
                    <th onclick="sortTable(this, event)"
                        th:attr="ondragend=${#authorization.expression('isAuthenticated()')} ? 'handleDragEnd(event)' : null,
                                 ondragover=${#authorization.expression('isAuthenticated()')} ? 'handleDragOver(event)' : null,
                                 ondragstart=${#authorization.expression('isAuthenticated()')} ? 'handleDragStart(event)' : null,
                                 ondrop=${#authorization.expression('isAuthenticated()')} ? 'handleDrop(event)' : null"
                        th:class="${#authorization.expression('isAuthenticated()')} ? 'draggable-column sortable' : 'sortable'"
                        th:data-column-index="${iterStat.index}"
                        th:data-field-id="${field.id}"
                        th:data-field-key="${field.fieldKey}"
                        th:draggable="${#authorization.expression('isAuthenticated()')}"
                        th:each="field, iterStat : ${globalFields}">

                        <div class="header-container">
                            <span class="header-text" th:text="${field.label}"></span>
                        </div>
                    </th>
                    <th class="no-drag"></th>
                </tr>
                </thead>

                <tbody id="tableBody">
                <!-- Data rows will be populated by JavaScript -->
                </tbody>
            </table>

            <!-- Empty state -->
            <div class="empty-state" id="emptyState" style="display: none;">
                <div>üìä</div>
                <h5>No interest rates found</h5>
                <p>Try adjusting your search criteria or add a new interest rate.</p>
            </div>
        </div>
    </div>

    <div class="load-more-container mt-4 mb-4 text-center">
        <div class="loading-more-indicator" id="loadingMoreIndicator" style="display: none;">
            <div class="text-center py-4">
                <div class="spinner-border spinner-border-sm me-2" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <span class="text-muted">Loading more rates...</span>
            </div>
        </div>

        <button class="nav-logo" id="loadMoreBtn" onclick="loadMoreData()">
            Load More Rates
        </button>

        <div class="end-of-data-indicator mt-3" id="endOfDataIndicator" style="display: none;">
            <div class="text-muted">
                <small>You've reached the end of the results</small>
            </div>
        </div>

        <div class="results-info-footer mt-2" id="resultsInfoFooter">
        </div>
    </div>

    <div class="comparison-status" id="comparisonStatus"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script th:inline="javascript">
    // ============================================================================
    // GLOBAL VARIABLES AND STATE
    // ============================================================================

    const isAuthenticated = /*[[${#authorization.expression('isAuthenticated()')}]]*/ false;

    let initialRates = /*[[${interestRates}]]*/ [];
    let initialTotalElements = /*[[${totalElements}]]*/ 0;
    let initialPageSize = /*[[${pageSize}]]*/ 5;

    let currentPage = 1;
    let pageSize = initialPageSize;
    let totalRecords = initialTotalElements;
    let totalPages = Math.ceil(totalRecords / pageSize);

    let currentSortColumn = /*[[${sortBy}]]*/ 'id';
    let currentSortDirection = /*[[${sortDir}]]*/ 'asc';
    let currentSearchTerm = /*[[${search}]]*/ '';

    let serverRateFieldValuesMap = /*[[${rateFieldValuesMap}]]*/ {};
    let globalFieldsCache = /*[[${globalFields}]]*/ [];
    let globalFieldsCompareCache = /*[[${globalFieldsCompare}]]*/ [];
    let allLoadedData = [...initialRates];

    let isLoading = false;
    let isLoadingMore = false;
    let hasMoreData = totalPages > 1;
    let currentExpandedCard = null;
    let currentEditForm = null;
    let isInitialLoadComplete = false;
    let comparedRates = new Map();
    let expandedRateCards = new Set();
    let maxComparisons = 3;

    let availableFilters = [];
    let activeFilters = new Map();
    let filterExpanded = false;

    // ============================================================================
    // UTILITY FUNCTIONS (Loading, Comparisons, etc.)
    // ============================================================================

    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    async function fetchMissingRateData(rateIds) {
        try {
            const promises = rateIds.map(rateId =>
                fetch(`/api/interest-rate/${rateId}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Failed to fetch rate ${rateId}`);
                        }
                        return response.json();
                    })
                    .then(rateData => {
                        if (rateData && rateData.fieldValues) {
                            serverRateFieldValuesMap[rateId] = rateData.fieldValues;
                        }
                        return rateData;
                    })
                    .catch(error => {
                        console.warn(`Could not fetch data for rate ${rateId}:`, error);
                        return null;
                    })
            );

            await Promise.all(promises);
            console.log('Successfully fetched missing rate data');
        } catch (error) {
            console.error('Error fetching missing rate data:', error);
        }
    }

    function maintainComparisonState() {
        comparedRates.forEach((rate, rateId) => {
            const externalCheckbox = document.getElementById(`external-compare-${rateId}`);
            if (externalCheckbox) {
                externalCheckbox.checked = true;
            }
            updateTableRowHighlight(rateId, true);
        });
        refreshAllVergleichenButtons();
    }

    function showLoading() {
        isLoading = true;
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) overlay.classList.add('show');
    }

    function hideLoading() {
        isLoading = false;
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) overlay.classList.remove('show');
    }

    function showDeleteNotification(message, isError) {
        const notification = document.getElementById('comparisonStatus');
        if (notification) {
            notification.textContent = message;
            notification.className = `comparison-status ${isError ? 'error' : 'success'}`;
            notification.classList.add('show');

            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
    }

    function updateMaxComparisons() {
        const tableContainer = document.getElementById('tableContainer');
        const isMobileCardView = tableContainer && tableContainer.classList.contains('mobile-stack');
        maxComparisons = isMobileCardView ? 2 : 3;
    }

    function showStatus(message, type = 'success') {
        const status = document.getElementById('comparisonStatus');
        status.textContent = message;
        status.className = `comparison-status ${type}`;
        status.classList.add('show');

        setTimeout(() => {
            status.classList.remove('show');
        }, 3000);
    }

    function updateTableRowHighlight(rateId, highlight) {
        const row = document.querySelector(`tr[data-rate-id="${rateId}"]`);
        if (row) {
            if (highlight) {
                row.classList.add('table-row-selected');
                row.classList.add('just-selected');
                setTimeout(() => {
                    row.classList.remove('just-selected');
                }, 600);
            } else {
                row.classList.remove('table-row-selected', 'just-selected');
            }
        }
    }

    function updateVergleichenButtonVisibility(rateId, isInComparison) {
        const expandedCardButton = document.querySelector(`#rateCard_${rateId} button[onclick*="startComparisonFromCard(${rateId})"]`);
        const mobileCardButton = document.querySelector(`div[data-rate-id="${rateId}"] button[onclick*="startComparisonFromCard(${rateId})"]`);

        const buttons = [expandedCardButton, mobileCardButton].filter(btn => btn !== null);

        buttons.forEach(button => {
            if (isInComparison) {
                button.style.display = 'none';
            } else {
                button.style.display = 'inline-block';
            }
        });
    }

    function refreshAllVergleichenButtons() {
        const allRateIds = new Set(allLoadedData.map(rate => rate.id));

        allRateIds.forEach(rateId => {
            const isInComparison = comparedRates.has(rateId);
            updateVergleichenButtonVisibility(rateId, isInComparison);
        });
    }

    // ============================================================================
    // LOAD MORE DATA LOGIC
    // ============================================================================

    function updateLoadMoreButtonState() {
        const loadMoreBtn = document.getElementById('loadMoreBtn');
        const loadingMoreIndicator = document.getElementById('loadingMoreIndicator');
        const endOfDataIndicator = document.getElementById('endOfDataIndicator');

        if (isLoadingMore) {
            if (loadMoreBtn) loadMoreBtn.style.display = 'none';
            if (loadingMoreIndicator) loadingMoreIndicator.style.display = 'block';
            if (endOfDataIndicator) endOfDataIndicator.style.display = 'none';
        } else if (hasMoreData) {
            if (loadMoreBtn) {
                loadMoreBtn.style.display = 'inline-block';
                loadMoreBtn.disabled = false;
            }
            if (loadingMoreIndicator) loadingMoreIndicator.style.display = 'none';
            if (endOfDataIndicator) endOfDataIndicator.style.display = 'none';
        } else {
            if (loadMoreBtn) loadMoreBtn.style.display = 'none';
            if (loadingMoreIndicator) loadingMoreIndicator.style.display = 'none';
            if (endOfDataIndicator) endOfDataIndicator.style.display = 'block';
        }
    }

    function updateResultsInfo() {
        const infoFooter = document.getElementById('resultsInfoFooter');
        const endRecord = allLoadedData.length;

        const infoText = `Showing ${endRecord} of ${totalRecords} results`;
        if (infoFooter) infoFooter.textContent = infoText;
    }

    async function loadMoreData() {
        if (isLoadingMore || !hasMoreData || isLoading) return;

        const nextPage = Math.floor(allLoadedData.length / pageSize) + 1;

        if (nextPage > totalPages) {
            hasMoreData = false;
            updateLoadMoreButtonState();
            return;
        }

        isLoadingMore = true;
        updateLoadMoreButtonState();

        try {
            const data = await fetchPageData(nextPage, currentSearchTerm, currentSortColumn, currentSortDirection);

            if (data && data.content && data.content.length > 0) {
                const existingIds = new Set(allLoadedData.map(r => r.id));
                const uniqueNewContent = data.content.filter(r => !existingIds.has(r.id));

                if (uniqueNewContent.length > 0) {
                    totalPages = data.totalPages;
                    totalRecords = data.totalElements;

                    allLoadedData = [...allLoadedData, ...uniqueNewContent];

                    Object.assign(serverRateFieldValuesMap, data.rateFieldValuesMap || {});

                    renderTableData(uniqueNewContent, true);

                    updateResultsInfo();
                }

                hasMoreData = allLoadedData.length < totalRecords;

                const currentRateIds = new Set(data.content.map(rate => rate.id));
                const comparedRatesNeedingData = [];
                comparedRates.forEach((rate, rateId) => {
                    if (!currentRateIds.has(rateId) && !serverRateFieldValuesMap[rateId]) {
                        comparedRatesNeedingData.push(rateId);
                    }
                });

                if (comparedRatesNeedingData.length > 0) {
                    await fetchMissingRateData(comparedRatesNeedingData);
                    updateComparisonDisplay();
                }

                maintainComparisonState();
            } else {
                hasMoreData = false;
            }
        } catch (error) {
            console.error('Error loading more data:', error);
            showDeleteNotification('Error loading more data: ' + error.message, true);
        } finally {
            isLoadingMore = false;
            updateLoadMoreButtonState();
        }
    }

    async function fetchPageData(page, searchTerm = '', sortBy = null, sortDir = null) {
        const params = new URLSearchParams({
            page: page - 1,
            size: pageSize,
            sortBy: sortBy || currentSortColumn,
            sortDir: sortDir || currentSortDirection
        });

        if (searchTerm && searchTerm.trim()) {
            params.append('search', searchTerm.trim());
        }

        if (typeof activeFilters !== 'undefined' && activeFilters.size > 0) {
            activeFilters.forEach((values, fieldId) => {
                if (values.size > 0) {
                    const filterValue = Array.from(values).join('|');
                    params.set(`filter_${fieldId}`, encodeURIComponent(filterValue));
                }
            });
        }

        const response = await fetch(`/api/interest-rates?${params.toString()}`);

        if (!response.ok) {
            throw new Error('Failed to fetch data');
        }

        return await response.json();
    }

    async function reloadDataFromServer(searchTerm = '', sortBy = null, sortDir = null) {
        if (isLoading) return;

        showLoading();
        isLoadingMore = true;
        updateLoadMoreButtonState();

        try {
            const data = await fetchPageData(1, searchTerm, sortBy, sortDir);

            currentPage = 1;
            totalPages = data.totalPages;
            totalRecords = data.totalElements;
            currentSearchTerm = searchTerm || '';
            currentSortColumn = sortBy || currentSortColumn;
            currentSortDirection = sortDir || currentSortDirection;
            pageSize = data.size || pageSize;

            allLoadedData = data.content;
            Object.assign(serverRateFieldValuesMap, data.rateFieldValuesMap || {});

            renderTableData(allLoadedData, false);

            updateResultsInfo();
            hasMoreData = allLoadedData.length < totalRecords;
            updateLoadMoreButtonState();

            if (currentExpandedCard) closeExpandedCard(currentExpandedCard);
            maintainComparisonState();

            updateBrowserUrlWithFilters();

        } catch (error) {
            console.error('Error loading page:', error);
            showDeleteNotification('Error loading data: ' + error.message, true);
        } finally {
            hideLoading();
            isLoadingMore = false;
            updateLoadMoreButtonState();
        }
    }

    // ============================================================================
    // INITIALIZATION AND DOCUMENT READY
    // ============================================================================

    document.addEventListener('DOMContentLoaded', function () {
        totalPages = Math.ceil(totalRecords / pageSize);
        hasMoreData = totalPages > 1;

        initializeComparisonState();
        initializeSortableHeaders();
        initializeMobileViewToggle();

        renderTableData(allLoadedData, false);

        updateResultsInfo();
        updateLoadMoreButtonState();

        isInitialLoadComplete = true;

        initializeFilters();
    });

    function initializeComparisonState() {
        window.addEventListener('resize', debounce(updateMaxComparisons, 250));
        updateMaxComparisons();
    }

    function initializeSortableHeaders() {
        document.querySelectorAll('.draggable-column, .sortable').forEach(header => {
            header.classList.add('sortable');
        });
    }

    function initializeMobileViewToggle() {
        const stackedViewBtn = document.getElementById('stackedView');
        const scrollViewBtn = document.getElementById('scrollView');
        const tableContainer = document.getElementById('tableContainer');
        const isMobile = window.innerWidth <= 768;

        if (stackedViewBtn && scrollViewBtn && tableContainer) {
            // Initial state based on screen size
            if (isMobile) {
                tableContainer.classList.add('mobile-stack');
                stackedViewBtn.classList.add('active');
                scrollViewBtn.classList.remove('active');
            } else {
                tableContainer.classList.remove('mobile-stack');
                scrollViewBtn.classList.add('active');
                stackedViewBtn.classList.remove('active');
            }

            stackedViewBtn.addEventListener('click', function() {
                tableContainer.classList.add('mobile-stack');
                stackedViewBtn.classList.add('active');
                scrollViewBtn.classList.remove('active');
                renderTableData(allLoadedData, false);
                updateMaxComparisons();
            });

            scrollViewBtn.addEventListener('click', function() {
                tableContainer.classList.remove('mobile-stack');
                scrollViewBtn.classList.add('active');
                stackedViewBtn.classList.remove('active');
                renderTableData(allLoadedData, false);
                updateMaxComparisons();
            });
        }
    }

    // ============================================================================
    // TABLE RENDERING AND DATA DISPLAY
    // ============================================================================

    function renderTableData(data, append = false) {
        const tbody = document.getElementById('tableBody');
        const emptyState = document.getElementById('emptyState');
        const tableContainer = document.getElementById('tableContainer');

        const isMobileCardView = tableContainer && tableContainer.classList.contains('mobile-stack');

        if (!allLoadedData || allLoadedData.length === 0) {
            tbody.innerHTML = '';
            emptyState.style.display = 'block';
            updateExternalCheckboxes([]);
            return;
        }

        emptyState.style.display = 'none';

        const contentHtml = isMobileCardView ? renderMobileCardsHTML(data) : renderTableRowsHTML(data);

        if (append) {
            tbody.insertAdjacentHTML('beforeend', contentHtml);
        } else {
            const allContentHtml = isMobileCardView ? renderMobileCardsHTML(allLoadedData) : renderTableRowsHTML(allLoadedData);
            tbody.innerHTML = allContentHtml;
        }

        if (document.body.classList.contains('comparison-mode')) {
            setTimeout(() => {
                alignExternalCheckboxes();
            }, 50);
        }

        maintainComparisonState();
    }

    function renderMobileCardsHTML(data) {
        return data.map(rate => createMobileCard(rate)).join('');
    }

    function renderTableRowsHTML(data) {
        if (!data || data.length === 0) return '';

        const headers = document.querySelectorAll('.draggable-column, .sortable');
        const currentFieldOrder = Array.from(headers)
            .map(header => ({
                id: header.dataset.fieldId,
                fieldKey: header.dataset.fieldKey,
                label: header.querySelector('.header-text').textContent.trim()
            }));

        return data.map(rate => {
            const isSelected = comparedRates.has(rate.id);

            const fieldCells = currentFieldOrder.map((field) => {
                const fieldValue = serverRateFieldValuesMap[rate.id]?.[field.id] || '';

                if (field.fieldKey && field.fieldKey.toLowerCase().includes('img')) {
                    return `
                        <td class="data-cell image-cell" data-field-id="${field.id}" data-label="${field.label}">
                            <div class="image-container">
                                ${fieldValue ? `<img src="${fieldValue}" alt="Interest Rate Logo" class="interest-rate-logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />` : ''}
                                <div class="no-image-placeholder" style="${fieldValue ? 'display:none' : 'display:block'}">No Image</div>
                            </div>
                        </td>
                    `;
                } else {
                    return `
                        <td class="data-cell" data-field-id="${field.id}" data-label="${field.label}">
                            <div class="form-control form-control-sm text-center"
                                 style="border: none; background: transparent; cursor: default;">
                                ${fieldValue || '-'}
                            </div>
                        </td>
                    `;
                }
            }).join('');

            const isExpanded = expandedRateCards.has(rate.id);
            const actionButtons = `
                <div class="action-buttons">
                    <button class="mehr-info-btn"
                            ${rate.moreInfo ? '' : 'disabled'}
                            onclick="showMoreInfo(${rate.id})"
                            title="${isExpanded ? 'Hide info' : (rate.moreInfo ? 'Show more info' : 'No additional info available')}">
                        ${rate.moreInfo ?
                            (isExpanded ?
                                `<svg width="16" height="10" viewBox="0 0 16 10" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M14.9995 9L7.99951 2L0.999512 9" stroke="#00AC98" stroke-width="2"/>
                                </svg>` :
                                `MEHR INFO <svg width="16" height="10" viewBox="0 0 16 10" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M1 1L8 8L15 1" stroke="#00AC98" stroke-width="2"/>
                                </svg>`
                            ) :
                            'No Info'
                        }
                    </button>
                </div>
            `;

            return `
                <tr data-rate-id="${rate.id}" ${isSelected ? 'class="table-row-selected"' : ''}>
                    ${fieldCells}
                    <td data-label="Actions">
                        ${actionButtons}
                    </td>
                </tr>
            `;
        }).join('');
    }

    // ============================================================================
    // SEARCH, SORT, AND FILTER
    // ============================================================================

    function performSearch() {
        const searchInput = document.getElementById('searchInput');
        const searchTerm = searchInput ? searchInput.value.trim() : '';
        reloadDataFromServer(searchTerm, currentSortColumn, currentSortDirection);
    }

    function clearSearch() {
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.value = '';
        }
        reloadDataFromServer('', currentSortColumn, currentSortDirection);
    }

    function sortTable(headerElement, event) {
        if (event && event.type === 'click' && headerElement.classList.contains('dragging')) {
            return;
        }

        const fieldId = headerElement.dataset.fieldId;
        const sortBy = `field_${fieldId}`;

        let sortDirection = 'asc';
        if (currentSortColumn === sortBy) {
            sortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
        }

        document.querySelectorAll('.sortable')
            .forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });
        headerElement.classList.add(sortDirection === 'asc' ? 'sort-asc' : 'sort-desc');

        reloadDataFromServer(currentSearchTerm, sortBy, sortDirection);
    }

    function applyFilters() {
        const searchInput = document.getElementById('searchInput');

        if (activeFilters.size > 0) {
            if (searchInput) {
                searchInput.value = '';
            }
            reloadDataFromServer('', currentSortColumn, currentSortDirection);
        } else {
            reloadDataFromServer(currentSearchTerm, currentSortColumn, currentSortDirection);
        }

        updateBrowserUrlWithFilters();
        if (window.innerWidth <= 768) {
            toggleFilters();
        }
    }

    function clearAllFilters() {
        activeFilters.clear();
        updateFilterCheckboxes();
        updateActiveFiltersDisplay();

        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.value = currentSearchTerm;
        }

        reloadDataFromServer(currentSearchTerm, currentSortColumn, currentSortDirection);

        updateBrowserUrlWithFilters();
    }

    function removeFilterTag(fieldId, value) {
        if (activeFilters.has(fieldId)) {
            activeFilters.get(fieldId).delete(value);
            if (activeFilters.get(fieldId).size === 0) {
                activeFilters.delete(fieldId);
            }
        }
        updateFilterCheckboxes();
        updateActiveFiltersDisplay();
        applyFilters();
    }


    function initializeFilters() {
        fetch('/filters/available')
            .then(response => {
                if (response.ok) return response.json();
                throw new Error('Failed to load filters');
            })
            .then(data => {
                availableFilters = data;
                renderFilterGrid();
                initializeFromUrlParams();
            })
            .catch(error => {
                console.error('Error loading filters:', error);
            });
    }

    function initializeFromUrlParams() {
        const urlParams = new URLSearchParams(window.location.search);

        for (const [key, value] of urlParams.entries()) {
            if (key.startsWith('filter_')) {
                const fieldId = key.substring(7);
                const decodedValue = decodeURIComponent(value);
                const values = decodedValue.includes('|') ? decodedValue.split('|') : [decodedValue];
                activeFilters.set(fieldId, new Set(values));
            }
        }

        if (activeFilters.size > 0) {
            updateActiveFiltersDisplay();
            updateFilterCheckboxes();
        }
    }

    function toggleFilters() {
        const content = document.getElementById('filterContent');
        const toggle = document.getElementById('filterToggle');
        filterExpanded = !filterExpanded;
        if (filterExpanded) {
            content.classList.add('show');
            toggle.classList.add('expanded');
        } else {
            content.classList.remove('show');
            toggle.classList.remove('expanded');
        }
    }

    function renderFilterGrid() {
        const grid = document.getElementById('filterGrid');

        // **IMPORTANT:** Since we are showing horizontal filters, we hide the main toggle logic
        // and rely on the filter-content being displayed via CSS overrides.

        grid.innerHTML = availableFilters.map(filter => {
            const fieldIdStr = filter.fieldId.toString();
            const currentSelection = Array.from(activeFilters.get(fieldIdStr) || []).join('');

            // Start of the select element
            let selectHtml = `
                <select
                    class="filter-dropdown-pill"
                    onchange="updateFilterFromDropdown(this, ${filter.fieldId})"
                    data-field-id="${filter.fieldId}">
            `;

            selectHtml += `<option value="">${filter.label} ‚ñº</option>`;

            // Filter options
            selectHtml += filter.options.map(option => `
                <option
                    value="${option.value}"
                    ${option.value === currentSelection ? 'selected' : ''}>
                    ${option.label}
                </option>
            `).join('');

            selectHtml += `</select>`;

            return `
                <div class="filter-item" data-field-id="${filter.fieldId}">
                    <h6>${filter.label}</h6>
                    ${selectHtml}
                </div>
            `;
        }).join('');
    }

    function updateFilterFromDropdown(selectElement, fieldId) {
        const fieldIdStr = fieldId.toString();
        const value = selectElement.value;

        // Clear previous selection for this field
        activeFilters.delete(fieldIdStr);

        // Add new selection if it's not the default 'All' option (value == '')
        if (value !== '') {
            activeFilters.set(fieldIdStr, new Set([value]));
        }

        applyFilters();
    }

    function toggleFilterOption(fieldId, value) {
        const fieldIdStr = fieldId.toString();

        if (!activeFilters.has(fieldIdStr)) {
            activeFilters.set(fieldIdStr, new Set());
        }

        const fieldFilters = activeFilters.get(fieldIdStr);

        if (fieldFilters.has(value)) {
            fieldFilters.delete(value);
            if (fieldFilters.size === 0) {
                activeFilters.delete(fieldIdStr);
            }
        } else {
            fieldFilters.add(value);
        }

        updateFilterCheckboxes();
        updateActiveFiltersDisplay();
    }

    function updateFilterCheckboxes() {
        availableFilters.forEach(filter => {
            const fieldIdStr = filter.fieldId.toString();
            const selectedValues = activeFilters.get(fieldIdStr) || new Set();

            filter.options.forEach(option => {
                const checkboxId = `filter_${filter.fieldId}_${option.value.replace(/[^a-zA-Z0-9]/g, '_')}`;
                const checkbox = document.getElementById(checkboxId);
                if (checkbox) {
                    checkbox.checked = selectedValues.has(option.value);
                }
            });
        });
    }

    function updateActiveFiltersDisplay() {
        const container = document.getElementById('activeFilters');
        const tags = [];

        activeFilters.forEach((values, fieldId) => {
            const filter = availableFilters.find(f => f.fieldId.toString() === fieldId);
            if (filter) {
                values.forEach(value => {
                    tags.push(`
                        <span class="filter-tag">
                            ${filter.label}: ${value}
                            <button class="remove-filter" onclick="removeFilterTag('${fieldId}', '${value}')" title="Remove filter">
                                ‚úï
                            </button>
                        </span>
                    `);
                });
            }
        });

        container.innerHTML = tags.join('');
        container.style.display = tags.length > 0 ? 'flex' : 'none';
    }

    function updateBrowserUrlWithFilters() {
        const url = new URL(window.location);
        url.search = '';
        const params = new URLSearchParams();
        params.set('sortBy', currentSortColumn);
        params.set('sortDir', currentSortDirection);
        params.set('size', pageSize);
        if (currentSearchTerm) {
            params.set('search', currentSearchTerm);
        }
        const sortedFilters = Array.from(activeFilters.entries()).sort((a, b) => a[0] - b[0]);
        sortedFilters.forEach(([fieldId, values]) => {
            if (values.size > 0) {
                const filterValue = Array.from(values).join('|');
                params.set(`filter_${fieldId}`, encodeURIComponent(filterValue));
            }
        });
        url.search = params.toString();
        window.history.replaceState({}, '', url);
    }

    // ============================================================================
    // COMPARISON & MORE INFO
    // ============================================================================

    function toggleComparison(rateId, isChecked) {
        if (isChecked) {
            addToComparison(rateId);
        } else {
            removeFromComparison(rateId);
        }
    }

    function addToComparison(rateId) {
        updateMaxComparisons();

        if (comparedRates.size >= maxComparisons) {
            const maxText = maxComparisons === 2 ? '2' : '3';
            showStatus(`Maximum number of comparisons reached (${maxText})`, 'warning');
            const checkbox = document.getElementById(`external-compare-${rateId}`);
            if (checkbox) checkbox.checked = false;
            return;
        }

        let rate = allLoadedData.find(r => r.id === rateId);

        if (rate && !comparedRates.has(rateId)) {
            comparedRates.set(rateId, rate);

            if (!serverRateFieldValuesMap[rateId]) {
                fetchMissingRateData([rateId]).then(() => {
                    updateComparisonDisplay();
                });
            } else {
                updateComparisonDisplay();
            }

            updateTableRowHighlight(rateId, true);
            updateVergleichenButtonVisibility(rateId, true);

            const providerName = serverRateFieldValuesMap[rateId]?.[1] || `Rate #${rateId}`;
            showStatus(`${providerName} added to comparison`, 'success');
        }
    }

    function removeFromComparison(rateId) {
        if (comparedRates.has(rateId)) {
            comparedRates.delete(rateId);
            updateComparisonDisplay();
            updateTableRowHighlight(rateId, false);

            updateVergleichenButtonVisibility(rateId, false);

            showStatus(`Aus dem Vergleich entfernt`, 'info');

            const externalCheckbox = document.getElementById(`external-compare-${rateId}`);
            if (externalCheckbox) {
                externalCheckbox.checked = false;
            }
        }
    }

    function clearAllComparisons() {
        document.querySelectorAll('.external-checkbox').forEach(checkbox => {
            checkbox.checked = false;
        });

        comparedRates.forEach((rate, rateId) => {
            updateTableRowHighlight(rateId, false);
            updateVergleichenButtonVisibility(rateId, false);
        });

        comparedRates.clear();
        updateComparisonDisplay();
        showStatus('All comparisons cleared', 'info');
        document.body.classList.remove('comparison-mode');
        const quickCompareBtn = document.getElementById('quickCompareBtn');
        if (quickCompareBtn) {
            quickCompareBtn.style.display = "inline-block";
        }
    }

    function updateComparisonDisplay() {
        const section = document.getElementById('comparisonSection');
        const container = document.getElementById('comparisonContainer');
        const emptyState = document.getElementById('emptyComparisonState');

        if (comparedRates.size === 0) {
            section.style.display = 'none';
            document.getElementById("quickCompareBtn").style.display = "inline-block";
            return;
        }

        section.style.display = 'block';
        emptyState.style.display = 'none';

        container.innerHTML = createComparisonLayout();
    }

    function createComparisonLayout() {
        const tableContainer = document.getElementById('tableContainer');
        const isMobileCardView = tableContainer && tableContainer.classList.contains('mobile-stack');

        if (isMobileCardView) {
            return createMobileComparisonLayout();
        } else {
            return createDesktopComparisonLayout();
        }
    }

    function createMobileComparisonLayout() {
        const cardsHtml = `
            <div class="mobile-comparison-container">
                ${Array.from(comparedRates.entries()).map(([rateId, rate]) =>
                    createMobileComparisonCard(rate)
                ).join('')}
                ${comparedRates.size < 2 ? createEmptyMobileComparisonCard() : ''}
            </div>
        `;
        return cardsHtml;
    }

    function createMobileComparisonCard(rate) {
        const rateFieldValues = serverRateFieldValuesMap[rate.id] || {};

        if (Object.keys(rateFieldValues).length === 0) {
            fetchMissingRateData([rate.id]).then(() => {
                updateComparisonDisplay();
            });
            return `
                <div class="mobile-comparison-card">
                    <div class="mobile-comparison-header">
                        <span class="mobile-provider-name">Loading...</span>
                        <button class="mobile-remove-btn" onclick="removeFromComparison(${rate.id})">‚úï</button>
                    </div>
                </div>
            `;
        }

        const providerName = rateFieldValues[globalFieldsCompareCache[1]?.id] || 'Provider';

        let logoHtml = '<span style="color: #999;">(logo)</span>';
        const imageField = globalFieldsCompareCache.find(
            f => f.fieldKey && f.fieldKey.toLowerCase().includes("img")
        );
        if (imageField) {
            const imageUrl = rateFieldValues[imageField.id];
            if (imageUrl && imageUrl !== "-") {
                logoHtml = `<img src="${imageUrl}" alt="Logo" style="max-height: 70px; max-width: 140px; object-fit: contain;">`;
            }
        }

        const fieldRows = globalFieldsCompareCache
            .filter(field => !(field.fieldKey && field.fieldKey.toLowerCase().includes("img")))
            .map(field => {
                const value = rateFieldValues[field.id] || "-";
                return `
                    <div class="mobile-field-row">
                        <div class="mobile-field-label">${field.label.toUpperCase()}</div>
                        <div class="mobile-field-value">${value}</div>
                    </div>
                `;
            }).join('');

        return `
            <div class="mobile-comparison-card">
                <div class="mobile-comparison-header">
                    <button class="mobile-remove-btn" onclick="removeFromComparison(${rate.id})" title="Remove">‚úï</button>
                </div>
                <div class="mobile-logo-section">
                    ${logoHtml}
                </div>
                <div class="mobile-comparison-fields">
                    ${fieldRows}
                </div>
                <div class="mobile-mehr-info-section">
                    <a href="javascript:void(0)"
                       class="${rate.moreInfo ? 'mobile-mehr-link' : 'mobile-mehr-link disabled'}"
                       onclick="${rate.moreInfo ? `showMoreInfo(${rate.id})` : 'return false;'}"
                       style="${rate.moreInfo ? 'color: #00b894;' : 'color: #ccc; pointer-events: none;'}">
                        ${rate.moreInfo ? 'MEHR INFO' : 'No Info'}
                    </a>
                </div>
            </div>
        `;
    }

    function createEmptyMobileComparisonCard() {
        return `
            <div class="mobile-comparison-card empty">
                <div class="empty-card-content">
                    <p style="font-size: 13px; color: #666; text-align: center; margin: 0;">
                        Click a provider<br>to compare
                    </p>
                </div>
            </div>
        `;
    }

    function createDesktopComparisonLayout() {
        const labelsHtml = `
            <div class="comparison-labels">
                ${globalFieldsCompareCache
                    .filter(field => !(field.fieldKey && field.fieldKey.toLowerCase().includes("img")))
                    .map(field => `
                        <div class="comparison-label-row">${field.label}</div>
                    `).join('')}
            </div>
        `;

        const cardsHtml = `
            <div class="comparison-cards-container">
                ${Array.from(comparedRates.entries()).map(([rateId, rate], index) =>
                    createComparisonCardNew(rate, index === 0)
                ).join('')}
                ${comparedRates.size < maxComparisons ? createEmptyComparisonCards(maxComparisons - comparedRates.size) : ''}
            </div>
        `;

        return labelsHtml + cardsHtml;
    }

    function createEmptyComparisonCards(count) {
        let cards = '';
        for (let i = 0; i < count; i++) {
            cards += `
                <div class="empty-comparison-card">
                    click a provider from the table<br>below to add to compare
                </div>
            `;
        }
        return cards;
    }

    function createComparisonCardNew(rate, isFirstCard = false) {
        const rateFieldValues = serverRateFieldValuesMap[rate.id] || {};

        if (Object.keys(rateFieldValues).length === 0) {
            fetchMissingRateData([rate.id]).then(() => {
                updateComparisonDisplay();
            });

            return `
                <div class="comparison-card">
                    <div class="comparison-card-header">
                        <div class="provider-info">
                            <span class="provider-name">Loading Rate #${rate.id}...</span>
                        </div>
                        <button class="remove-comparison" onclick="removeFromComparison(${rate.id})" title="Remove">
                            ‚úï
                        </button>
                    </div>
                    <div class="comparison-values">
                        ${globalFieldsCompareCache.map((_, index) => `
                            <div class="comparison-value-row ${index % 2 === 0 ? 'row-even' : 'row-odd'}">Loading...</div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        let headerImage = null;
        let headerImageFieldId = null;
        const imageField = globalFieldsCompareCache.find(
            f => f.fieldKey && f.fieldKey.toLowerCase().includes("img")
        );

        if (imageField) {
            const imageUrl = rateFieldValues[imageField.id];
            if (imageUrl && imageUrl !== "-") {
                headerImageFieldId = imageField.id;
                headerImage = `<img src="${imageUrl}" alt="Logo" class="comparison-logo"
                                  style="height: 100px; width: auto; object-fit: contain;">`;
            }
        }

        const valueRows = globalFieldsCompareCache
            .filter(field => field.id !== headerImageFieldId && !(field.fieldKey && field.fieldKey.toLowerCase().includes("img")))
            .map((field, index) => {
                const value = rateFieldValues[field.id] || "-";
                const rowClass = index % 2 === 0 ? 'row-even' : 'row-odd';
                return `<div class="comparison-value-row ${rowClass}" data-label="${field.label}">${value}</div>`;
            }).join("");

        const checkmarkSvg = isFirstCard ? `
            <svg width="25" height="24" viewBox="0 0 25 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="position: absolute; left: -15px; top: 31px;">
              <rect width="24" height="24" rx="12" fill="#F4F4F4"></rect>
              <path d="M5 9.5L11.5 16L22.5 5" stroke="#01AC99" stroke-width="5" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
        ` : '';

        return `
            <div class="comparison-card">
                ${checkmarkSvg}
                <div class="comparison-card-header">
                    <div class="provider-info d-flex align-items-center">
                        ${headerImage || '<span class="text-muted">No Logo</span>'}
                    </div>
                    <button class="remove-comparison" onclick="removeFromComparison(${rate.id})" title="Remove">
                        ‚úï
                    </button>
                </div>
                <div class="comparison-values">
                    ${valueRows}
                    <div style="display: flex; justify-content: center; align-items: center; padding-top: 16px; padding-bottom: 16px;">
                       <a href="javascript:void(0)"
                           class="${rate.moreInfo ? '' : 'disabled'}"
                           onclick="${rate.moreInfo ? `showMoreInfo(${rate.id})` : 'return false;'}"
                           title="${rate.moreInfo ? 'Show more info' : 'No additional info available'}"
                           style="font-weight: bold; color: ${rate.moreInfo ? '#00b894' : '#ccc'}; text-decoration: none; cursor: pointer;">
                            ${rate.moreInfo ? 'MEHR INFO' : 'No Info'}
                       </a>
                    </div>
                </div>
            </div>
        `;
    }

    function showMoreInfo(rateId) {
        let rate = allLoadedData.find(r => r.id === rateId);

        if (expandedRateCards.has(rateId)) {
            closeExpandedCard(rateId);
            expandedRateCards.delete(rateId);
            updateMehrInfoButton(rateId, false);
            alignExternalCheckboxes();
            return;
        }

        if (!rate) {
            showStatus('Rate data not found locally, fetching details...', 'info');
            fetchRateDetails(rateId).then(rateData => {
                if (rateData && rateData.moreInfo) {
                    if (rateData.fieldValues) {
                        serverRateFieldValuesMap[rateId] = rateData.fieldValues;
                    }
                    if (!allLoadedData.find(r => r.id === rateId)) {
                        allLoadedData.push(rateData);
                    }
                    displayRateCard(rateData);
                } else {
                    showStatus('No additional information available for this rate.', 'warning');
                }
            });
            return;
        }

        if (!rate.moreInfo) {
            showStatus('No additional information available for this rate.', 'warning');
            return;
        }

        if (currentExpandedCard && currentExpandedCard !== rateId) {
            closeExpandedCard(currentExpandedCard);
            expandedRateCards.delete(currentExpandedCard);
            updateMehrInfoButton(currentExpandedCard, false);
        }

        displayRateCard(rate);
        expandedRateCards.add(rateId);
        updateMehrInfoButton(rateId, true);
        alignExternalCheckboxes();
    }

    function displayRateCard(rate) {
        let existingCard = document.getElementById(`rateCardRow_${rate.id}`);
        if (existingCard) {
            existingCard.style.display = 'none';
            setTimeout(() => {
                if (existingCard.parentNode) {
                    existingCard.parentNode.removeChild(existingCard);
                }
            }, 0);

            if (currentExpandedCard === rate.id) {
                currentExpandedCard = null;
                return;
            }
        }

        const tableContainer = document.getElementById('tableContainer');
        const isMobileCardView = tableContainer && tableContainer.classList.contains('mobile-stack');

        let targetElement = document.querySelector(isMobileCardView ? `div.mobile-interest-card[data-rate-id="${rate.id}"]` : `tr[data-rate-id="${rate.id}"]`);

        if (!targetElement) {
            console.error('Target element not found for rate ID:', rate.id);
            return;
        }

        const card = createRateCard(rate);

        if (isMobileCardView) {
            card.style.borderTop = 'none';
            card.style.borderRadius = '0 0 12px 12px';
            card.style.marginTop = '0';
            targetElement.appendChild(card);
            targetElement.classList.add('card-expanded');
        } else {
            const cardContainer = document.createElement('tr');
            cardContainer.id = `rateCardRow_${rate.id}`;
            cardContainer.className = 'rate-card-row show';
            cardContainer.innerHTML = `<td colspan="100%" class="rate-card-cell"></td>`;
            cardContainer.querySelector('.rate-card-cell').appendChild(card);
            targetElement.insertAdjacentElement('afterend', cardContainer);
        }

        setTimeout(() => {
            if (isMobileCardView) {
                targetElement.scrollIntoView({
                    behavior: 'smooth',
                    block: 'nearest'
                });
            } else {
                const cardRow = document.getElementById(`rateCardRow_${rate.id}`);
                if (cardRow) {
                    cardRow.scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });
                }
            }
        }, 50);

        currentExpandedCard = rate.id;
    }

    function createRateCard(rate) {
        const card = document.createElement('div');
        card.className = 'rate-card';
        card.id = `rateCard_${rate.id}`;

        const moreInfo = rate.moreInfo;
        if (!moreInfo) return card;

        const sectionOrder = moreInfo.sectionOrder || [];
        const tableSectionsMap = new Map();
        const textSectionsMap = new Map();

        if (moreInfo.tableSections) {
            moreInfo.tableSections.forEach(tableSection => {
                tableSectionsMap.set(tableSection.sectionIdentifier, tableSection);
            });
        }

        if (moreInfo.textSections) {
            moreInfo.textSections.forEach(textSection => {
                textSectionsMap.set(textSection.sectionIdentifier, textSection);
            });
        }

        const createTableSection = (tableSection) => {
            if (!tableSection || !tableSection.title || !tableSection.miniTableRows || tableSection.miniTableRows.length === 0) {
                return '';
            }
            return `
                <div class="expanded-section ${isAuthenticated ? 'draggable-section' : ''} table-section"
                     data-section-type="table"
                     data-section-id="${tableSection.sectionIdentifier}">
                    <h5 class="section-title">${tableSection.title}</h5>
                    <div class="info-table">
                        ${tableSection.miniTableRows.map(row => `
                            <div class="info-table-row">
                                <div class="info-table-label">${row.label || ''}</div>
                                <div class="info-table-value">${row.description || ''}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        };

        const createTextSection = (textSection) => {
            if (!textSection || (!textSection.title && !textSection.content)) {
                return '';
            }

            return `
                <div class="expanded-section ${isAuthenticated ? 'draggable-section' : ''} text-section"
                     data-section-type="text"
                     data-section-id="${textSection.sectionIdentifier}">
                    ${textSection.title ? `<h5 class="section-title">${textSection.title}</h5>` : ''}
                    <div class="text-content" style="text-align: left;">${textSection.content || ''}</div>
                </div>
            `;
        };

        let sectionsHTML = '';
        sectionOrder.forEach(sectionIdentifier => {
            if (sectionIdentifier.startsWith('table-')) {
                const tableSection = tableSectionsMap.get(sectionIdentifier);
                if (tableSection) {
                    sectionsHTML += createTableSection(tableSection);
                }
            } else if (sectionIdentifier.startsWith('text-')) {
                const textSection = textSectionsMap.get(sectionIdentifier);
                if (textSection) {
                    sectionsHTML += createTextSection(textSection);
                }
            }
        });

        tableSectionsMap.forEach((tableSection, identifier) => {
            if (!sectionOrder.includes(identifier)) {
                sectionsHTML += createTableSection(tableSection);
            }
        });

        textSectionsMap.forEach((textSection, identifier) => {
            if (!sectionOrder.includes(identifier)) {
                sectionsHTML += createTextSection(textSection);
            }
        });

        const isInComparison = comparedRates.has(rate.id);
        const buttonDisplay = isInComparison ? 'display: none;' : '';

        const compareButton = `
            <div class="rate-card-actions"
                 style="display: flex; justify-content: flex-end; gap: 16px; margin-bottom:16px; margin-right: 25px;">

                <a class="angebot-btn"
                   href="${rate.webLink || '#'}"
                   target="_blank"
                   title="Open Link">
                    ZUM ANGEBOT
                </a>

                <button type="button"
                        class="mehr-info-btn"
                        onclick="startComparisonFromCard(${rate.id})"
                        style="${buttonDisplay}">
                    VERGLEICHEN
                </button>
            </div>
        `;

    card.innerHTML = `
        <style>
          @media (max-width: 768px) {
            .mobile-hr { display: block; }
          }
          @media (min-width: 769px) {
            .mobile-hr { display: none; }
          }
        </style>

        <div class="rate-expanded-content show">
            <hr class="mobile-hr"
                style="border: none; border-top: 3px dotted #000; margin: 1px 0; padding-bottom: 2px;">
            ${sectionsHTML}
            ${compareButton}
        </div>
    `;

        return card;
    }

    function startComparisonFromCard(currentRateId) {
        if (comparedRates.size >= maxComparisons) {
            showStatus('Maximum number of comparisons reached (3)', 'warning');
            return;
        }

        // 1. Activate Comparison Mode
        document.body.classList.add('comparison-mode');

        // **CRITICAL FIX: Align checkboxes immediately**
        alignExternalCheckboxes();

        const comparisonSection = document.getElementById('comparisonSection');
        if (comparisonSection) {
            comparisonSection.style.display = 'block';
        }

        const quickCompareBtn = document.getElementById('quickCompareBtn');
        if (quickCompareBtn) {
            quickCompareBtn.style.display = 'none';
        }

        let shouldAddFirstRecord = comparedRates.size === 0;

        if (shouldAddFirstRecord) {
            let firstRateId = allLoadedData.length > 0 ? allLoadedData[0].id : null;

            if (firstRateId && firstRateId !== currentRateId && comparedRates.size < maxComparisons) {
                const firstRate = allLoadedData.find(r => r.id === firstRateId);
                if (firstRate) {
                    comparedRates.set(firstRateId, firstRate);
                    const firstCheckbox = document.getElementById(`external-compare-${firstRateId}`);
                    if (firstCheckbox) firstCheckbox.checked = true;
                    updateTableRowHighlight(firstRateId, true);
                }
            }
        }

        if (comparedRates.has(currentRateId)) {
            showStatus('This rate is already in comparison', 'info');
            scrollToComparison();
            setTimeout(() => {
                closeExpandedCard(currentRateId);
            }, 1000);
            return;
        }

        if (comparedRates.size >= maxComparisons) {
            showStatus('Maximum number of comparisons reached (3)', 'warning');
            return;
        }

        let currentRate = allLoadedData.find(r => r.id === currentRateId);
        if (!currentRate) {
            fetchRateDetails(currentRateId).then(fetchedRate => {
                if (fetchedRate) {
                    comparedRates.set(currentRateId, fetchedRate);
                    if (fetchedRate.fieldValues) {
                        serverRateFieldValuesMap[currentRateId] = fetchedRate.fieldValues;
                    }
                    updateComparisonDisplay();
                    scrollToComparison();
                }
            });
        } else {
            comparedRates.set(currentRateId, currentRate);
            const currentCheckbox = document.getElementById(`external-compare-${currentRateId}`);
            if (currentCheckbox) currentCheckbox.checked = true;
            updateTableRowHighlight(currentRateId, true);
        }

        updateComparisonDisplay();
        scrollToComparison();

        const rateCount = comparedRates.size;
        if (rateCount === 1) {
            showStatus('Comparison mode activated! Rate added to comparison.', 'success');
        } else {
            showStatus(`${rateCount} rates added to comparison!`, 'success');
        }

        setTimeout(() => {
            closeExpandedCard(currentRateId);
        }, 1000);
    }

    function scrollToComparison() {
        setTimeout(() => {
            const comparisonSection = document.getElementById('comparisonSection');
            if (comparisonSection) {
                comparisonSection.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        }, 500);
    }

    function closeExpandedCard(rateId) {
        const tableContainer = document.getElementById('tableContainer');
        const isMobileCardView = tableContainer && tableContainer.classList.contains('mobile-stack');

        if (isMobileCardView) {
            const mobileCard = document.querySelector(`div.mobile-interest-card[data-rate-id="${rateId}"]`);
            if (mobileCard) {
                const expandedContent = mobileCard.querySelector('.rate-card');
                if (expandedContent) {
                    expandedContent.remove();
                }
                mobileCard.classList.remove('card-expanded');
            }
        } else {
            const cardRow = document.getElementById(`rateCardRow_${rateId}`);
            if (cardRow) {
                cardRow.style.display = 'none';
                cardRow.classList.remove('show');
                requestAnimationFrame(() => {
                    if (cardRow.parentNode) {
                        cardRow.parentNode.removeChild(cardRow);
                    }
                });
            }
        }

        if (currentExpandedCard === rateId) {
            currentExpandedCard = null;
        }

        expandedRateCards.delete(rateId);
        updateMehrInfoButton(rateId, false);
    }

    function updateMehrInfoButton(rateId, isExpanded) {
        const tableButton = document.querySelector(`tr[data-rate-id="${rateId}"] .mehr-info-btn`);
        const mobileButton = document.querySelector(`div[data-rate-id="${rateId}"] .mehr-info-btn`);

        const buttons = [tableButton, mobileButton].filter(btn => btn !== null);

        buttons.forEach(button => {
            if (button && !button.disabled) {
                const isMobileButton = button.closest('.mobile-interest-card') !== null;

                if (isExpanded) {
                    button.innerHTML = `<svg width="16" height="10" viewBox="0 0 16 10" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M14.9995 9L7.99951 2L0.999512 9" stroke="#00AC98" stroke-width="2"/>
                    </svg>`;
                    button.title = "Hide info";
                } else {
                    const buttonText = isMobileButton ? 'MEHR' : 'MEHR INFO';
                    button.innerHTML = `${buttonText} <svg width="16" height="10" viewBox="0 0 16 10" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M1 1L8 8L15 1" stroke="#00AC98" stroke-width="2"/>
                    </svg>`;
                    button.title = "Show more info";
                }
            }
        });
    }

    function fetchRateDetails(rateId) {
        return fetch(`/api/interest-rate/${rateId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch rate details');
                }
                return response.json();
            })
            .catch(error => {
                console.error('Error fetching rate details:', error);
                showDeleteNotification('Error loading rate details: ' + error.message, true);
                return null;
            });
    }

    function quickStartComparison() {
        if (!allLoadedData || allLoadedData.length === 0) {
            showStatus('No rates available to compare.', 'warning');
            return;
        }

        const firstRate = allLoadedData[0];
        const firstRateId = firstRate.id;

        document.getElementById("quickCompareBtn").style.display = "none";
        document.body.classList.add('comparison-mode');

        alignExternalCheckboxes();

        const comparisonSection = document.getElementById('comparisonSection');
        if (comparisonSection) {
            comparisonSection.style.display = 'block';
        }

        if (!comparedRates.has(firstRateId)) {
            const rate = allLoadedData.find(r => r.id === firstRateId);

            if (rate) {
                comparedRates.set(firstRateId, rate);

                const firstCheckbox = document.getElementById(`external-compare-${firstRateId}`);
                if (firstCheckbox) {
                    firstCheckbox.checked = true;
                    firstCheckbox.dispatchEvent(new Event('change'));
                } else {
                    updateTableRowHighlight(firstRateId, true);
                }
            }
        }

        updateComparisonDisplay();
        scrollToComparison();

        const rateCount = comparedRates.size;
        showStatus(`Comparison mode activated! ${rateCount} rate${rateCount === 1 ? ' is' : 's are'} selected.`, 'success');
    }

    function updateExternalCheckboxes(data) {
        const checkboxColumn = document.getElementById('externalCheckboxes');
        if (!checkboxColumn) return;

        if (!data || data.length === 0) {
            checkboxColumn.innerHTML = '';
            return;
        }

        const checkboxRows = data.map(rate => {
            const isSelected = comparedRates.has(rate.id);
            return `
                <div class="external-checkbox-row" data-rate-id="${rate.id}">
                    <div class="custom-checkbox-container">
                        <input type="checkbox"
                               class="comparison-checkbox external-checkbox"
                               onchange="toggleComparison(${rate.id}, this.checked)"
                               id="external-compare-${rate.id}"
                               ${isSelected ? 'checked' : ''}>
                        <div class="custom-checkbox"></div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function alignExternalCheckboxes() {
        const table = document.getElementById('mainTable');
        const externalCheckboxes = document.getElementById('externalCheckboxes');

        if (!table || !externalCheckboxes) return;

        if (!document.body.classList.contains('comparison-mode')) {
            externalCheckboxes.innerHTML = '';
            return;
        }

        const rows = table.querySelectorAll('tbody tr:not(.rate-card-row)');
        externalCheckboxes.innerHTML = '';

        if (rows.length === 0) return;

        rows.forEach((row) => {
            const rateId = row.getAttribute('data-rate-id');
            if (!rateId) return;

            const checkboxRow = document.createElement('div');
            checkboxRow.className = 'external-checkbox-row';
            checkboxRow.setAttribute('data-rate-id', rateId);

            const checkboxContainer = document.createElement('div');
            checkboxContainer.className = 'custom-checkbox-container';

            const checkboxInput = document.createElement('input');
            checkboxInput.type = 'checkbox';
            checkboxInput.className = 'comparison-checkbox external-checkbox';
            checkboxInput.id = `external-compare-${rateId}`;

            const isSelected = comparedRates.has(parseInt(rateId));
            checkboxInput.checked = isSelected;

            const customCheckbox = document.createElement('div');
            customCheckbox.className = 'custom-checkbox';

            checkboxInput.addEventListener('change', () => {
                toggleComparison(parseInt(rateId), checkboxInput.checked);
            });

            customCheckbox.addEventListener('click', () => {
                checkboxInput.checked = !checkboxInput.checked;
                checkboxInput.dispatchEvent(new Event('change'));
            });

            checkboxContainer.appendChild(checkboxInput);
            checkboxContainer.appendChild(customCheckbox);
            checkboxRow.appendChild(checkboxContainer);

            externalCheckboxes.appendChild(checkboxRow);
        });

        requestAnimationFrame(() => {
            positionCheckboxes();
        });
    }

    function positionCheckboxes() {
        const table = document.getElementById('mainTable');
        const externalCheckboxes = document.getElementById('externalCheckboxes');

        if (!table || !externalCheckboxes) return;

        const rows = table.querySelectorAll('tbody tr:not(.rate-card-row)');
        const checkboxRows = externalCheckboxes.querySelectorAll('.external-checkbox-row');

        rows.forEach((row, index) => {
            const checkboxRow = checkboxRows[index];
            if (!checkboxRow) return;

            const rowHeight = row.offsetHeight;
            const rowTop = row.offsetTop;

            checkboxRow.style.position = 'absolute';
            checkboxRow.style.top = `${rowTop}px`;
            checkboxRow.style.height = `${rowHeight}px`;
            checkboxRow.style.display = 'flex';
            checkboxRow.style.alignItems = 'center';
        });
    }

    window.addEventListener('load', alignExternalCheckboxes);
    window.addEventListener('resize', alignExternalCheckboxes);

    function createMobileCard(rate) {
        const headers = document.querySelectorAll('.draggable-column, .sortable');
        const currentFieldOrder = Array.from(headers)
            .map(header => ({
                id: header.dataset.fieldId,
                fieldKey: header.dataset.fieldKey,
                label: header.querySelector('.header-text').textContent.trim()
            }));

        const isSelected = comparedRates && comparedRates.has ? comparedRates.has(rate.id) : false;
        const fieldValues = serverRateFieldValuesMap[rate.id] || {};

        let logoHtml = '<span style="color: #6c757d; font-size: 12px;">logo</span>';
        const imageField = currentFieldOrder.find(f => f.fieldKey && f.fieldKey.toLowerCase().includes('img'));
        if (imageField && fieldValues[imageField.id]) {
            logoHtml = `<img src="${fieldValues[imageField.id]}" alt="Logo" style="max-height: 50px; max-width: 100px; object-fit: contain;">`;
        }

        const displayFields = currentFieldOrder
            .filter(field => !(field.fieldKey && field.fieldKey.toLowerCase().includes('img')))
            .slice(1, 5);

        const gridHtml = displayFields.map(field => {
            const value = fieldValues[field.id] || '-';
            return `
                <div class="info-field">
                    <div class="info-field-label">${field.label.toUpperCase()}</div>
                    <div class="info-field-value">${value}</div>
                </div>
            `;
        }).join('');

        const rateValue = fieldValues[currentFieldOrder[0]?.id] || '0,00';
        const isExpanded = expandedRateCards.has(rate.id);

        return `
            <div class="mobile-card-row" data-rate-id="${rate.id}">
                <div class="mobile-interest-card" data-rate-id="${rate.id}" ${isExpanded ? 'class="mobile-interest-card card-expanded"' : 'class="mobile-interest-card"'}>
                    <div class="card-header">
                        <h6 data-rate="${rateValue}"></h6>
                        <div class="card-logo-area">
                            ${logoHtml}
                        </div>
                        <div class="card-logo-area">
                            <button class="mehr-info-btn"
                                    ${rate.moreInfo ? '' : 'disabled'}
                                    onclick="showMoreInfo(${rate.id})"
                                    title="${rate.moreInfo ? 'Show more info' : 'No additional info available'}">
                                ${isExpanded ?
                                    `<svg width="12" height="8" viewBox="0 0 12 8" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M11 7L6 2L1 7" stroke="currentColor" stroke-width="2"/></svg>` :
                                    `MEHR <svg width="12" height="8" viewBox="0 0 12 8" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1 1L6 6L11 1" stroke="currentColor" stroke-width="2"/></svg>`
                                }
                            </button>
                        </div>
                    </div>

                    <div class="card-body">
                        <div class="card-info-grid">
                            ${gridHtml}
                        </div>
                    </div>
                    ${isExpanded ? createRateCard(rate).outerHTML : ''}
                </div>
            </div>
        `;
    }

</script>
<script defer src="/js/dark-mode.js"></script>
</body>
</html>