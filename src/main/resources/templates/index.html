<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Interest Rate Offers</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #column-header-row {
            cursor: grab;
        }
        #column-header-row th {
            user-select: none;
        }

        .rate-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin: 10px 0;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .rate-header {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .rate-main-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .rate-percentage {
            font-size: 2.5rem;
            font-weight: bold;
            color: #00b894;
            margin: 0;
        }

        .rate-percentage-symbol {
            font-size: 1.5rem;
            color: #00b894;
            vertical-align: top;
        }

        .rate-details {
            display: flex;
            gap: 20px;
            font-size: 0.9rem;
            color: #6c757d;
        }

        .rate-detail-item {
            display: flex;
            flex-direction: column;
        }

        .rate-detail-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 2px;
        }

        .rate-provider {
            background: #dc3545;
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .rate-actions {
            display: flex;
            gap: 10px;
        }

        .btn-mehr-info {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-mehr-info:hover {
            background: #138496;
        }

        .btn-angebot {
            background: #00b894;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-angebot:hover {
            background: #00a085;
        }

        .rate-expanded-content {
            display: none;
            padding: 0;
        }

        .rate-expanded-content.show {
            display: block;
        }

        .expanded-section {
            padding: 20px;
            border-bottom: 1px solid #f1f1f1;
        }

        .expanded-section:last-child {
            border-bottom: none;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #495057;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #00b894;
        }

        .info-table {
            background: #f8f9fa;
            border-radius: 6px;
            overflow: hidden;
        }

        .info-table-row {
            display: flex;
            border-bottom: 1px solid #dee2e6;
        }

        .info-table-row:last-child {
            border-bottom: none;
        }

        .info-table-label {
            background: #e9ecef;
            padding: 12px 15px;
            font-weight: 600;
            min-width: 200px;
            color: #495057;
            border-right: 1px solid #dee2e6;
        }

        .info-table-value {
            padding: 12px 15px;
            flex: 1;
            color: #6c757d;
        }

        .text-content {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 20px;
            line-height: 1.6;
            color: #495057;
        }

        .close-btn {
            background: none;
            border: none;
            color: #6c757d;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .close-btn:hover {
            background: #e9ecef;
            color: #495057;
        }

        .mehr-info-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mehr-info-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
        }

        .mehr-info-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Header editing styles */
        .header-container {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .header-text {
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .header-text:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .edit-header-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            border-radius: 3px;
            padding: 2px 6px;
            font-size: 11px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .header-container:hover .edit-header-btn {
            opacity: 1;
        }

        .edit-header-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .header-edit-form {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 300px;
            display: none;
        }

        .header-edit-form.show {
            display: block;
        }

        .form-row {
            margin-bottom: 10px;
        }

        .form-row label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 4px;
        }

        .form-row input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #dee2e6;
            border-radius: 3px;
            font-size: 13px;
        }

        .form-buttons {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 12px;
        }

        .form-buttons button {
            padding: 6px 12px;
            border: none;
            border-radius: 3px;
            font-size: 12px;
            cursor: pointer;
        }

        .save-btn {
            background: #28a745;
            color: white;
        }

        .cancel-btn {
            background: #6c757d;
            color: white;
        }
    </style>
</head>
<body class="bg-light">
<div class="container py-4">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Interest Rate Offers</h2>
        <a href="/interest-rate/new" class="btn btn-primary">+ Add New Interest Rate</a>
    </div>

    <!-- Form to Add a New Global Field -->
    <form th:action="@{/fields/add}" th:object="${newField}" method="post" class="mb-4">
        <div class="row g-2">
            <div class="col-md-4">
                <input th:field="*{fieldKey}" class="form-control" placeholder="Field Key (e.g. maxDeposit)" />
            </div>
            <div class="col-md-4">
                <input th:field="*{label}" class="form-control" placeholder="Label (e.g. Max Deposit)" />
            </div>
            <div class="col-md-4">
                <button class="btn btn-primary w-100">Add Field</button>
            </div>
        </div>
    </form>

    <!-- Interest Rate Table -->
    <div class="table-responsive">
        <table class="table table-bordered table-striped text-center align-middle">
            <thead class="table-dark">
            <tr id="column-header-row">
                <!-- Dynamic Headers with Edit Functionality -->
                <th th:each="field : ${globalFields}">
                    <div class="header-container">
                        <span class="header-text" th:text="${field.label}"></span>
                        <button type="button" class="edit-header-btn" th:onclick="'showEditForm(' + ${field.id} + ')'">✎</button>

                        <!-- Edit Form -->
                        <div th:id="'editForm_' + ${field.id}" class="header-edit-form">
                            <form th:action="@{/fields/update}" method="post">
                                <input type="hidden" name="fieldId" th:value="${field.id}" />

                                <div class="form-row">
                                    <label>Field Key:</label>
                                    <input type="text" name="fieldKey" th:value="${field.fieldKey}" required />
                                </div>

                                <div class="form-row">
                                    <label>Display Label:</label>
                                    <input type="text" name="label" th:value="${field.label}" required />
                                </div>

                                <div class="form-buttons">
                                    <button type="submit" class="save-btn">Save</button>
                                    <button type="button" class="cancel-btn" th:onclick="'hideEditForm(' + ${field.id} + ')'">Cancel</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </th>
                <th></th>
            </tr>
            </thead>

            <tbody>
            <tr th:each="rate : ${interestRates}">
                <!-- Dynamic fields -->
                <td th:each="field : ${globalFields}">
                    <form th:action="@{/field-values/update}" method="post" class="d-flex justify-content-center">
                        <input type="hidden" name="rateId" th:value="${rate.id}" />
                        <input type="hidden" name="fieldId" th:value="${field.id}" />
                        <input type="text"
                               name="value"
                               th:value="${rateFieldValuesMap[rate.id]?.get(field.id)}"
                               class="form-control form-control-sm text-center"
                               style="width: 100px;" />
                    </form>
                </td>

                <!-- Actions -->
                <td>
                    <button class="mehr-info-btn"
                            th:onclick="'showMoreInfo(' + ${rate.id} + ')'"
                            th:disabled="${rate.moreInfo == null}"
                            th:text="${rate.moreInfo != null ? 'MEHR INFO' : 'No Info'}">
                    </button>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
</div>

<script th:inline="javascript">
    // Pass server data to JavaScript
    const interestRatesData = /*[[${interestRates}]]*/ [
        // Mock data for demonstration
        {
            id: 1,
            moreInfo: {
                tableTitle: "Table Section Title",
                miniTableRows: [
                    { label: "Label", description: "Full text description" },
                    { label: "Label", description: "Full text description" },
                    { label: "Label", description: "Full text description" },
                    { label: "Label", description: "Full text description" }
                ],
                textTitle: "Text Section Title",
                textDescription: "Example text - Einlagen inklusive aufgelaufener Zinserträge sind bis zu einem Betrag von 100.000 EUR je Kunde und je Bank gesetzlich durch den italienischen Einlagensicherungsfonds abgesichert. Innerhalb der Europäischen Union sind die Mindestanforderungen in allen Mitgliedsstaaten harmonisiert durch die Richtlinie 94/19/EG, 2009/14/EG und 2014/49/EU. Zu beachten ist, dass sich diese Absicherung auf die gesamten Einlagen eines Kunden bei einer Bank bezieht. Dies ist dann relevant, wenn nicht nur über den WeltSparen vermittelte Einlagen eines Kunden bei einer bestimmten Bank angelegt werden, sondern noch weitere Einlagen dieses Kunden bei der jeweiligen Bank angelegt wurden."
            }
        },
        {
            id: 2,

            moreInfo: {
                tableTitle: "Rate Details",
                miniTableRows: [
                    { label: "Minimum Deposit", description: "1,000€" },
                    { label: "Maximum Deposit", description: "100,000€" }
                ],
                textTitle: "Terms and Conditions",
                textDescription: "This is a variable rate product with end-of-period payment structure."
            }
        },
        {
            id: 3,

            moreInfo: null
        }
    ];

    let currentExpandedCard = null;
    let currentEditForm = null;

    // Header editing functions
    function showEditForm(fieldId) {
        // Hide any currently open edit form
        if (currentEditForm && currentEditForm !== fieldId) {
            hideEditForm(currentEditForm);
        }

        const form = document.getElementById(`editForm_${fieldId}`);
        form.classList.add('show');
        currentEditForm = fieldId;

        // Focus on the first input
        const firstInput = form.querySelector('input[type="text"]');
        if (firstInput) {
            firstInput.focus();
            firstInput.select();
        }
    }

    function hideEditForm(fieldId) {
        const form = document.getElementById(`editForm_${fieldId}`);
        form.classList.remove('show');
        if (currentEditForm === fieldId) {
            currentEditForm = null;
        }
    }

    // Close edit forms when clicking outside
    document.addEventListener('click', function(e) {
        if (currentEditForm && !e.target.closest('.header-container') && !e.target.closest('.header-edit-form')) {
            hideEditForm(currentEditForm);
        }
    });

    // Prevent form closure when clicking inside the form
    document.addEventListener('click', function(e) {
        if (e.target.closest('.header-edit-form')) {
            e.stopPropagation();
        }
    });

    function showMoreInfo(rateId) {
        const rate = interestRatesData.find(r => r.id === rateId);
        if (!rate || !rate.moreInfo) return;

        // Close any currently expanded card
        if (currentExpandedCard && currentExpandedCard !== rateId) {
            closeExpandedCard(currentExpandedCard);
        }

        // Check if card already exists
        let existingCard = document.getElementById(`rateCard_${rateId}`);
        if (existingCard) {
            existingCard.remove();
            if (currentExpandedCard === rateId) {
                currentExpandedCard = null;
                return;
            }
        }

        // Find the table row that was clicked
        const tableRows = document.querySelectorAll('tbody tr');
        let targetRow = null;

        tableRows.forEach(row => {
            const button = row.querySelector('.mehr-info-btn');
            if (button && button.onclick && button.onclick.toString().includes(`showMoreInfo(${rateId})`)) {
                targetRow = row;
            }
        });

        if (!targetRow) return;

        // Create new card
        const card = createRateCard(rate);

        // Create a new table row to hold the card
        const cardRow = document.createElement('tr');
        cardRow.id = `rateCardRow_${rateId}`;
        cardRow.innerHTML = `<td colspan="100%" style="padding: 0; background: transparent;"></td>`;

        // Insert the card into the cell
        cardRow.firstChild.appendChild(card);

        // Insert the card row after the clicked row
        targetRow.parentNode.insertBefore(cardRow, targetRow.nextSibling);

        // Scroll to the card
        card.scrollIntoView({ behavior: 'smooth', block: 'center' });

        currentExpandedCard = rateId;
    }

    function createRateCard(rate) {
        const card = document.createElement('div');
        card.className = 'rate-card';
        card.id = `rateCard_${rate.id}`;

        const moreInfo = rate.moreInfo;

        let tableHTML = '';
        if (moreInfo.tableTitle && moreInfo.miniTableRows && moreInfo.miniTableRows.length > 0) {
            tableHTML = `
                <div class="expanded-section">
                    <h5 class="section-title">${moreInfo.tableTitle}</h5>
                    <div class="info-table">
                        ${moreInfo.miniTableRows.map(row => `
                            <div class="info-table-row">
                                <div class="info-table-label">${row.label || ''}</div>
                                <div class="info-table-value">${row.description || ''}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        let textHTML = '';
        if (moreInfo.textTitle || moreInfo.textDescription) {
            textHTML = `
                <div class="expanded-section">
                    ${moreInfo.textTitle ? `<h5 class="section-title">${moreInfo.textTitle}</h5>` : ''}
                    <div class="text-content">${moreInfo.textDescription || ''}</div>
                </div>
            `;
        }

        card.innerHTML = `
            <div class="rate-expanded-content show">
                ${tableHTML}
                ${textHTML}
            </div>
        `;

        return card;
    }

    function closeExpandedCard(rateId) {
        const cardRow = document.getElementById(`rateCardRow_${rateId}`);
        if (cardRow) {
            cardRow.remove();
            if (currentExpandedCard === rateId) {
                currentExpandedCard = null;
            }
        }
    }

    // Close expanded card when clicking outside
    document.addEventListener('click', function(e) {
        if (currentExpandedCard && !e.target.closest('.rate-card') && !e.target.closest('.mehr-info-btn')) {
            // Don't auto-close, let user explicitly close
        }
    });
</script>

</body>
</html>