<!DOCTYPE html>
<html xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Interest Rate Offers</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/styles.css" rel="stylesheet">
    <link href="/css/index.css" rel="stylesheet">
    <style>
        /* Comparison Section Styles */
        .comparison-section {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 2rem;
            padding: 1.5rem;
        }

        .comparison-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .comparison-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
            color: #333;
        }

        .clear-comparison-btn {
            background: #dc3545;
            border: none;
            color: white;
            padding: 0.375rem 0.75rem;
            border-radius: 4px;
            font-size: 0.875rem;
            cursor: pointer;
            margin-left: auto;
        }

        .clear-comparison-btn:hover {
            background: #c82333;
        }

        .comparison-container {
            display: flex;
            gap: 1rem;
            overflow-x: auto;
            padding-bottom: 1rem;
        }

        .comparison-card {
            background: white;
            border: 2px solid #00b894;
            border-radius: 8px;
            padding: 1rem;
            min-width: 400px;
            flex-shrink: 0;
            position: relative;
        }

        .comparison-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #eee;
        }

        .provider-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .provider-logo {
            width: 32px;
            height: 32px;
            object-fit: contain;
            border-radius: 4px;
        }

        .provider-name {
            font-weight: 600;
            color: #333;
            font-size: 0.9rem;
        }

        .remove-comparison {
            background: none;
            border: none;
            color: #dc3545;
            font-size: 1.1rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .remove-comparison:hover {
            color: #c82333;
            background-color: #f8f9fa;
            border-radius: 50%;
        }

        .comparison-details {
            margin-bottom: 1rem;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 0.4rem 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.85rem;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-weight: 500;
            color: #666;
            flex-shrink: 0;
            margin-right: 0.5rem;
        }

        .detail-value {
            color: #333;
            text-align: right;
            word-break: break-word;
        }

        .comparison-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .empty-comparison-state {
            text-align: center;
            color: #666;
            padding: 2rem;
            border: 2px dashed #ddd;
            border-radius: 8px;
        }

        .empty-comparison-state .icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            opacity: 0.5;
        }

        /* Table modifications */
        .comparison-checkbox {
            width: 16px;
            height: 16px;
            margin: 0;
            cursor: pointer;
        }

        .table th:first-child,
        .table td:first-child {
            width: 50px;
            text-align: center;
        }

        /* ============================================================================
           CUSTOM CHECKBOX STYLES - ADD TO YOUR EXISTING CSS
           ============================================================================ */

        /* Hide the default checkbox */
        .comparison-checkbox {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        /* Custom checkbox container */
        .custom-checkbox-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        /* Custom checkbox appearance */
        .custom-checkbox {
            position: relative;
            width: 20px;
            height: 20px;
            background-color: #e9ecef;
            border: 2px solid #dee2e6;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        /* Hover state */
        .custom-checkbox:hover {
            border-color: #00b894;
            background-color: #f0f9f7;
        }

        /* Checked state */
        .comparison-checkbox:checked + .custom-checkbox {
            background-color: #e9ecef;
            border-color: #00b894;
        }

        /* Checkmark */
        .custom-checkbox::after {
            content: '✓';
            color: #00b894;
            font-size: 14px;
            font-weight: bold;
            opacity: 0;
            transform: scale(0.5);
            transition: all 0.2s ease;
        }

        /* Show checkmark when checked */
        .comparison-checkbox:checked + .custom-checkbox::after {
            opacity: 1;
            transform: scale(1);
        }

        /* Focus state for accessibility */
        .comparison-checkbox:focus + .custom-checkbox {
            outline: 2px solid #00b894;
            outline-offset: 2px;
        }

        /* Label styling */
        .checkbox-label {
            font-size: 0.8rem;
            color: #333;
            cursor: pointer;
            user-select: none;
            margin: 0;
        }

        /* Table cell specific styling */
        .table .custom-checkbox-container {
            justify-content: center;
        }

        /* Mobile card styling adjustments */
        .mobile-card-checkbox .custom-checkbox-container {
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .mobile-card-checkbox .checkbox-label {
            font-size: 0.8rem;
            color: #666;
        }

        /* Update existing comparison checkbox styles to work with new structure */
        .comparison-mode .custom-checkbox-container {
            display: flex;
        }

        /* Hide custom checkboxes initially */
        .custom-checkbox-container {
            display: none;
        }

        /* Show checkboxes when comparison mode is active */
        .comparison-mode .custom-checkbox-container {
            display: flex;
        }

        /* Enhanced checkbox for selected rows */
        .table-row-selected .custom-checkbox {
            transform: scale(1.1);
            border-color: #1976d2;
        }

        .table-row-selected .comparison-checkbox:checked + .custom-checkbox::after {
            color: #1976d2;
        }

        /* Create a complete border using pseudo-element overlay */
        .table-row-selected::before {
            position: absolute;
            top: 0;        /* Changed from -2px */
            left: 0;       /* Changed from -2px */
            right: 0;      /* Changed from -2px */
            bottom: 0;     /* Changed from -2px */
            border: 3px solid #1976d2;
            border-radius: 4px;  /* Reduced slightly */
            pointer-events: none;
            z-index: 2;
            background: #00b894;
        }

        .table-row-selected {
            background-color: #e3f2fd !important;
            box-shadow:
                inset 3px 0 0 #1976d2,    /* Left border */
                inset -3px 0 0 #1976d2,   /* Right border */
                inset 0 3px 0 #1976d2,    /* Top border */
                inset 0 -3px 0 #1976d2,   /* Bottom border */
                0 2px 8px rgba(25, 118, 210, 0.15); /* Optional shadow */
            position: relative;
            z-index: 1;
        }

        .table-row-selected td {
            background-color: #e3f2fd !important;
            color: #1565c0 !important;
            font-weight: 500 !important;
        }

        /* Alternative approach using box-shadow for cleaner borders */
        .table-row-selected-alt {
            background-color: #e3f2fd !important;
            box-shadow:
                0 0 0 2px #1976d2,
                0 4px 12px rgba(25, 118, 210, 0.15);
            position: relative;
            z-index: 10;
        }

        .table-row-selected-alt td {
            background-color: #e3f2fd !important;
            color: #1565c0 !important;
            font-weight: 500 !important;
            border-color: transparent !important;
        }

        /* Smooth transitions */
        .table tbody tr {
            transition: all 0.2s ease;
        }

        /* Enhanced checkbox for selected rows */
        .table-row-selected .comparison-checkbox,
        .table-row-selected-alt .comparison-checkbox {
            transform: scale(1.15);
            accent-color: #1976d2;
        }

        /* Hover effects */
        .table-row-selected:hover::before {
            background: rgba(25, 118, 210, 0.1);
            border-color: #0d47a1;
        }

        .table-row-selected-alt:hover {
            box-shadow:
                0 0 0 3px #1976d2,
                0 6px 16px rgba(25, 118, 210, 0.2);
        }

        /* Demo table styling */
        .demo-table {
            width: 100%;
            margin: 20px 0;
        }

        .demo-table td, .demo-table th {
            padding: 12px 8px;
            text-align: center;
            border: 1px solid #ddd;
        }

        .demo-table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        /* Button styling for demo */
        .demo-btn {
            background: #1976d2;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin: 2px;
        }

        .demo-btn:hover {
            background: #1565c0;
        }

        .demo-btn.success {
            background: #4caf50;
        }

        /* Selection indicator */
        .selection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #1976d2;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            display: none;
            z-index: 1000;
        }

        .selection-status.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .comparison-limit-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
            text-align: center;
            padding: 0.5rem;
            margin-bottom: 1rem;
            border-radius: 4px;
            font-size: 0.85rem;
            display: none;
        }

        .comparison-status {
            position: fixed;
            top: 20px;
            right: 2px;
            background: #28a745;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-size: 0.875rem;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .comparison-status.show {
            transform: translateX(0);
        }

        .comparison-status.warning {
            background: #ffc107;
            color: #212529;
        }

        .comparison-status.info {
            background: #17a2b8;
        }

        /* Basic table styles */
        .table {
            margin-bottom: 0;
        }

        .table th {
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            font-weight: 600;
            padding: 0.75rem;
        }

        .table td {
            padding: 0.75rem;
            vertical-align: middle;
        }

        .data-cell {
            text-align: center;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
        }

        /* Image display for comparison cards */
        .comparison-image {
            max-width: 100%;
            max-height: 40px;
            object-fit: contain;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .comparison-container {
                flex-direction: column;
            }

            .comparison-card {
                min-width: auto;
                width: 100%;
            }

            .comparison-header {
                flex-direction: column;
                gap: 0.5rem;
                align-items: stretch;
            }

            .clear-comparison-btn {
                margin-left: 0;
                align-self: flex-end;
            }
        }

        .compare-demo-btn {
            background: #17a2b8;
            border: none;
            color: white;
            padding: 0.5rem 1.5rem;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .compare-demo-btn:hover {
            background: #138496;
        }

        .compare-demo-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        /* Hide comparison checkboxes initially */
        .comparison-checkbox,
        .comparison-checkbox + label {
            display: none;
        }

        /* Show checkboxes when comparison mode is active */
        .comparison-mode .comparison-checkbox,
        .comparison-mode .comparison-checkbox + label {
            display: inline-block;
        }

        /* For mobile cards - hide the checkbox container initially */
        .card-actions .comparison-checkbox,
        .card-actions .comparison-checkbox + label {
            display: none;
        }

        .comparison-mode .card-actions .comparison-checkbox,
        .comparison-mode .card-actions .comparison-checkbox + label {
            display: inline-block;
        }
    </style>
</head>
<body class="bg-light" th:classappend="${#authorization.expression('isAuthenticated()')} ? 'authenticated' : 'guest'">
<div class="container py-4">

    <!-- Authentication Status Section -->
    <div class="auth-section" sec:authorize="isAuthenticated()">
        <div class="user-info">
            <div>
                <strong>Welcome, <span sec:authentication="name">User</span>!</strong>
                <span class="text-muted">• Administrator Mode</span>
            </div>
            <div>
                <a class="btn btn-outline-secondary btn-sm" href="/admin/users">Admin Dashboard</a>
            </div>
            <div>
                <a class="btn btn-outline-secondary btn-sm" href="/admin">Admin Page</a>
            </div>

            <div>
                <a class="btn btn-outline-secondary btn-sm" href="/logout">Logout</a>
            </div>
        </div>
    </div>

    <!-- Guest Notice -->
    <div class="guest-notice" sec:authorize="!isAuthenticated()">
        <div class="alert-heading"><strong>👁️ Read-Only Mode</strong></div>
        <p class="mb-2">You are viewing this page as a guest. All data is read-only.</p>
        <p class="mb-0">
            <a class="btn btn-primary btn-sm me-2" href="/login">Login</a>
            <a class="btn btn-outline-primary btn-sm" href="/register">Register</a>
            to access administrative features.
        </p>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
        <div class="d-flex align-items-center flex-wrap">
            <h2 class="me-3 mb-2 mb-md-0">Interest Rate Offers</h2>
        </div>
    </div>

    <!-- Filter Section HTML -->
    <div class="filter-section" id="filterSection">
        <div class="filter-toggle" id="filterToggle" onclick="toggleFilters()">
            <h5>
                🔍 Filters
                <span class="filter-summary" id="filterSummary">Click to add filters</span>
            </h5>
            <span class="chevron">▼</span>
        </div>

        <div class="filter-content" id="filterContent">
            <!-- Active Filters Tags -->
            <div class="active-filters" id="activeFilters">
                <!-- Active filter tags will be populated here -->
            </div>

            <!-- Filter Grid -->
            <div class="filter-grid" id="filterGrid">
                <!-- Filter items will be populated here -->
            </div>

            <!-- Filter Actions -->
            <div class="filter-actions">
                <button class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
                <button class="btn btn-secondary" onclick="clearAllFilters()">Clear All</button>
                <button class="btn btn-outline-secondary" onclick="toggleFilters()">Close</button>
            </div>
        </div>
    </div>

    <div class="col-md-6 col-lg-4">
        <button class="compare-demo-btn" id="quickCompareBtn" onclick="quickStartComparison()">
            Compare rates
        </button>
    </div>
    <br>

    <div class="comparison-section" id="comparisonSection" style="display: none;">
        <div class="comparison-header">
            <h3 class="comparison-title">Vergleichen</h3>
            <button class="clear-comparison-btn" onclick="clearAllComparisons()">
                Alle entfernen
            </button>
        </div>

        <div class="comparison-limit-warning" id="comparisonWarning">
            Sie können maximal 3 Zinssätze gleichzeitig vergleichen. Entfernen Sie einen Vergleich, um einen neuen
            hinzuzufügen.
        </div>

        <div class="comparison-container" id="comparisonContainer">
            <!-- Comparison cards will be populated here -->
        </div>

        <div class="empty-comparison-state" id="emptyComparisonState">
            <div class="icon">📊</div>
            <p>click a provider from the table below to add to compare</p>
        </div>
    </div>

    <!-- View Toggle for Mobile -->
    <div class="view-toggle d-md-none">
        <div aria-label="View toggle" class="btn-group" role="group">
            <button class="btn btn-outline-primary active" id="stackedView" type="button">
                📱 Card View
            </button>
            <button class="btn btn-outline-primary" id="scrollView" type="button">
                📊 Table View
            </button>
        </div>
    </div>

    <!-- Pagination Controls - Top -->
    <div class="pagination-container">
        <div class="pagination-info">
            <div class="results-info" id="resultsInfo">
                Showing 1-5 of 25 results
            </div>
            <div class="page-size-selector">
                <label for="pageSize">Show:</label>
                <select id="pageSize" onchange="changePageSize(this.value)">
                    <option selected value="5">5 per page</option>
                    <option value="10">10 per page</option>
                    <option value="25">25 per page</option>
                    <option value="50">50 per page</option>
                </select>
            </div>
        </div>

        <div class="pagination-controls">
            <div class="quick-nav">
                <button class="page-btn" id="firstPageBtn" onclick="goToPage(1)" title="First page">⏮</button>
                <button class="page-btn" id="prevPageBtn" onclick="goToPage(currentPage - 1)" title="Previous page">‹
                </button>
            </div>

            <div class="quick-nav" id="pageNumbers">
                <!-- Page numbers will be generated here -->
            </div>

            <div class="quick-nav">
                <button class="page-btn" id="nextPageBtn" onclick="goToPage(currentPage + 1)" title="Next page">›
                </button>
                <button class="page-btn" id="lastPageBtn" onclick="goToPage(totalPages)" title="Last page">⏭</button>
            </div>

            <div class="pagination-jump">
                <span>Go to:</span>
                <input class="page-input" id="pageJumpInput" min="1" placeholder="1" type="number">
                <button class="page-btn" onclick="jumpToPage()">Go</button>
            </div>
        </div>
    </div>

    <div class="card border-light mb-3">
        <div class="card-body py-2">
            <small class="text-muted">
                <i class="fas fa-info-circle me-1"></i>
                <span th:text="${lastUpdateMessage}"></span>
            </small>
        </div>
    </div>

    <div class="table-container">
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-spinner"></div>
        </div>

        <div class="scroll-indicator" id="scrollIndicator">← Scroll horizontally to see more →</div>

        <div class="table-responsive" id="tableContainer">
            <table class="table table-sm" id="mainTable">
                <thead class="table">
                <tr id="column-header-row">
                    <th onclick="sortTable(this, event)"
                        th:attr="ondragend=${#authorization.expression('isAuthenticated()')} ? 'handleDragEnd(event)' : null,
                                 ondragover=${#authorization.expression('isAuthenticated()')} ? 'handleDragOver(event)' : null,
                                 ondragstart=${#authorization.expression('isAuthenticated()')} ? 'handleDragStart(event)' : null,
                                 ondrop=${#authorization.expression('isAuthenticated()')} ? 'handleDrop(event)' : null"
                        th:class="${#authorization.expression('isAuthenticated()')} ? 'draggable-column sortable' : 'sortable'"
                        th:data-column-index="${iterStat.index}"
                        th:data-field-id="${field.id}"
                        th:data-field-key="${field.fieldKey}"
                        th:draggable="${#authorization.expression('isAuthenticated()')}"
                        th:each="field, iterStat : ${globalFields}">

                        <div class="header-container">
                            <span class="header-text" th:text="${field.label}"></span>
                        </div>
                    </th>
                    <th class="no-drag">Actions</th>
                </tr>
                </thead>

                <tbody id="tableBody">
                <!-- Data rows will be populated by JavaScript -->
                </tbody>
            </table>

            <!-- Empty state -->
            <div class="empty-state" id="emptyState" style="display: none;">
                <div>📊</div>
                <h5>No interest rates found</h5>
                <p>Try adjusting your search criteria or add a new interest rate.</p>
            </div>
        </div>
    </div>

    <!-- Status notification -->
    <div class="comparison-status" id="comparisonStatus"></div>

    <!-- Pagination Controls - Bottom -->
    <div class="pagination-container">
        <div class="pagination-info">
            <div class="results-info" id="resultsInfoBottom">
                Showing 1-5 of 25 results
            </div>
        </div>

        <div class="pagination-controls">
            <div class="quick-nav">
                <button class="page-btn" onclick="goToPage(1)" title="First page">⏮</button>
                <button class="page-btn" onclick="goToPage(currentPage - 1)" title="Previous page">‹</button>
            </div>

            <div class="quick-nav" id="pageNumbersBottom">
                <!-- Page numbers will be generated here -->
            </div>

            <div class="quick-nav">
                <button class="page-btn" onclick="goToPage(currentPage + 1)" title="Next page">›</button>
                <button class="page-btn" onclick="goToPage(totalPages)" title="Last page">⏭</button>
            </div>
        </div>
    </div>
</div>

<!-- Include jQuery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script th:inline="javascript">
    // ============================================================================
    // GLOBAL VARIABLES AND STATE
    // ============================================================================

    // Add authentication state to JavaScript
    const isAuthenticated = /*[[${#authorization.expression('isAuthenticated()')}]]*/ false;

    // Global pagination variables
    let currentPage = /*[[${currentPage}]]*/ 1;
    let pageSize = /*[[${pageSize}]]*/ 5;
    let totalRecords = /*[[${totalElements}]]*/ 0;
    let totalPages = /*[[${totalPages}]]*/ 0;
    let currentSortColumn = /*[[${sortBy}]]*/ 'id';
    let currentSortDirection = /*[[${sortDir}]]*/ 'asc';
    let currentSearchTerm = /*[[${search}]]*/ '';

    // Server data
    let serverRateFieldValuesMap = /*[[${rateFieldValuesMap}]]*/ {};
    let globalFieldsCache = /*[[${globalFields}]]*/ [];
    let globalFieldsCompareCache = /*[[${globalFieldsCompare}]]*/ [];
    let currentPageData = /*[[${interestRates}]]*/ [];

    // UI state variables
    let isLoading = false;
    let currentExpandedCard = null;
    let currentEditForm = null;
    let draggedElement = null;
    let orderChanged = false;
    let originalOrder = [];
    let pendingDeleteId = null;
    let pendingFieldDeleteId = null;
    let draggedSection = null;
    let currentRateId = null;

    // ============================================================================
    // INITIALIZATION AND DOCUMENT READY
    // ============================================================================

    document.addEventListener('DOMContentLoaded', function () {
        // Initialize pagination with server data
        initializePagination();

        initializeSortableHeaders();
        initializeSearch();

        // Render the initial data from server
        renderInitialData();
        initializeMobileScrolling();
    });

    document.addEventListener('DOMContentLoaded', function () {
        const stackedViewBtn = document.getElementById('stackedView');
        const scrollViewBtn = document.getElementById('scrollView');
        const tableContainer = document.getElementById('tableContainer');

        if (stackedViewBtn && scrollViewBtn && tableContainer) {
            stackedViewBtn.addEventListener('click', function () {
                stackedViewBtn.classList.add('active');
                scrollViewBtn.classList.remove('active');
                tableContainer.classList.add('mobile-stack');
            });

            scrollViewBtn.addEventListener('click', function () {
                scrollViewBtn.classList.add('active');
                stackedViewBtn.classList.remove('active');
                tableContainer.classList.remove('mobile-stack');
            });
        }
    });

    function initializePagination() {
        // Set pagination controls based on server data
        updatePaginationControls();
        updatePaginationInfo();

        // Set initial page size selector
        const pageSizeSelect = document.getElementById('pageSize');
        if (pageSizeSelect) {
            pageSizeSelect.value = pageSize;
        }
    }

    function initializeSortableHeaders() {
        const headers = document.querySelectorAll('.draggable-column, .sortable');
        headers.forEach(header => {
            header.classList.add('sortable');
        });
    }

    function initializeSearch() {
        // Create search input if it doesn't exist
        let searchContainer = document.querySelector('.search-container');
        if (!searchContainer) {
            searchContainer = document.createElement('div');
            searchContainer.className = 'search-container mb-3';
            searchContainer.innerHTML = `
                <div class="row g-2">
                    <div class="col-md-6">
                        <div class="input-group">
                           <input type="text" class="form-control" id="searchInput"
                               placeholder="Search interest rates..."
                               th:value="${currentSearchTerm != null} ? ${currentSearchTerm} : ''" />
                            <button class="btn btn-outline-secondary" type="button" onclick="performSearch()">
                                🔍 Search
                            </button>
                            <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">
                                ✕ Clear
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // Insert after the view toggle or before the pagination
            const viewToggle = document.querySelector('.view-toggle');
            const paginationTop = document.querySelector('.pagination-container');
            if (viewToggle) {
                viewToggle.parentNode.insertBefore(searchContainer, viewToggle.nextSibling);
            } else if (paginationTop) {
                paginationTop.parentNode.insertBefore(searchContainer, paginationTop);
            }
        }

        // Add enter key support
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });
        }
    }

    window.addEventListener("load", () => {
        const emptyState = document.getElementById("emptyState");

        if (emptyState && emptyState.style.display !== "none") {
            const params = new URLSearchParams(window.location.search);
            let page = parseInt(params.get("page") || "1", 10);

            if (page >= 1) {
                params.set("page", page - 1);
                window.location.href = `/?${params.toString()}`;
            }
        }
    });

    // ============================================================================
    // DATA LOADING AND API CALLS
    // ============================================================================

    function renderInitialData() {
        // Render the data that was already loaded from server
        renderTableData(currentPageData);
    }

    // Load page from server - this is the main pagination function
    function loadPageFromServer(page, searchTerm = '', sortBy = null, sortDir = null) {
    if (isLoading) return;

    showLoading();

    const params = new URLSearchParams({
        page: page - 1, // Convert to 0-based for backend
        size: pageSize,
        sortBy: sortBy || currentSortColumn,
        sortDir: sortDir || currentSortDirection
    });

    if (searchTerm && searchTerm.trim()) {
        params.append('search', searchTerm.trim());
    }

    // Use the correct endpoint that matches your controller
    fetch(`/api/interest-rates?${params.toString()}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to fetch data');
            }
            return response.json();
        })
        .then(data => {
            // Update all pagination state
            currentPage = page;
            totalPages = data.totalPages;
            totalRecords = data.totalElements;
            currentSearchTerm = searchTerm || '';

            // Update sort state if provided
            if (sortBy) currentSortColumn = sortBy;
            if (sortDir) currentSortDirection = sortDir;

            // Update data arrays
            currentPageData = data.content;

            // FIXED: Merge new field values with existing ones instead of replacing
            // This preserves field data for rates that are in comparison but not on current page
            Object.assign(serverRateFieldValuesMap, data.rateFieldValuesMap || {});

            // Check which compared rates are no longer available and might need their data fetched
            const currentRateIds = new Set(data.content.map(rate => rate.id));
            const comparedRatesNeedingData = [];

            comparedRates.forEach((rate, rateId) => {
                if (!currentRateIds.has(rateId) && !serverRateFieldValuesMap[rateId]) {
                    // This rate is in comparison but we don't have its field data
                    comparedRatesNeedingData.push(rateId);
                }
            });

            // If we have compared rates that need their data fetched, get them
            if (comparedRatesNeedingData.length > 0) {
                fetchMissingRateData(comparedRatesNeedingData).then(() => {
                    updateComparisonDisplay();
                });
            }

            // Render the new data
            renderTableData(data.content);
            updatePaginationControls();
            updatePaginationInfo();
            hideLoading();

            // Close any expanded cards when changing pages
            if (currentExpandedCard) {
                closeExpandedCard(currentExpandedCard);
            }

            // Update URL without page reload (optional)
            updateBrowserUrl(page, searchTerm, sortBy, sortDir);
        })
        .catch(error => {
            console.error('Error loading page:', error);
            showDeleteNotification('Error loading data: ' + error.message, true);
            hideLoading();
        });
    }

    // Add this new function to fetch missing rate data
    async function fetchMissingRateData(rateIds) {
        try {
            const promises = rateIds.map(rateId =>
                fetch(`/api/interest-rate/${rateId}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Failed to fetch rate ${rateId}`);
                        }
                        return response.json();
                    })
                    .then(rateData => {
                        // Store the rate data and its field values
                        if (rateData && rateData.fieldValues) {
                            serverRateFieldValuesMap[rateId] = rateData.fieldValues;
                        }
                        return rateData;
                    })
                    .catch(error => {
                        console.warn(`Could not fetch data for rate ${rateId}:`, error);
                        return null;
                    })
            );

            await Promise.all(promises);
            console.log('Successfully fetched missing rate data');
        } catch (error) {
            console.error('Error fetching missing rate data:', error);
        }
    }

    // Comparison functionality
    const maxComparisons = 3;
    let comparedRates = new Map();

    function toggleComparison(rateId, isChecked) {
        if (isChecked) {
            addToComparison(rateId);
        } else {
            removeFromComparison(rateId);
        }
    }

    // Update the showStatus message to use your provider names
    function addToComparison(rateId) {
        if (comparedRates.size >= maxComparisons) {
            showStatus('Maximum number of comparisons reached (3)', 'warning');
            const checkbox = document.getElementById(`compare-${rateId}`);
            const mobileCheckbox = document.getElementById(`compare-mobile-${rateId}`);
            if (checkbox) checkbox.checked = false;
            if (mobileCheckbox) mobileCheckbox.checked = false;
            return;
        }

        // Find rate in current page data or all loaded data
        let rate = currentPageData.find(r => r.id === rateId);
        if (!rate && typeof allLoadedData !== 'undefined') {
            rate = allLoadedData.find(r => r.id === rateId);
        }

        if (rate && !comparedRates.has(rateId)) {
            comparedRates.set(rateId, rate);

            // Ensure we have field data for this rate
            if (!serverRateFieldValuesMap[rateId]) {
                fetchMissingRateData([rateId]).then(() => {
                    updateComparisonDisplay();
                });
            } else {
                updateComparisonDisplay();
            }

            updateTableRowHighlight(rateId, true);

            // Get provider name for status message
            const providerName = serverRateFieldValuesMap[rateId]?.[1] || `Rate #${rateId}`;
            showStatus(`${providerName} added to comparison`, 'success');
        }
    }

    function removeFromComparison(rateId) {
        if (comparedRates.has(rateId)) {
            comparedRates.delete(rateId);
            updateComparisonDisplay();
            updateTableRowHighlight(rateId, false);
            showStatus(`Aus dem Vergleich entfernt`, 'info');
            showWarning(false);

            const checkbox = document.getElementById(`compare-${rateId}`);
            if (checkbox) checkbox.checked = false;
        }
    }

    function clearAllComparisons() {
    document.querySelectorAll('.comparison-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });

    comparedRates.forEach((rate, rateId) => {
        updateTableRowHighlight(rateId, false);
    });

    comparedRates.clear();
    updateComparisonDisplay();
    showWarning(false);
    showStatus('All comparisons cleared', 'info');

    // Remove comparison mode class to hide checkboxes
    document.body.classList.remove('comparison-mode');

    // Reset quick compare button
    const quickCompareBtn = document.getElementById('quickCompareBtn');
}

    function updateComparisonDisplay() {
        const section = document.getElementById('comparisonSection');
        const container = document.getElementById('comparisonContainer');
        const emptyState = document.getElementById('emptyComparisonState');

        if (comparedRates.size === 0) {
            section.style.display = 'none';
            return;
        }

        section.style.display = 'block';
        container.innerHTML = '';
        emptyState.style.display = 'none';

        comparedRates.forEach((rate, rateId) => {
            const card = createComparisonCard(rate);
            container.appendChild(card);
        });
    }

    function createComparisonCard(rate) {
        const card = document.createElement('div');
        card.className = 'comparison-card';

        // Get the field values for this rate
        const rateFieldValues = serverRateFieldValuesMap[rate.id] || {};

        // If we don't have field data, show loading state
        if (Object.keys(rateFieldValues).length === 0) {
            card.innerHTML = `
                <div class="comparison-card-header">
                    <div class="provider-info">
                        <span class="provider-name">Loading Rate #${rate.id}...</span>
                    </div>
                    <button class="remove-comparison" onclick="removeFromComparison(${rate.id})" title="Remove">
                        ✕
                    </button>
                </div>
                <div class="comparison-details">
                    <div class="detail-row">
                        <span class="detail-label">Loading...</span>
                        <span class="detail-value">Please wait</span>
                    </div>
                </div>
            `;
            return card;
        }

        // Generate detail rows using your actual globalFieldsCache structure
        const detailRows = globalFieldsCompareCache.map(field => {
            const value = rateFieldValues[field.id] || '-';
            let displayValue = value;

            // Handle image fields
            if (field.fieldKey && field.fieldKey.toLowerCase().includes('img')) {
                if (value && value !== '-') {
                    displayValue = `<img src="${value}" alt="Logo" class="comparison-image">`;
                } else {
                    displayValue = '<span class="text-muted">No Image</span>';
                }
            }

            return `
                <div class="detail-row">
                    <span class="detail-label">${field.label}:</span>
                    <span class="detail-value">${displayValue}</span>
                </div>
            `;
        }).join('');

        // Get a meaningful name for the provider (use first field or fallback)
        const providerName = rateFieldValues[1] || `Interest Rate #${rate.id}`;

        card.innerHTML = `
            <div class="comparison-card-header">
                <div class="provider-info">
                    <span class="provider-name">${providerName}</span>
                </div>
                <button class="remove-comparison" onclick="removeFromComparison(${rate.id})" title="Remove">
                    ✕
                </button>
            </div>

            <div class="comparison-details">
                ${detailRows}
            </div>
        `;
        return card;
    }

    function maintainComparisonState() {
        // Re-check checkboxes and row highlights after data refresh
        comparedRates.forEach((rate, rateId) => {
            const checkbox = document.getElementById(`compare-${rateId}`);
            if (checkbox) {
                checkbox.checked = true;
            }
            updateTableRowHighlight(rateId, true);
        });
    }

    function updateTableRowHighlight(rateId, highlight) {
    const row = document.querySelector(`tr[data-rate-id="${rateId}"]`);
    if (row) {
        if (highlight) {
            row.classList.add('table-row-selected');
            // Add pulse animation for newly selected items
            row.classList.add('just-selected');
            setTimeout(() => {
                row.classList.remove('just-selected');
            }, 600);
        } else {
            row.classList.remove('table-row-selected', 'just-selected');
        }
    }
}

    function showWarning(show) {
        const warning = document.getElementById('comparisonWarning');
        warning.style.display = show ? 'block' : 'none';
    }

    function showStatus(message, type = 'success') {
        const status = document.getElementById('comparisonStatus');
        status.textContent = message;
        status.className = `comparison-status ${type}`;
        status.classList.add('show');

        setTimeout(() => {
            status.classList.remove('show');
        }, 3000);
    }

    function quickStartComparison() {
        const quickCompareBtn = document.getElementById('quickCompareBtn');
        const body = document.body;

        // Add comparison mode class to body to show checkboxes
        body.classList.add('comparison-mode');

        // Disable button temporarily
        quickCompareBtn.disabled = true;

        // Find the first checkbox in the current page data
        const firstCheckbox = document.querySelector('.comparison-checkbox');

        if (firstCheckbox && !firstCheckbox.checked) {
            // Check the first checkbox
            firstCheckbox.checked = true;

            // Get the rate ID from the checkbox
            const rateId = firstCheckbox.id.replace('compare-', '');

            // Add to comparison
            addToComparison(parseInt(rateId));

            // Scroll to comparison section
            setTimeout(() => {
                const comparisonSection = document.getElementById('comparisonSection');
                if (comparisonSection) {
                    comparisonSection.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }

                // Re-enable button with new text
                quickCompareBtn.disabled = false;

                // Show success message
                showStatus('Comparison mode activated! Select more rates to compare.', 'success');
            }, 500);

        } else if (firstCheckbox && firstCheckbox.checked) {
            // If first checkbox is already checked, just scroll to comparison
            const comparisonSection = document.getElementById('comparisonSection');
            if (comparisonSection) {
                comparisonSection.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }

            quickCompareBtn.disabled = false;
            showStatus('Comparison section opened!', 'info');

        } else {
            // No rates available
            quickCompareBtn.disabled = false;
            showStatus('No rates available to compare', 'warning');
        }
    }

        // Optional: Hide the quick compare section when comparison is active
    function updateQuickCompareVisibility() {
        const quickCompareSection = document.getElementById('quickCompareSection');
        const quickCompareBtn = document.getElementById('quickCompareBtn');

        if (comparedRates && comparedRates.size > 0) {
            // Keep section visible but change button text
            if (quickCompareSection) {
                quickCompareSection.style.display = 'block';
            }
            if (quickCompareBtn) {
                quickCompareBtn.disabled = false;
            }
        } else {
            // Show when no comparison is active
            if (quickCompareSection) {
                quickCompareSection.style.display = 'block';
            }
            if (quickCompareBtn) {
                quickCompareBtn.disabled = false;
            }
            // Hide checkboxes when no comparisons
            document.body.classList.remove('comparison-mode');
        }
    }

    // Add this to your existing updateComparisonDisplay function
    // Modify your existing updateComparisonDisplay function to include this call
    const originalUpdateComparisonDisplay = updateComparisonDisplay;
    updateComparisonDisplay = function() {
        originalUpdateComparisonDisplay();
        updateQuickCompareVisibility();
    };

    // Also update when clearing all comparisons
    const originalClearAllComparisons = clearAllComparisons;
    clearAllComparisons = function() {
        originalClearAllComparisons();
        updateQuickCompareVisibility();
    };

    function showMoreInfo(rateId) {
        const rate = currentPageData.find(r => r.id === rateId);
        if (rate && rate.moreInfo) {
            const rateFieldValues = serverRateFieldValuesMap[rateId] || {};
            const details = globalFieldsCache.map(field =>
                `${field.label}: ${rateFieldValues[field.id] || 'N/A'}`
            ).join('\n');

            alert(`More information:\n\n${details}`);
        } else {
            showStatus('Keine zusätzlichen Informationen für diesen Zinssatz verfügbar.', 'info');
        }
    }

    // Integration functions for your existing code
    function integrateWithExistingTable() {
        // This function shows how to integrate with your existing renderTableRows function
        // Replace your existing renderTableRows function content with something like this:

        /*
        function renderTableRows(data, tbody) {
            if (!data || data.length === 0) {
                tbody.innerHTML = '';
                return;
            }

            tbody.innerHTML = data.map(rate => {
                // Get current field order from headers
                const headers = document.querySelectorAll('.draggable-column, .sortable');
                const currentFieldOrder = Array.from(headers)
                    .map(header => ({
                        id: header.dataset.fieldId,
                        fieldKey: header.dataset.fieldKey,
                        label: header.querySelector('.header-text').textContent.trim()
                    }));

                // Add comparison checkbox as first cell
                const comparisonCell = `
                    <td class="data-cell" data-label="Compare">
                        <input type="checkbox"
                               class="comparison-checkbox"
                               onchange="toggleComparison(${rate.id}, this.checked)"
                               id="compare-${rate.id}">
                    </td>
                `;

                // Generate other cells as before
                const fieldCells = currentFieldOrder.map(field => {
                    const fieldValue = serverRateFieldValuesMap[rate.id]?.[field.id] || '';
                    // ... your existing cell generation logic
                });

                return `
                    <tr data-rate-id="${rate.id}">
                        ${comparisonCell}
                        ${fieldCells.join('')}
                        <td data-label="Actions">
                            ${actionButtons}
                        </td>
                    </tr>
                `;
            }).join('');
        }
        */
    }

    function fetchRateDetails(rateId) {
        return fetch(`/api/interest-rate/${rateId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch rate details');
                }
                return response.json();
            })
            .catch(error => {
                console.error('Error fetching rate details:', error);
                showDeleteNotification('Error loading rate details: ' + error.message, true);
                return null;
            });
    }

    // ============================================================================
    // TABLE RENDERING AND DATA DISPLAY
    // ============================================================================

    function renderTableData(data) {
        const tbody = document.getElementById('tableBody');
        const emptyState = document.getElementById('emptyState');

        if (!data || data.length === 0) {
            tbody.innerHTML = '';
            emptyState.style.display = 'block';
            return;
        }

        emptyState.style.display = 'none';
        renderTableRows(data, tbody);

        // Maintain comparison state after re-render
        maintainComparisonState();
    }

    function renderTableRows(data, tbody) {
        if (!data || data.length === 0) {
            tbody.innerHTML = '';
            return;
        }

        tbody.innerHTML = data.map(rate => {
            // Get current field order from headers
            const headers = document.querySelectorAll('.draggable-column, .sortable');
            const currentFieldOrder = Array.from(headers)
                .map(header => ({
                    id: header.dataset.fieldId,
                    fieldKey: header.dataset.fieldKey,
                    label: header.querySelector('.header-text').textContent.trim()
                }));

            // Check if this rate is currently selected for comparison
            const isSelected = comparedRates.has(rate.id);

            // Generate cells in the new column order
            const fieldCells = currentFieldOrder.map((field, index) => {
                const fieldValue = serverRateFieldValuesMap[rate.id]?.[field.id] || '';

                if (field.fieldKey && field.fieldKey.toLowerCase().includes('img')) {
                    return `
                        <td class="data-cell image-cell" data-field-id="${field.id}" data-label="${field.label}">
                            <div class="image-container">
                                ${fieldValue ? `<img src="${fieldValue}" alt="Interest Rate Logo" class="interest-rate-logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />` : ''}
                                <div class="no-image-placeholder" style="${fieldValue ? 'display:none' : 'display:block'}">No Image</div>
                            </div>
                            ${index === 0 ? `
                            <div class="custom-checkbox-container" style="margin-top: 0.5rem;">
                                <input type="checkbox"
                                       class="comparison-checkbox"
                                       onchange="toggleComparison(${rate.id}, this.checked)"
                                       id="compare-${rate.id}"
                                       ${isSelected ? 'checked' : ''}>
                                <div class="custom-checkbox"></div>
                            </div>
                            ` : ''}
                        </td>
                    `;
                } else {
                    return `
                        <td class="data-cell" data-field-id="${field.id}" data-label="${field.label}">
                            <div class="form-control form-control-sm text-center"
                                 style="border: none; background: transparent; cursor: default;">
                                ${fieldValue || '-'}
                            </div>
                            ${index === 0 ? `
                            <div class="custom-checkbox-container" style="margin-top: 0.5rem;">
                                <input type="checkbox"
                                       class="comparison-checkbox"
                                       onchange="toggleComparison(${rate.id}, this.checked)"
                                       id="compare-${rate.id}"
                                       ${isSelected ? 'checked' : ''}>
                                <div class="custom-checkbox"></div>
                            </div>
                            ` : ''}
                        </td>
                    `;
                }
            }).join('');

            // Action buttons without checkbox now
            let actionButtons = `
                <div class="action-buttons">
                    <button class="mehr-info-btn"
                            ${rate.moreInfo ? '' : 'disabled'}
                            onclick="showMoreInfo(${rate.id})"
                            title="${rate.moreInfo ? 'Show more info' : 'No additional info available'}">
                        ${rate.moreInfo ? 'MEHR INFO' : 'No Info'}
                    </button>
                    <a class="angebot-btn"
                       href="${rate.webLink || '#'}"
                       target="_blank"
                       title="Open Link">
                        ZUM ANGEBOT
                    </a>
                </div>
            `;

            return `
                <tr data-rate-id="${rate.id}" ${isSelected ? 'class="table-row-selected"' : ''}>
                    ${fieldCells}
                    <td data-label="Actions">
                        ${actionButtons}
                    </td>
                </tr>
            `;
        }).join('');
    }

    function updateBrowserUrl(page, search, sortBy, sortDir) {
        const url = new URL(window.location);
        url.searchParams.set('page', page - 1); // 0-based for URL consistency
        if (search) {
            url.searchParams.set('search', search);
        } else {
            url.searchParams.delete('search');
        }
        url.searchParams.set('sortBy', sortBy || currentSortColumn);
        url.searchParams.set('sortDir', sortDir || currentSortDirection);
        url.searchParams.set('size', pageSize);

        window.history.replaceState({}, '', url);
    }

    // ============================================================================
    // PAGINATION FUNCTIONALITY
    // ============================================================================

    function updatePaginationControls() {
        const firstPageBtn = document.getElementById('firstPageBtn');
        const prevPageBtn = document.getElementById('prevPageBtn');
        const nextPageBtn = document.getElementById('nextPageBtn');
        const lastPageBtn = document.getElementById('lastPageBtn');

        if (firstPageBtn) firstPageBtn.disabled = currentPage === 1;
        if (prevPageBtn) prevPageBtn.disabled = currentPage === 1;
        if (nextPageBtn) nextPageBtn.disabled = currentPage >= totalPages;
        if (lastPageBtn) lastPageBtn.disabled = currentPage >= totalPages;

        updatePageNumbers();

        const pageJumpInput = document.getElementById('pageJumpInput');
        if (pageJumpInput) {
            pageJumpInput.max = totalPages;
            pageJumpInput.placeholder = currentPage;
        }
    }

    function updatePageNumbers() {
        const pageNumbers = document.getElementById('pageNumbers');
        const pageNumbersBottom = document.getElementById('pageNumbersBottom');

        if (!pageNumbers) return;

        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, startPage + 4);

        if (endPage - startPage < 4) {
            startPage = Math.max(1, endPage - 4);
        }

        let html = '';
        for (let i = startPage; i <= endPage; i++) {
            html += `
                <button class="page-btn ${i === currentPage ? 'active' : ''}"
                        onclick="goToPage(${i})">${i}</button>
            `;
        }

        pageNumbers.innerHTML = html;
        if (pageNumbersBottom) {
            pageNumbersBottom.innerHTML = html;
        }
    }

    function updatePaginationInfo() {
        const startRecord = totalRecords === 0 ? 0 : (currentPage - 1) * pageSize + 1;
        const endRecord = Math.min(currentPage * pageSize, totalRecords);

        const infoText = `Showing ${startRecord}-${endRecord} of ${totalRecords} results`;

        const resultsInfo = document.getElementById('resultsInfo');
        const resultsInfoBottom = document.getElementById('resultsInfoBottom');

        if (resultsInfo) resultsInfo.textContent = infoText;
        if (resultsInfoBottom) resultsInfoBottom.textContent = infoText;
    }

    // Main navigation function - always loads from server
    function goToPage(page) {
        if (page < 1 || page > totalPages || page === currentPage || isLoading) return;
        loadPageFromServer(page, currentSearchTerm);
    }

    function jumpToPage() {
        const input = document.getElementById('pageJumpInput');
        const page = parseInt(input.value);

        if (page && page >= 1 && page <= totalPages) {
            goToPage(page);
            input.value = '';
        }
    }

    function changePageSize(newSize) {
        pageSize = parseInt(newSize);
        currentPage = 1;
        loadPageFromServer(1, currentSearchTerm);
    }

    // ============================================================================
    // SEARCH FUNCTIONALITY
    // ============================================================================

    function performSearch() {
        const searchInput = document.getElementById('searchInput');
        const searchTerm = searchInput ? searchInput.value.trim() : '';

        if (isInfiniteScrollEnabled) {
            // Reset infinite scroll state
            loadedPages.clear();
            allLoadedData = [];
            hasMoreData = true;
            currentPage = 1;

            // Hide indicators
            hideInfiniteScrollIndicator();
            hideLoadingMoreIndicator();
            const endIndicator = document.getElementById('endOfDataIndicator');
            if (endIndicator) endIndicator.style.display = 'none';

            // Load first page with search and current filters
            loadPageFromServerWithInfiniteScroll(1, searchTerm, currentSortColumn, currentSortDirection);
        } else {
            // Use normal search with filters
            currentPage = 1;
            loadPageFromServerWithFilters(1, searchTerm, currentSortColumn, currentSortDirection, activeFilters);
        }
    }

    function clearSearch() {
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.value = '';
        }

        if (isInfiniteScrollEnabled) {
            // Reset infinite scroll state
            loadedPages.clear();
            allLoadedData = [];
            hasMoreData = true;
            currentPage = 1;

            // Hide indicators
            hideInfiniteScrollIndicator();
            hideLoadingMoreIndicator();
            const endIndicator = document.getElementById('endOfDataIndicator');
            if (endIndicator) endIndicator.style.display = 'none';

            // Load first page without search but with current filters
            loadPageFromServerWithInfiniteScroll(1, '', currentSortColumn, currentSortDirection);
        } else {
            // Use normal clear with filters
            currentPage = 1;
            loadPageFromServerWithFilters(1, '', currentSortColumn, currentSortDirection, activeFilters);
        }
    }

    // ============================================================================
    // SORTING FUNCTIONALITY
    // ============================================================================

    function sortTable(headerElement, event) {
        if (event && event.type === 'click' && headerElement.classList.contains('dragging')) {
            return;
        }

        const fieldId = headerElement.dataset.fieldId;
        const sortBy = `field_${fieldId}`;

        let sortDirection = 'asc';
        if (currentSortColumn === sortBy) {
            sortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
        }

        // Update UI indicators
        document.querySelectorAll('.sortable')
            .forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });
        headerElement.classList.add(sortDirection === 'asc' ? 'sort-asc' : 'sort-desc');

        // Load data with new sort
        currentPage = 1;
        loadPageFromServer(1, currentSearchTerm, sortBy, sortDirection);
    }

    // ============================================================================
    // LOADING STATES AND UI FEEDBACK
    // ============================================================================

    function showLoading() {
        isLoading = true;
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) overlay.classList.add('show');
    }

    function hideLoading() {
        isLoading = false;
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) overlay.classList.remove('show');
    }

    function showDeleteNotification(message, isError) {
        const notification = document.getElementById('deleteNotification');
        if (notification) {
            notification.textContent = message;
            notification.classList.toggle('error', isError);
            notification.classList.toggle('success', !isError);
            notification.classList.add('show');

            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
    }

    // ============================================================================
    // MORE INFO AND EXPANDED CARDS
    // ============================================================================

    function showMoreInfo(rateId) {
        let rate = currentPageData.find(r => r.id === rateId);

        // If not found in current page data, try to find in all loaded data (for infinite scroll)
        if (!rate && typeof allLoadedData !== 'undefined' && allLoadedData.length > 0) {
            rate = allLoadedData.find(r => r.id === rateId);
        }

        if (!rate) {
            fetchRateDetails(rateId)
                .then(rateData => {
                    if (rateData && rateData.moreInfo) {
                        displayRateCard(rateData);
                    }
                });
            return;
        }

        if (!rate.moreInfo) {
            showDeleteNotification('No additional information available for this rate.', false);
            return;
        }

        displayRateCard(rate);
    }


    function displayRateCard(rate) {
        if (currentExpandedCard && currentExpandedCard !== rate.id) {
            closeExpandedCard(currentExpandedCard);
        }

        let existingCard = document.getElementById(`rateCardRow_${rate.id}`);
        if (existingCard) {
            existingCard.style.display = 'none';
            setTimeout(() => {
                if (existingCard.parentNode) {
                    existingCard.parentNode.removeChild(existingCard);
                }
            }, 0);

            if (currentExpandedCard === rate.id) {
                currentExpandedCard = null;
                return;
            }
        }

        // FIXED: Better debugging and target identification
        console.log('Looking for rate ID:', rate.id);

        // Check if we're in mobile card view
        const tableContainer = document.getElementById('tableContainer');
        const isMobileCardView = tableContainer && tableContainer.classList.contains('mobile-stack');

        console.log('Mobile card view active:', isMobileCardView);

        let targetRow = null;

        if (isMobileCardView) {
            // In mobile card view, look for the TR with class mobile-card-row
            targetRow = document.querySelector(`div.mobile-card-row[data-rate-id="${rate.id}"]`);
            console.log('Found mobile card row:', targetRow);
        } else {
            // In table view, look for regular table row
            targetRow = document.querySelector(`tr[data-rate-id="${rate.id}"]`);
            console.log('Found table row:', targetRow);
        }

        if (!targetRow) {
            console.error('Target row not found for rate ID:', rate.id);
            // Try alternative selectors as fallback
            targetRow = document.querySelector(`[data-rate-id="${rate.id}"]`);
            console.log('Fallback found:', targetRow);

            if (!targetRow) {
                console.error('No element found with rate ID:', rate.id);
                return;
            }

            // If we found a non-TR element, find its closest TR parent
            if (targetRow.tagName !== 'TR') {
                targetRow = targetRow.closest('tr');
                console.log('Closest TR:', targetRow);
            }
        }

        if (!targetRow) {
            console.error('Still no target row found');
            return;
        }

        console.log('Target row details:', {
            tagName: targetRow.tagName,
            className: targetRow.className,
            dataRateId: targetRow.dataset.rateId,
            nextSibling: targetRow.nextSibling,
            nextElementSibling: targetRow.nextElementSibling
        });

        const card = createRateCard(rate);
        const cardRow = document.createElement('tr');
        cardRow.id = `rateCardRow_${rate.id}`;
        cardRow.className = 'rate-card-row show';
        cardRow.innerHTML = `<td colspan="100%" class="rate-card-cell"></td>`;

        cardRow.querySelector('.rate-card-cell')
            .appendChild(card);

        // FIXED: Use insertAdjacentElement for more predictable positioning
        try {
            targetRow.insertAdjacentElement('afterend', cardRow);
            console.log('Successfully inserted card row after target');
        } catch (error) {
            console.error('Error inserting card row:', error);
            // Fallback to original method
            if (targetRow.parentNode) {
                targetRow.parentNode.insertBefore(cardRow, targetRow.nextSibling);
                console.log('Used fallback insertion method');
            } else {
                console.error('Target row has no parent node');
                return;
            }
        }

        setTimeout(() => {
            card.scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });
        }, 50);

        currentExpandedCard = rate.id;
    }


    function createRateCard(rate) {
        const card = document.createElement('div');
        card.className = 'rate-card';
        card.id = `rateCard_${rate.id}`;

        const moreInfo = rate.moreInfo;
        if (!moreInfo) return card;

        const sectionOrder = moreInfo.sectionOrder || [];
        const tableSectionsMap = new Map();
        const textSectionsMap = new Map();

        if (moreInfo.tableSections) {
            moreInfo.tableSections.forEach(tableSection => {
                tableSectionsMap.set(tableSection.sectionIdentifier, tableSection);
            });
        }

        if (moreInfo.textSections) {
            moreInfo.textSections.forEach(textSection => {
                textSectionsMap.set(textSection.sectionIdentifier, textSection);
            });
        }

        const createTableSection = (tableSection) => {
            if (!tableSection || !tableSection.title || !tableSection.miniTableRows || tableSection.miniTableRows.length === 0) {
                return '';
            }

            let dragAttributes = '';
            let dragHandle = '';
            let sectionControls = '';

            return `
                <div class="expanded-section ${isAuthenticated ? 'draggable-section' : ''} table-section"
                     data-section-type="table"
                     data-section-id="${tableSection.sectionIdentifier}"
                     ${dragAttributes}>
                    ${dragHandle}
                    ${sectionControls}
                    <h5 class="section-title">${tableSection.title}</h5>
                    <div class="info-table">
                        ${tableSection.miniTableRows.map(row => `
                            <div class="info-table-row">
                                <div class="info-table-label">${row.label || ''}</div>
                                <div class="info-table-value">${row.description || ''}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        };

        const createTextSection = (textSection) => {
            if (!textSection || (!textSection.title && !textSection.content)) {
                return '';
            }

            let dragAttributes = '';
            let dragHandle = '';
            let sectionControls = '';

            return `
                <div class="expanded-section ${isAuthenticated ? 'draggable-section' : ''} text-section"
                     data-section-type="text"
                     data-section-id="${textSection.sectionIdentifier}"
                     ${dragAttributes}>
                    ${dragHandle}
                    ${sectionControls}
                    ${textSection.title ? `<h5 class="section-title">${textSection.title}</h5>` : ''}
                    <div class="text-content" style="text-align: left;">${textSection.content || ''}</div>
                </div>
            `;
        };

        let sectionsHTML = '';
        sectionOrder.forEach(sectionIdentifier => {
            if (sectionIdentifier.startsWith('table-')) {
                const tableSection = tableSectionsMap.get(sectionIdentifier);
                if (tableSection) {
                    sectionsHTML += createTableSection(tableSection);
                }
            } else if (sectionIdentifier.startsWith('text-')) {
                const textSection = textSectionsMap.get(sectionIdentifier);
                if (textSection) {
                    sectionsHTML += createTextSection(textSection);
                }
            }
        });

        // Add any sections not in order
        tableSectionsMap.forEach((tableSection, identifier) => {
            if (!sectionOrder.includes(identifier)) {
                sectionsHTML += createTableSection(tableSection);
            }
        });

        textSectionsMap.forEach((textSection, identifier) => {
            if (!sectionOrder.includes(identifier)) {
                sectionsHTML += createTextSection(textSection);
            }
        });

        card.innerHTML = `
            <div class="rate-expanded-content show">
                ${sectionsHTML}
            </div>
        `;

        return card;
    }

    function closeExpandedCard(rateId) {
        const cardRow = document.getElementById(`rateCardRow_${rateId}`);
        if (cardRow) {
            cardRow.style.display = 'none';
            cardRow.classList.remove('show');

            requestAnimationFrame(() => {
                if (cardRow.parentNode) {
                    cardRow.parentNode.removeChild(cardRow);
                }
            });

            if (currentExpandedCard === rateId) {
                currentExpandedCard = null;
            }
        }
    }

    // ============================================================================
    // UTILITY FUNCTIONS
    // ============================================================================

    function getCsrfToken() {
        const tokenMeta = document.querySelector('meta[name="_csrf"]');
        return tokenMeta ? tokenMeta.getAttribute('content') : '';
    }

    // ============================================================================
    // EVENT LISTENERS AND KEYBOARD NAVIGATION
    // ============================================================================

    // Close edit forms when clicking outside
    document.addEventListener('click', function (e) {
        if (currentEditForm && !currentEditForm.contains(e.target) && !e.target.classList.contains('edit-header-btn')) {
            currentEditForm.classList.remove('show');
            currentEditForm = null;
        }
    });

    // Enhanced keyboard navigation for pagination
    document.addEventListener('keydown', function (e) {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

        switch (e.key) {
        case 'ArrowLeft':
            if (currentPage > 1) {
                e.preventDefault();
                goToPage(currentPage - 1);
            }
            break;
        case 'ArrowRight':
            if (currentPage < totalPages) {
                e.preventDefault();
                goToPage(currentPage + 1);
            }
            break;
        case 'Home':
            e.preventDefault();
            goToPage(1);
            break;
        case 'End':
            e.preventDefault();
            goToPage(totalPages);
            break;
        }
    });

    // Handle Enter key in page jump input
    document.addEventListener('DOMContentLoaded', function () {
        const pageJumpInput = document.getElementById('pageJumpInput');
        if (pageJumpInput) {
            pageJumpInput.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    jumpToPage();
                }
            });
        }
    });

    // ============================================================================
    // FILTERS
    // ============================================================================

    // Filter Management JavaScript
    let availableFilters = [];
    let activeFilters = new Map(); // fieldId -> Set of selected values
    let filterExpanded = false;

    // Initialize filters when page loads
    document.addEventListener('DOMContentLoaded', function () {
        initializeFilters();
    });

    async function initializeFilters() {
        try {
            // Load available filters from server
            const response = await fetch('/filters/available');
            if (response.ok) {
                availableFilters = await response.json();
                renderFilterGrid();

                // Initialize with any existing filters from URL
                initializeFromUrlParams();
                updateFilterSummary();
            }
        } catch (error) {
            console.error('Error loading filters:', error);
        }
    }

    function initializeFromUrlParams() {
        const urlParams = new URLSearchParams(window.location.search);

        for (const [key, value] of urlParams.entries()) {
            if (key.startsWith('filter_')) {
                const fieldId = key.substring(7);
                // FIXED: Decode the URL-encoded value and split by pipe
                const decodedValue = decodeURIComponent(value);
                const values = decodedValue.includes('|') ? decodedValue.split('|') : [decodedValue];
                activeFilters.set(fieldId, new Set(values));
            }
        }

        if (activeFilters.size > 0) {
            updateActiveFiltersDisplay();
            updateFilterCheckboxes();
        }
    }

    function toggleFilters() {
        const content = document.getElementById('filterContent');
        const toggle = document.getElementById('filterToggle');

        filterExpanded = !filterExpanded;

        if (filterExpanded) {
            content.classList.add('show');
            toggle.classList.add('expanded');
        } else {
            content.classList.remove('show');
            toggle.classList.remove('expanded');
        }
    }

    function renderFilterGrid() {
        const grid = document.getElementById('filterGrid');

        grid.innerHTML = availableFilters.map(filter => `
            <div class="filter-item" data-field-id="${filter.fieldId}">
                <h6>
                    ${filter.label}
                    <span class="text-muted">(${filter.options.length})</span>
                </h6>
                <div class="filter-options" id="options_${filter.fieldId}">
                    ${filter.options.map(option => `
                        <div class="filter-option" onclick="toggleFilterOption(${filter.fieldId}, '${option.value}')">
                            <input type="checkbox"
                                   id="filter_${filter.fieldId}_${option.value.replace(/[^a-zA-Z0-9]/g, '_')}"
                                   value="${option.value}">
                            <label for="filter_${filter.fieldId}_${option.value.replace(/[^a-zA-Z0-9]/g, '_')}">
                                ${option.label}
                            </label>
                        </div>
                    `).join('')}
                </div>
            </div>
        `)
            .join('');
    }

    function toggleFilterOption(fieldId, value) {
        const fieldIdStr = fieldId.toString();

        if (!activeFilters.has(fieldIdStr)) {
            activeFilters.set(fieldIdStr, new Set());
        }

        const fieldFilters = activeFilters.get(fieldIdStr);

        if (fieldFilters.has(value)) {
            fieldFilters.delete(value);
            if (fieldFilters.size === 0) {
                activeFilters.delete(fieldIdStr);
            }
        } else {
            fieldFilters.add(value);
        }

        updateFilterCheckboxes();
        updateActiveFiltersDisplay();
        updateFilterSummary();
    }

    function updateFilterCheckboxes() {
        availableFilters.forEach(filter => {
            const fieldIdStr = filter.fieldId.toString();
            const selectedValues = activeFilters.get(fieldIdStr) || new Set();

            filter.options.forEach(option => {
                const checkboxId = `filter_${filter.fieldId}_${option.value.replace(/[^a-zA-Z0-9]/g, '_')}`;
                const checkbox = document.getElementById(checkboxId);
                if (checkbox) {
                    checkbox.checked = selectedValues.has(option.value);
                }
            });
        });
    }

    function updateActiveFiltersDisplay() {
        const container = document.getElementById('activeFilters');
        const tags = [];

        activeFilters.forEach((values, fieldId) => {
            const filter = availableFilters.find(f => f.fieldId.toString() === fieldId);
            if (filter) {
                values.forEach(value => {
                    tags.push(`
                        <span class="filter-tag">
                            ${filter.label}: ${value}
                            <button class="remove-filter" onclick="removeFilterTag('${fieldId}', '${value}')" title="Remove filter">
                                ✕
                            </button>
                        </span>
                    `);
                });
            }
        });

        container.innerHTML = tags.join('');
        container.style.display = tags.length > 0 ? 'flex' : 'none';
    }

    function updateFilterSummary() {
        const summary = document.getElementById('filterSummary');
        const totalActive = Array.from(activeFilters.values())
            .reduce((sum, set) => sum + set.size, 0);

        if (totalActive === 0) {
            summary.textContent = 'Click to add filters';
            summary.style.color = '#666';
        } else {
            summary.textContent = `${totalActive} filter${totalActive > 1 ? 's' : ''} active`;
            summary.style.color = '#007bff';
            summary.style.fontWeight = '600';
        }
    }

    function removeFilterTag(fieldId, value) {
        if (activeFilters.has(fieldId)) {
            activeFilters.get(fieldId)
                .delete(value);
            if (activeFilters.get(fieldId)
                .size === 0) {
                activeFilters.delete(fieldId);
            }
        }

        updateFilterCheckboxes();
        updateActiveFiltersDisplay();
        updateFilterSummary();

        // FIXED: Auto-apply filters when removing tags, with proper infinite scroll handling
        applyFilters();
    }

    function clearAllFilters() {
        activeFilters.clear();
        updateFilterCheckboxes();
        updateActiveFiltersDisplay();
        updateFilterSummary();

        // FIXED: Apply cleared filters with proper infinite scroll handling
        applyFilters();
    }


    function applyFilters() {
        // Build filter parameters for the API call
        const params = new URLSearchParams();

        // Add existing parameters
        params.set('page', '0'); // Reset to first page when applying filters
        params.set('size', pageSize.toString());
        params.set('sortBy', currentSortColumn);
        params.set('sortDir', currentSortDirection);

        if (currentSearchTerm) {
            params.set('search', currentSearchTerm);
        }

        // FIXED: Add filter parameters using pipe separator instead of comma
        activeFilters.forEach((values, fieldId) => {
            if (values.size > 0) {
                // Use pipe (|) as separator and URL encode the entire value
                const filterValue = Array.from(values).join('|');
                params.set(`filter_${fieldId}`, encodeURIComponent(filterValue));
            }
        });

        // Check if we're in infinite scroll mode and handle accordingly
        if (isInfiniteScrollEnabled) {
            // Reset infinite scroll state for filters
            loadedPages.clear();
            allLoadedData = [];
            hasMoreData = true;
            currentPage = 1;

            // Hide indicators while loading
            hideInfiniteScrollIndicator();
            hideLoadingMoreIndicator();
            const endIndicator = document.getElementById('endOfDataIndicator');
            if (endIndicator) endIndicator.style.display = 'none';

            // Load first page with filters in infinite scroll mode
            loadPageFromServerWithInfiniteScroll(1, currentSearchTerm, currentSortColumn, currentSortDirection);
        } else {
            // Normal pagination mode
            currentPage = 1;
            loadPageFromServerWithFilters(1, currentSearchTerm, currentSortColumn, currentSortDirection, activeFilters);
        }

        // Update URL
        updateBrowserUrlWithFilters();

        // Close filters panel on mobile after applying
        if (window.innerWidth <= 768) {
            toggleFilters();
        }
    }

    function loadPageFromServerWithFilters(page, searchTerm = '', sortBy = null, sortDir = null, filters = new Map()) {
        if (isLoading) return;

        showLoading();

        const params = new URLSearchParams({
            page: page - 1, // Convert to 0-based for backend
            size: pageSize,
            sortBy: sortBy || currentSortColumn,
            sortDir: sortDir || currentSortDirection
        });

        if (searchTerm && searchTerm.trim()) {
            params.append('search', searchTerm.trim());
        }

        // Add filter parameters using pipe separator
        filters.forEach((values, fieldId) => {
            if (values.size > 0) {
                const filterValue = Array.from(values).join('|');
                params.set(`filter_${fieldId}`, encodeURIComponent(filterValue));
            }
        });

        fetch(`/api/interest-rates?${params.toString()}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch data');
                }
                return response.json();
            })
            .then(data => {
                // Update all pagination state
                currentPage = page;
                totalPages = data.totalPages;
                totalRecords = data.totalElements;
                currentSearchTerm = searchTerm || '';

                // Update sort state if provided
                if (sortBy) currentSortColumn = sortBy;
                if (sortDir) currentSortDirection = sortDir;

                // Update data arrays
                currentPageData = data.content;

                // FIXED: Merge field values instead of replacing
                Object.assign(serverRateFieldValuesMap, data.rateFieldValuesMap || {});

                // Check for compared rates needing data
                const currentRateIds = new Set(data.content.map(rate => rate.id));
                const comparedRatesNeedingData = [];

                comparedRates.forEach((rate, rateId) => {
                    if (!currentRateIds.has(rateId) && !serverRateFieldValuesMap[rateId]) {
                        comparedRatesNeedingData.push(rateId);
                    }
                });

                if (comparedRatesNeedingData.length > 0) {
                    fetchMissingRateData(comparedRatesNeedingData).then(() => {
                        updateComparisonDisplay();
                    });
                }

                // Render the new data
                renderTableData(data.content);
                updatePaginationControls();
                updatePaginationInfo();
                hideLoading();

                // Close any expanded cards when changing pages
                if (currentExpandedCard) {
                    closeExpandedCard(currentExpandedCard);
                }

                // Update URL without page reload
                updateBrowserUrlWithFilters();
            })
            .catch(error => {
                console.error('Error loading page:', error);
                showDeleteNotification('Error loading data: ' + error.message, true);
                hideLoading();
            });
    }

    function updateBrowserUrlWithFilters() {
        const url = new URL(window.location);

        // Clear existing filter parameters
        for (const [key] of url.searchParams.entries()) {
            if (key.startsWith('filter_')) {
                url.searchParams.delete(key);
            }
        }

        // FIXED: Add current filter parameters using pipe separator
        activeFilters.forEach((values, fieldId) => {
            if (values.size > 0) {
                const filterValue = Array.from(values).join('|');
                url.searchParams.set(`filter_${fieldId}`, encodeURIComponent(filterValue));
            }
        });

        // Update other parameters
        url.searchParams.set('page', currentPage - 1);
        if (currentSearchTerm) {
            url.searchParams.set('search', currentSearchTerm);
        } else {
            url.searchParams.delete('search');
        }
        url.searchParams.set('sortBy', currentSortColumn);
        url.searchParams.set('sortDir', currentSortDirection);
        url.searchParams.set('size', pageSize);

        window.history.replaceState({}, '', url);
    }

    // Override the existing loadPageFromServer function to support filters
    const originalLoadPageFromServer = window.loadPageFromServer;
    window.d = function (page, searchTerm = '', sortBy = null, sortDir = null) {
        loadPageFromServerWithFilters(page, searchTerm, sortBy, sortDir, activeFilters);
    };


    // Add filter refresh capability
    function refreshFiltersFromServer() {
        initializeFilters();
    }

    // Export functions for use in main application
    window.filterFunctions = {
        toggleFilters,
        applyFilters,
        clearAllFilters,
        refreshFiltersFromServer,
        loadPageFromServerWithFilters
    };

    // ============================================================================
    // MOBILE INFINITE SCROLL FUNCTIONALITY
    // ============================================================================

    // Mobile-specific variables
    let isMobileView = false;
    let isInfiniteScrollEnabled = false;
    let loadedPages = new Set();
    let allLoadedData = [];
    let isLoadingMore = false;
    let hasMoreData = true;
    let scrollThreshold = 200; // pixels from bottom to trigger load
    // FIXED: Enhanced mobile scroll initialization
    function initializeMobileScrolling() {
        // Detect mobile view changes
        checkMobileView();
        window.addEventListener('resize', debounce(checkMobileView, 250));

        // Initialize scroll listener
        window.addEventListener('scroll', debounce(handleScroll, 100));

        // FIXED: Better monitor view toggle buttons with enhanced event handling
        const stackedViewBtn = document.getElementById('stackedView');
        const scrollViewBtn = document.getElementById('scrollView');

        if (stackedViewBtn && scrollViewBtn) {
            // Remove any existing listeners
            stackedViewBtn.replaceWith(stackedViewBtn.cloneNode(true));
            scrollViewBtn.replaceWith(scrollViewBtn.cloneNode(true));

            // Get the new elements and add fresh listeners
            const newStackedBtn = document.getElementById('stackedView');
            const newScrollBtn = document.getElementById('scrollView');

            newStackedBtn.addEventListener('click', function () {
                enableMobileCardView();
            });

            newScrollBtn.addEventListener('click', function () {
                disableMobileCardView();
            });
        }
    }


    function checkMobileView() {
        const wasMobile = isMobileView;
        isMobileView = window.innerWidth <= 768;

        // Check if we're in card view mode
        const tableContainer = document.getElementById('tableContainer');
        const isCardView = tableContainer && tableContainer.classList.contains('mobile-stack');

        // Get current button states
        const stackedViewBtn = document.getElementById('stackedView');
        const scrollViewBtn = document.getElementById('scrollView');

        // NEW: Auto-enable card view when switching to mobile
        if (!wasMobile && isMobileView) {
            // Switching from desktop to mobile - enable card view by default
            if (stackedViewBtn && scrollViewBtn && tableContainer) {
                stackedViewBtn.classList.add('active');
                scrollViewBtn.classList.remove('active');
                tableContainer.classList.add('mobile-stack');
                enableInfiniteScroll();
                return; // Early return to avoid further logic
            }
        }

        const stackedActive = stackedViewBtn && stackedViewBtn.classList.contains('active');

        // Enable infinite scroll only on mobile in card view AND when stacked view is active
        const shouldEnable = isMobileView && isCardView && stackedActive;

        if (shouldEnable !== isInfiniteScrollEnabled) {
            if (shouldEnable) {
                enableInfiniteScroll();
            } else {
                disableInfiniteScroll();
            }
        }

        // If switching from mobile to desktop, ensure proper table view
        if (wasMobile && !isMobileView) {
            // Force disable infinite scroll
            if (isInfiniteScrollEnabled) {
                disableInfiniteScroll();
            }

            // Ensure table view is properly set
            if (tableContainer && tableContainer.classList.contains('mobile-stack')) {
                if (scrollViewBtn && stackedViewBtn) {
                    scrollViewBtn.classList.add('active');
                    stackedViewBtn.classList.remove('active');
                    tableContainer.classList.remove('mobile-stack');
                    renderTableData(currentPageData);
                }
            }
        }
    }

    function enableMobileCardView() {
        const stackedViewBtn = document.getElementById('stackedView');
        const scrollViewBtn = document.getElementById('scrollView');
        const tableContainer = document.getElementById('tableContainer');

        if (stackedViewBtn && scrollViewBtn && tableContainer) {
            stackedViewBtn.classList.add('active');
            scrollViewBtn.classList.remove('active');
            tableContainer.classList.add('mobile-stack');

            // Enable infinite scroll if on mobile
            if (isMobileView) {
                enableInfiniteScroll();
            }
        }
    }

    function disableMobileCardView() {
        const stackedViewBtn = document.getElementById('stackedView');
        const scrollViewBtn = document.getElementById('scrollView');
        const tableContainer = document.getElementById('tableContainer');

        if (stackedViewBtn && scrollViewBtn && tableContainer) {
            scrollViewBtn.classList.add('active');
            stackedViewBtn.classList.remove('active');
            tableContainer.classList.remove('mobile-stack');

            // FIXED: Disable infinite scroll and revert to normal table
            if (isInfiniteScrollEnabled) {
                disableInfiniteScroll();
            }

            // FIXED: Force re-render as normal table
            setTimeout(() => {
                renderTableData(currentPageData);
            }, 100);
        }
    }

    function enableInfiniteScroll() {
        if (isInfiniteScrollEnabled) return;

        isInfiniteScrollEnabled = true;

        // Hide pagination controls
        hidePaginationControls();

        // Initialize with current data
        loadedPages.clear();
        loadedPages.add(currentPage);
        allLoadedData = [...currentPageData];
        hasMoreData = currentPage < totalPages;

        // Render all loaded data as cards
        renderMobileCards(allLoadedData);

        // Show loading indicator at bottom
        showInfiniteScrollIndicator();

        console.log('Infinite scroll enabled');
    }

    function disableInfiniteScroll() {
        if (!isInfiniteScrollEnabled) return;

        isInfiniteScrollEnabled = false;
        isLoadingMore = false;

        // Show pagination controls
        showPaginationControls();

        // Hide infinite scroll indicators
        hideInfiniteScrollIndicator();
        hideLoadingMoreIndicator();
        const endIndicator = document.getElementById('endOfDataIndicator');
        if (endIndicator) endIndicator.style.display = 'none';

        // FIXED: Reset to normal table view with proper data
        resetToNormalPagination();

        console.log('Infinite scroll disabled');
    }


    function resetToNormalPagination() {
        // Reset data arrays
        loadedPages.clear();
        allLoadedData = [];
        hasMoreData = true;

        // FIXED: Use current page data if available, otherwise reload
        if (currentPageData && currentPageData.length > 0) {
            renderTableData(currentPageData);
            updatePaginationControls();
            updatePaginationInfo();
        } else {
            // Reload current page normally
            loadPageFromServer(currentPage, currentSearchTerm, currentSortColumn, currentSortDirection);
        }
    }

    // ============================================================================
    // SCROLL HANDLING
    // ============================================================================

    function handleScroll() {
        if (!isInfiniteScrollEnabled || isLoadingMore || !hasMoreData) return;

        // Check if we're near the bottom of the page
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const windowHeight = window.innerHeight;
        const documentHeight = document.documentElement.scrollHeight;

        const distanceFromBottom = documentHeight - (scrollTop + windowHeight);

        if (distanceFromBottom <= scrollThreshold) {
            loadMoreData();
        }
    }

    async function loadMoreData() {
        if (isLoadingMore || !hasMoreData) return;

       const nextPage = loadedPages.size + 1;

        if (nextPage > totalPages) {
            hasMoreData = false;
            hideInfiniteScrollIndicator();
            showEndOfDataIndicator();
            return;
        }

        isLoadingMore = true;
        showLoadingMoreIndicator();

        console.log('Loading more data, page:', nextPage); // Debug log

        try {
            // FIXED: Pass current sort and search parameters, fetchPageData will handle filters
            const data = await fetchPageData(nextPage, currentSearchTerm, currentSortColumn, currentSortDirection);

            if (data && data.content && data.content.length > 0) {
                // Add new data to our collection
                allLoadedData = [...allLoadedData, ...data.content];
                loadedPages.add(nextPage);

                // Update server data map
                Object.assign(serverRateFieldValuesMap, data.rateFieldValuesMap || {});

                // Re-render all cards with new data
                renderMobileCards(allLoadedData);

                // Update pagination info for user feedback
                updateInfiniteScrollInfo();

                // Check if there's more data
                hasMoreData = nextPage < totalPages;

                console.log('Loaded page:', nextPage, 'Total items now:', allLoadedData.length); // Debug log

                if (!hasMoreData) {
                    hideInfiniteScrollIndicator();
                    showEndOfDataIndicator();
                }
            } else {
                hasMoreData = false;
                hideInfiniteScrollIndicator();
                showEndOfDataIndicator();
            }
        } catch (error) {
            console.error('Error loading more data:', error);
            showDeleteNotification('Error loading more data: ' + error.message, true);
        } finally {
            isLoadingMore = false;
            hideLoadingMoreIndicator();
        }
    }


   async function fetchPageData(page, searchTerm = '', sortBy = null, sortDir = null) {
        const params = new URLSearchParams({
            page: page - 1, // Convert to 0-based for backend
            size: pageSize,
            sortBy: sortBy || currentSortColumn,
            sortDir: sortDir || currentSortDirection
        });

        if (searchTerm && searchTerm.trim()) {
            params.append('search', searchTerm.trim());
        }

        // FIXED: Add filter parameters from activeFilters using pipe separator
        if (typeof activeFilters !== 'undefined' && activeFilters.size > 0) {
            activeFilters.forEach((values, fieldId) => {
                if (values.size > 0) {
                    const filterValue = Array.from(values).join('|');
                    params.set(`filter_${fieldId}`, encodeURIComponent(filterValue));
                }
            });
        }

        console.log('Fetching page with params:', params.toString()); // Debug log

        const response = await fetch(`/api/interest-rates?${params.toString()}`);

        if (!response.ok) {
            throw new Error('Failed to fetch data');
        }

        return await response.json();
    }

    // ============================================================================
    // MOBILE CARD RENDERING
    // ============================================================================

    function renderMobileCards(data) {
        const tbody = document.getElementById('tableBody');
        const emptyState = document.getElementById('emptyState');

        if (!data || data.length === 0) {
            tbody.innerHTML = '';
            emptyState.style.display = 'block';
            return;
        }

        emptyState.style.display = 'none';

        // Create card-based layout for mobile
        tbody.innerHTML = data.map(rate => createMobileCard(rate))
            .join('');
    }

    // Replace the createMobileCard function in your existing code with this enhanced version

    function createMobileCard(rate) {
        // Get current field order from headers
        const headers = document.querySelectorAll('.draggable-column, .sortable');
        const currentFieldOrder = Array.from(headers)
            .map(header => ({
                id: header.dataset.fieldId,
                fieldKey: header.dataset.fieldKey,
                label: header.querySelector('.header-text')
                    .textContent.trim()
            }));

        // Generate field rows for the card
        const fieldRows = currentFieldOrder.map(field => {
            const fieldValue = serverRateFieldValuesMap[rate.id]?.[field.id] || '';

    if (field.fieldKey && field.fieldKey.toLowerCase().includes('img')) {
        // Guest view - display only
        return `
            <div class="card-field-row">
                <label class="card-field-label">${field.label}:</label>
                <div class="card-field-value">
                    <div class="mobile-image-container readonly">
                        ${fieldValue ? `<img src="${fieldValue}" alt="Interest Rate Logo" class="interest-rate-logo mobile-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />` : ''}
                        <div class="no-image-placeholder mobile-placeholder" style="${fieldValue ? 'display:none' : 'display:block'}">No Image</div>
                    </div>
                </div>
            </div>
        `;
    } else {
            return `
                <div class="card-field-row">
                    <label class="card-field-label">${field.label}:</label>
                    <div class="card-field-value">
                        <span class="card-field-display">${fieldValue || '-'}</span>
                    </div>
                </div>
            `;
            }
    }).join('');

        // Action buttons (existing logic)
        let actionButtons = '';
            actionButtons = `
                <div class="mobile-card-checkbox">
                    <div class="custom-checkbox-container">
                        <input type="checkbox"
                               class="comparison-checkbox"
                               onchange="toggleComparison(${rate.id}, this.checked)"
                               id="compare-mobile-${rate.id}"
                               ${isSelected ? 'checked' : ''}>
                        <div class="custom-checkbox"></div>
                    </div>
                </div>
                <div class="card-actions">
                            ${rate.moreInfo ? '' : 'disabled'}
                            onclick="showMoreInfo(${rate.id})"
                            title="${rate.moreInfo ? 'Show more info' : 'No additional info available'}">
                        ${rate.moreInfo ? 'MEHR INFO' : 'No Info'}
                    </button>
                    <a class="btn btn-primary btn-sm angebot-btn-card"
                       href="${rate.webLink || '#'}"
                       target="_blank"
                       title="Open Link">
                        ZUM ANGEBOT
                    </a>
                </div>
            `;

        return `
            <div class="mobile-card-row" data-rate-id="${rate.id}">
                <div colspan="100%">
                    <div class="mobile-interest-card" data-rate-id="${rate.id}">
                        <div class="card-header">
                            <h6 class="card-title mb-0">Interest Rate #${rate.id}</h6>
                        </div>
                        <div class="card-body">
                            ${fieldRows}
                            ${actionButtons}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }


    function previewMobileImage(input, rateId, fieldId) {
        const file = input.files[0];
        const preview = document.getElementById(`mobilePreview_${rateId}_${fieldId}`);
        const uploadBtn = document.getElementById(`mobileUploadBtn_${rateId}_${fieldId}`);

        if (file) {
            // Validate file type
            if (!file.type.startsWith('image/')) {
                showDeleteNotification('Please select a valid image file.', true);
                input.value = '';
                return;
            }

            // Validate file size (5MB limit)
            if (file.size > 5 * 1024 * 1024) {
                showDeleteNotification('File size must be less than 5MB.', true);
                input.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                preview.querySelector('img').src = e.target.result;
                preview.style.display = 'block';
                uploadBtn.disabled = false;
            };
            reader.readAsDataURL(file);
        } else {
            preview.style.display = 'none';
            uploadBtn.disabled = true;
        }
    }

    function uploadMobileImage(event, rateId, fieldId) {
        event.preventDefault();

        const fileInput = document.getElementById(`mobileFileInput_${rateId}_${fieldId}`);
        const uploadBtn = document.getElementById(`mobileUploadBtn_${rateId}_${fieldId}`);

        if (!fileInput || !fileInput.files[0]) {
            showDeleteNotification('Please select an image to upload.', true);
            return;
        }

        const formData = new FormData();
        formData.append('image', fileInput.files[0]);
        formData.append('rateId', rateId);
        formData.append('fieldId', fieldId);

        uploadBtn.disabled = true;
        uploadBtn.textContent = 'Uploading...';

        fetch('/api/upload-image', {
            method: 'POST',
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                showDeleteNotification('Image uploaded successfully!', false);
                 setTimeout(() => {
                window.location.reload();
            }, 200);
            } else {
                throw new Error(data.message || 'Upload failed');
            }
        })
        .catch(err => {
            showDeleteNotification('Error: ' + err.message, true);
        })
        .finally(() => {
            uploadBtn.disabled = false;
            uploadBtn.textContent = 'Upload';
        });
    }


    function deleteMobileImage(rateId, fieldId) {
        if (!confirm('Are you sure you want to delete this image?')) {
            return;
        }

        fetch('/api/delete-image', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                rateId: rateId,
                fieldId: fieldId
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Delete failed');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Update server data map
                if (serverRateFieldValuesMap[rateId]) {
                    serverRateFieldValuesMap[rateId][fieldId] = '';
                }

                showDeleteNotification('Image deleted successfully!', false);

                // Re-render the mobile cards
                if (isInfiniteScrollEnabled) {
                    renderMobileCards(allLoadedData);
                } else {
                    renderMobileCards(currentPageData);
                }
            } else {
                throw new Error(data.message || 'Delete failed');
            }
        })
        .catch(error => {
            showDeleteNotification('Error deleting image: ' + error.message, true);
        });
    }

    function cancelMobileImageUpload(rateId, fieldId) {
        const imageDisplay = document.querySelector(`#mobileImageUpload_${rateId}_${fieldId}`)?.previousElementSibling;
        const uploadForm = document.getElementById(`mobileImageUpload_${rateId}_${fieldId}`);

        // Reset form
        const fileInput = uploadForm.querySelector('input[type="file"]');
        const preview = document.getElementById(`mobilePreview_${rateId}_${fieldId}`);
        const uploadBtn = document.getElementById(`mobileUploadBtn_${rateId}_${fieldId}`);

        if (fileInput) fileInput.value = '';
        if (preview) preview.style.display = 'none';
        if (uploadBtn) uploadBtn.disabled = true;

        // Hide form and show image
        if (imageDisplay && uploadForm) {
            uploadForm.style.display = 'none';
            imageDisplay.style.display = 'block';
        }
    }

    function updateMobileFieldValue(rateId, fieldId, value) {
        updateFieldValueAjax(rateId, fieldId, value);
    }

    function updateMobileImageDisplay(inputElement, imagePath) {
        const container = inputElement.closest('.mobile-image-container');
        const img = container.querySelector('img');
        const placeholder = container.querySelector('.no-image-placeholder');

        if (imagePath && imagePath.trim()) {
            if (img) {
                img.src = imagePath;
                img.style.display = 'block';
                placeholder.style.display = 'none';
            } else {
                // Create new img element if it doesn't exist
                const newImg = document.createElement('img');
                newImg.src = imagePath;
                newImg.alt = 'Interest Rate Logo';
                newImg.className = 'interest-rate-logo mobile-image';
                newImg.onerror = function() {
                    this.style.display = 'none';
                    placeholder.style.display = 'block';
                };
                container.querySelector('.image-display').insertBefore(newImg, placeholder);
                placeholder.style.display = 'none';
            }
        } else {
            if (img) {
                img.style.display = 'none';
            }
            placeholder.style.display = 'block';
            placeholder.innerHTML = `
                <span>No Image</span>
                <small>Tap to upload</small>
            `;
        }
    }

    // ============================================================================
    // UI INDICATORS AND CONTROLS
    // ============================================================================

    function hidePaginationControls() {
        const paginationContainers = document.querySelectorAll('.pagination-container');
        paginationContainers.forEach(container => {
            container.style.display = 'none';
        });
    }

    function showPaginationControls() {
        const paginationContainers = document.querySelectorAll('.pagination-container');
        paginationContainers.forEach(container => {
            container.style.display = 'flex';
        });
    }

    function showInfiniteScrollIndicator() {
        let indicator = document.getElementById('infiniteScrollIndicator');
        if (!indicator) {
            indicator = document.createElement('div');
            indicator.id = 'infiniteScrollIndicator';
            indicator.className = 'infinite-scroll-indicator';
            indicator.innerHTML = `
            <div class="text-center py-3">
                <div class="text-muted">Scroll down to load more...</div>
            </div>
        `;

            // Insert after the table container
            const tableContainer = document.querySelector('.table-container');
            if (tableContainer) {
                tableContainer.parentNode.insertBefore(indicator, tableContainer.nextSibling);
            }
        }
        indicator.style.display = 'block';
    }

    function hideInfiniteScrollIndicator() {
        const indicator = document.getElementById('infiniteScrollIndicator');
        if (indicator) {
            indicator.style.display = 'none';
        }
    }

    function showLoadingMoreIndicator() {
        let indicator = document.getElementById('loadingMoreIndicator');
        if (!indicator) {
            indicator = document.createElement('div');
            indicator.id = 'loadingMoreIndicator';
            indicator.className = 'loading-more-indicator';
            indicator.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border spinner-border-sm me-2" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <span class="text-muted">Loading more rates...</span>
            </div>
        `;

            const tableContainer = document.querySelector('.table-container');
            if (tableContainer) {
                tableContainer.parentNode.insertBefore(indicator, tableContainer.nextSibling);
            }
        }
        indicator.style.display = 'block';
    }

    function hideLoadingMoreIndicator() {
        const indicator = document.getElementById('loadingMoreIndicator');
        if (indicator) {
            indicator.style.display = 'none';
        }
    }

    function showEndOfDataIndicator() {
        let indicator = document.getElementById('endOfDataIndicator');
        if (!indicator) {
            indicator = document.createElement('div');
            indicator.id = 'endOfDataIndicator';
            indicator.className = 'end-of-data-indicator';
            indicator.innerHTML = `
            <div class="text-center py-3">
                <div class="text-muted">
                    <div>📊</div>
                    <small>You've reached the end of the results</small>
                </div>
            </div>
        `;

            const tableContainer = document.querySelector('.table-container');
            if (tableContainer) {
                tableContainer.parentNode.insertBefore(indicator, tableContainer.nextSibling);
            }
        }
        indicator.style.display = 'block';
    }

    function updateInfiniteScrollInfo() {
        const totalLoaded = allLoadedData.length;
        const infoText = `Showing ${totalLoaded} of ${totalRecords} results`;

        // Update the results info at the top
        const resultsInfo = document.getElementById('resultsInfo');
        if (resultsInfo) {
            resultsInfo.textContent = infoText;
        }
    }

    // ============================================================================
    // UTILITY FUNCTIONS
    // ============================================================================

    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // ============================================================================
    // OVERRIDE EXISTING FUNCTIONS FOR MOBILE COMPATIBILITY
    // ============================================================================

    // Override search functions to work with infinite scroll
    const originalPerformSearchMobile = window.performSearch;
    window.performSearch = function () {
        const searchInput = document.getElementById('searchInput');
        const searchTerm = searchInput ? searchInput.value.trim() : '';

        if (isInfiniteScrollEnabled) {
            // Reset infinite scroll state
            loadedPages.clear();
            allLoadedData = [];
            hasMoreData = true;
            currentPage = 1;

            // Load first page with search
            loadPageFromServerWithInfiniteScroll(1, searchTerm);
        } else {
            // Use normal search
            originalPerformSearchMobile();
        }
    };

    const originalClearSearchMobile = window.clearSearch;
    window.clearSearch = function () {
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.value = '';
        }

        if (isInfiniteScrollEnabled) {
            // Reset infinite scroll state
            loadedPages.clear();
            allLoadedData = [];
            hasMoreData = true;
            currentPage = 1;

            // Load first page without search
            loadPageFromServerWithInfiniteScroll(1, '');
        } else {
            // Use normal clear
            originalClearSearchMobile();
        }
    };

    // Special function for loading data in infinite scroll mode
    async function loadPageFromServerWithInfiniteScroll(page, searchTerm = '', sortBy = null, sortDir = null) {
        if (isLoadingMore && page > 1) return; // Only block additional page loads, not filter resets

        showLoading();

        try {
            // FIXED: Use the enhanced fetchPageData which now includes filters
            const data = await fetchPageData(page, searchTerm, sortBy, sortDir);

            // Update pagination state
            currentPage = page;
            totalPages = data.totalPages;
            totalRecords = data.totalElements;
            currentSearchTerm = searchTerm || '';

            // Update sort state if provided
            if (sortBy) currentSortColumn = sortBy;
            if (sortDir) currentSortDirection = sortDir;

            // Initialize infinite scroll data
            loadedPages.clear();
            loadedPages.add(page);
            allLoadedData = [...data.content];
            serverRateFieldValuesMap = data.rateFieldValuesMap || {};

            // Render cards
            renderMobileCards(allLoadedData);

            // Update UI
            updateInfiniteScrollInfo();
            hasMoreData = page < totalPages;

            console.log('Loaded page:', page, 'Total pages:', totalPages, 'Has more:', hasMoreData); // Debug log

            if (hasMoreData) {
                showInfiniteScrollIndicator();
            } else {
                hideInfiniteScrollIndicator();
                showEndOfDataIndicator();
            }

            hideLoading();
        } catch (error) {
            console.error('Error loading page:', error);
            showDeleteNotification('Error loading data: ' + error.message, true);
            hideLoading();
        }
    }

    // Handle clicks on custom checkbox containers
    document.addEventListener('click', function(e) {
        const container = e.target.closest('.custom-checkbox-container');
        if (container && (e.target.classList.contains('custom-checkbox') || e.target.classList.contains('checkbox-label'))) {
            const checkbox = container.querySelector('.comparison-checkbox');
            if (checkbox && !checkbox.disabled) {
                checkbox.checked = !checkbox.checked;
                checkbox.dispatchEvent(new Event('change'));
            }
        }
    });

    // ============================================================================
    // INITIALIZATION
    // ============================================================================

    document.addEventListener('DOMContentLoaded', function () {
        const stackedViewBtn = document.getElementById('stackedView');
        const scrollViewBtn = document.getElementById('scrollView');
        const tableContainer = document.getElementById('tableContainer');

        if (stackedViewBtn && scrollViewBtn && tableContainer) {
            stackedViewBtn.addEventListener('click', function () {
                enableMobileCardView();
            });

            scrollViewBtn.addEventListener('click', function () {
                disableMobileCardView();
            });
        }
    });

    // Export functions for debugging
    window.mobileScrollFunctions = {
        enableInfiniteScroll,
        disableInfiniteScroll,
        loadMoreData,
        renderMobileCards,
        checkMobileView
    };


    // FIXED: Override the original functions to use the fixed versions
    window.createMobileCard = createMobileCard;
    window.showMoreInfo = showMoreInfo;
    window.displayRateCard = displayRateCard;
    window.enableMobileCardView = enableMobileCardView;
    window.disableMobileCardView = disableMobileCardView;
    window.disableInfiniteScroll = disableInfiniteScroll;
    window.resetToNormalPagination = resetToNormalPagination;
    window.checkMobileView = checkMobileView;
    window.initializeMobileScrolling = initializeMobileScrolling;
    window.applyFilters = applyFilters;
    window.removeFilterTag = removeFilterTag;
    window.clearAllFilters = clearAllFilters;
    window.performSearch = performSearch;
    window.clearSearch = clearSearch;
    window.loadMoreData = loadMoreData;
    window.fetchPageData = fetchPageData;
    window.loadPageFromServerWithInfiniteScroll = loadPageFromServerWithInfiniteScroll;

    // Debug function to check current filter state
    window.debugFilters = function () {
        console.log('Active filters:', activeFilters);
        console.log('Is infinite scroll enabled:', isInfiniteScrollEnabled);
        console.log('Current page:', currentPage);
        console.log('Total pages:', totalPages);
        console.log('Has more data:', hasMoreData);
        console.log('Loaded pages:', loadedPages);
        console.log('All loaded data length:', allLoadedData.length);
    };

    console.log('Filter integration for infinite scroll has been fixed!');
</script>
</body>
</html>