<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Interest Rate Offers</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/styles.css">
    <style>
        .section-controls {
    position: absolute;
    top: 10px;
    right: 10px;
    display: flex;
    gap: 8px;
    align-items: center;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.expanded-section:hover .section-controls {
    opacity: 1;
}

.section-type-indicator {
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: 600;
    letter-spacing: 0.5px;
}

.text-section .section-type-indicator {
    background: linear-gradient(135deg, #28a745, #1e7e34);
}

.delete-section-btn {
    background: linear-gradient(135deg, #dc3545, #c82333);
    color: white;
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.delete-section-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
}

.section-management-buttons {
    display: flex;
    gap: 12px;
    justify-content: center;
    margin-top: 20px;
    padding: 15px;
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border-radius: 8px;
    border: 2px dashed #dee2e6;
}

.add-section-btn {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.9rem;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 6px;
}

.add-section-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
}

.add-section-btn.text-btn {
    background: linear-gradient(135deg, #007bff, #0056b3);
}

.add-section-btn.text-btn:hover {
    box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
}

.section-drag-handle {
    position: absolute;
    top: 10px;
    left: 10px;
    color: #6c757d;
    cursor: move;
    font-size: 14px;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.expanded-section:hover .section-drag-handle {
    opacity: 1;
}

.expanded-section.dragging {
    opacity: 0.5;
    transform: rotate(2deg);
    cursor: grabbing;
}

.expanded-section.drag-over {
    border: 2px dashed #007bff;
    background: rgba(0, 123, 255, 0.1);
}

.expanded-section {
    position: relative;
    cursor: grab;
    transition: all 0.3s ease;
}

.expanded-section:active {
    cursor: grabbing;
}

/* Section order notification */
.section-order-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    border-radius: 6px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    z-index: 2001;
    opacity: 0;
    transform: translateX(100%);
    transition: all 0.3s ease;
    background: #28a745;
    color: white;
}

.section-order-notification.show {
    opacity: 1;
    transform: translateX(0);
}

.section-order-notification.error {
    background: #dc3545;
}
        .action-buttons {
            display: flex;
            gap: 5px;
            justify-content: center;
            align-items: center;
        }

        .btn-edit {
            background: #ffc107;
            color: #000;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            text-decoration: none;
            transition: all 0.2s;
        }

        .btn-edit:hover {
            background: #e0a800;
            color: #000;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-delete:hover {
            background: #c82333;
        }

        /* Field delete button styling */
        .delete-field-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 2px 6px;
            font-size: 11px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            margin-left: 5px;
        }

        .header-container:hover .delete-field-btn {
            opacity: 1;
        }

        .delete-field-btn:hover {
            background: #c82333;
        }

        .delete-confirmation-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .delete-confirmation-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .delete-confirmation-content h5 {
            color: #dc3545;
            margin-bottom: 15px;
        }

        .delete-confirmation-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .delete-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 2001;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }

        .delete-notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .delete-notification.success {
            background: #28a745;
            color: white;
        }

        .delete-notification.error {
            background: #dc3545;
            color: white;
        }

        .field-info {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            border-left: 4px solid #007bff;
        }

        .warning-text {
            color: #dc3545;
            font-weight: 600;
            margin-top: 10px;
        }
    </style>
</head>
<body class="bg-light">
<div class="container py-4">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex align-items-center">
            <h2>Interest Rate Offers</h2>
            <span class="order-changed-indicator" id="orderChangedIndicator">
                Order changed - click save to persist
            </span>
            <button class="save-order-btn" id="saveOrderBtn" onclick="saveColumnOrder()">
                Save Order
            </button>
        </div>
        <a class="btn btn-primary" href="/interest-rate/new">+ Add New Interest Rate</a>
    </div>

    <!-- Form to Add a New Global Field -->
    <form class="mb-4" method="post" th:action="@{/fields/add}" th:object="${newField}">
        <div class="row g-2">
            <div class="col-md-4">
                <input class="form-control" placeholder="Label (e.g. Max Deposit)" th:field="*{label}"/>
            </div>
            <div class="col-md-4">
                <button class="btn btn-primary w-100">Add Field</button>
            </div>
        </div>
    </form>

    <!-- Interest Rate Table -->
    <div class="table-responsive">
        <table class="table table-bordered table-striped text-center align-middle" id="mainTable">
            <thead class="table-dark">
            <tr id="column-header-row">
                <!-- Dynamic Headers with Edit, Delete Functionality and Drag Handle -->
                <th class="draggable-column"
                    draggable="true"
                    ondragend="handleDragEnd(event)"
                    ondragover="handleDragOver(event)"
                    ondragstart="handleDragStart(event)"
                    ondrop="handleDrop(event)"
                    th:data-field-id="${field.id}"
                    th:each="field, iterStat : ${globalFields}">

                    <div class="drag-handle">‚ãÆ‚ãÆ</div>

                    <div class="header-container">
                        <span class="header-text" th:text="${field.label}"></span>
                        <button class="edit-header-btn" th:onclick="'showEditForm(' + ${field.id} + ')'" type="button">
                            ‚úé
                        </button>
                        <button class="delete-field-btn"
                                th:data-id="${field.id}"
                                th:data-label="${field.label}"
                                onclick="handleFieldDeleteClick(this)"
                                type="button"
                                title="Delete this field">
                            üóë
                        </button>


                        <!-- Edit Form -->
                        <div class="header-edit-form" th:id="'editForm_' + ${field.id}">
                            <form method="post" th:action="@{/fields/update}">
                                <input name="fieldId" th:value="${field.id}" type="hidden"/>

                                <div class="form-row">
                                    <label>Display Label:</label>
                                    <input name="label" required th:value="${field.label}" type="text"/>
                                </div>

                                <div class="form-buttons">
                                    <button class="save-btn" type="submit">Save</button>
                                    <button class="cancel-btn" th:onclick="'hideEditForm(' + ${field.id} + ')'"
                                            type="button">Cancel
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </th>
                <th class="no-drag">Actions</th>
            </tr>
            </thead>

            <tbody>
            <tr th:each="rate : ${interestRates}">
                <!-- Dynamic fields -->
                <td class="data-cell"
                    th:data-field-id="${field.id}"
                    th:each="field : ${globalFields}">
                    <form class="d-flex justify-content-center" method="post" th:action="@{/field-values/update}">
                        <input name="rateId" th:value="${rate.id}" type="hidden"/>
                        <input name="fieldId" th:value="${field.id}" type="hidden"/>
                        <input class="form-control form-control-sm text-center"
                               name="value"
                               style="width: 100px;"
                               th:value="${rateFieldValuesMap[rate.id]?.get(field.id)}"
                               type="text"/>
                    </form>
                </td>

                <!-- Actions -->
                <td>
                    <div class="action-buttons">
                        <button class="mehr-info-btn"
                                th:disabled="${rate.moreInfo == null}"
                                th:onclick="'showMoreInfo(' + ${rate.id} + ')'"
                                th:text="${rate.moreInfo != null ? 'MEHR INFO' : 'No Info'}">
                        </button>

                        <a class="btn-edit" th:href="@{/interest-rate/edit/{id}(id=${rate.id})}" title="Edit Interest Rate">
                            ‚úé Edit
                        </a>

                        <button class="btn-delete"
                                th:onclick="'showDeleteConfirmation(' + ${rate.id} + ')'"
                                title="Delete Interest Rate">
                            üóë Delete
                        </button>
                    </div>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Field Delete Confirmation Modal -->
<div class="delete-confirmation-modal" id="fieldDeleteConfirmationModal">
    <div class="delete-confirmation-content">
        <h5>‚ö†Ô∏è Delete Field</h5>
        <div class="field-info">
            <p><strong>Field:</strong> <span id="fieldToDeleteName">Field Name</span></p>
            <p><strong>ID:</strong> <span id="fieldToDeleteId">Field ID</span></p>
        </div>
        <p>Are you sure you want to delete this field (column)?</p>
        <div class="warning-text">
            ‚ö†Ô∏è This will permanently remove the field and ALL associated data for every interest rate!
        </div>
        <p><strong>This action cannot be undone.</strong></p>

        <div class="delete-confirmation-buttons">
            <button class="btn btn-danger" id="confirmFieldDeleteBtn">Yes, Delete Field</button>
            <button class="btn btn-secondary" onclick="hideFieldDeleteConfirmation()">Cancel</button>
        </div>
    </div>
</div>

<!-- Interest Rate Delete Confirmation Modal -->
<div class="delete-confirmation-modal" id="deleteConfirmationModal">
    <div class="delete-confirmation-content">
        <h5>‚ö†Ô∏è Confirm Deletion</h5>
        <p>Are you sure you want to delete this interest rate?</p>
        <p><strong>This action cannot be undone.</strong></p>

        <div class="delete-confirmation-buttons">
            <button class="btn btn-danger" id="confirmDeleteBtn">Yes, Delete</button>
            <button class="btn btn-secondary" onclick="hideDeleteConfirmation()">Cancel</button>
        </div>
    </div>
</div>

<!-- Drop indicator -->
<div class="drop-indicator" id="dropIndicator"></div>

<!-- Section order notification -->
<div class="section-order-notification" id="sectionOrderNotification">
    Section order updated successfully!
</div>

<!-- Delete notification -->
<div class="delete-notification" id="deleteNotification">
    Action completed successfully!
</div>

<script th:inline="javascript">
    const interestRatesData = /*[[${interestRates}]]*/ [];

    let currentExpandedCard = null;
    let currentEditForm = null;
    let draggedElement = null;
    let orderChanged = false;
    let originalOrder = [];
    let pendingDeleteId = null;
    let pendingFieldDeleteId = null;

    let draggedSection = null;
    let currentRateId = null;

    document.addEventListener('DOMContentLoaded', function () {
        captureOriginalOrder();
    });

    function captureOriginalOrder() {
        const headers = document.querySelectorAll('.draggable-column');
        originalOrder = Array.from(headers)
            .map(header => header.dataset.fieldId);
    }

    function handleFieldDeleteClick(button) {
        const fieldId = button.dataset.id;
        const fieldLabel = button.dataset.label;
        showFieldDeleteConfirmation(fieldId, fieldLabel);
    }

    function showFieldDeleteConfirmation(fieldId, fieldLabel) {
        pendingFieldDeleteId = fieldId;
        document.getElementById('fieldToDeleteName')
            .textContent = fieldLabel;
        document.getElementById('fieldToDeleteId')
            .textContent = fieldId;
        document.getElementById('fieldDeleteConfirmationModal')
            .style.display = 'flex';

        document.getElementById('confirmFieldDeleteBtn')
            .onclick = function () {
                deleteGlobalField(fieldId);
            };
    }

    function hideFieldDeleteConfirmation() {
        document.getElementById('fieldDeleteConfirmationModal')
            .style.display = 'none';
        pendingFieldDeleteId = null;
    }

    function deleteGlobalField(fieldId) {
        const confirmBtn = document.getElementById('confirmFieldDeleteBtn');
        const originalText = confirmBtn.textContent;
        confirmBtn.textContent = 'Deleting...';
        confirmBtn.disabled = true;

        fetch(`/fields/delete/${fieldId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to delete field');
                }
                return response.text();
            })
            .then(data => {
                hideFieldDeleteConfirmation();

                showDeleteNotification('Field deleted successfully! Page will reload...', false);

                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            })
            .catch(error => {
                // Reset button
                confirmBtn.textContent = originalText;
                confirmBtn.disabled = false;

                showDeleteNotification('Error deleting field: ' + error.message, true);
            });
    }

    // Interest rate delete functionality
    function showDeleteConfirmation(rateId) {
        pendingDeleteId = rateId;
        document.getElementById('deleteConfirmationModal')
            .style.display = 'flex';

        // Set up the confirm button click handler
        document.getElementById('confirmDeleteBtn')
            .onclick = function () {
                deleteInterestRate(rateId);
            };
    }

    function hideDeleteConfirmation() {
        document.getElementById('deleteConfirmationModal')
            .style.display = 'none';
        pendingDeleteId = null;
    }

    function deleteInterestRate(rateId) {
        fetch(`/interest-rate/${rateId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to delete interest rate');
                }
                return response.text();
            })
            .then(data => {
                // Hide the confirmation modal
                hideDeleteConfirmation();

                // Show success notification
                showDeleteNotification('Interest rate deleted successfully!', false);

                // Remove the row from the table
                removeInterestRateRow(rateId);

                // Close any expanded card for this rate
                closeExpandedCard(rateId);
            })
            .catch(error => {
                hideDeleteConfirmation();
                showDeleteNotification('Error deleting interest rate: ' + error.message, true);
            });
    }

    function removeInterestRateRow(rateId) {
        // Find and remove the main table row
        const tableRows = document.querySelectorAll('#mainTable tbody tr');
        tableRows.forEach(row => {
            const rateIdInput = row.querySelector('input[name="rateId"]');
            if (rateIdInput && rateIdInput.value == rateId) {
                row.remove();
            }
        });

        // Remove from interestRatesData array
        const index = interestRatesData.findIndex(rate => rate.id === rateId);
        if (index > -1) {
            interestRatesData.splice(index, 1);
        }
    }

    function showDeleteNotification(message, isError) {
        const notification = document.getElementById('deleteNotification');
        notification.textContent = message;
        notification.classList.toggle('error', isError);
        notification.classList.toggle('success', !isError);
        notification.classList.add('show');

        setTimeout(() => {
            notification.classList.remove('show');
        }, 3000);
    }

    // Close modals when clicking outside
    document.getElementById('deleteConfirmationModal')
        .addEventListener('click', function (e) {
            if (e.target === this) {
                hideDeleteConfirmation();
            }
        });

    document.getElementById('fieldDeleteConfirmationModal')
        .addEventListener('click', function (e) {
            if (e.target === this) {
                hideFieldDeleteConfirmation();
            }
        });

    // Column drag and drop functionality
    function handleDragStart(event) {
        draggedElement = event.target;
        event.target.classList.add('dragging');
        event.dataTransfer.effectAllowed = 'move';
        event.dataTransfer.setData('text/html', event.target.outerHTML);
    }

    function handleDragOver(event) {
        event.preventDefault();
        event.dataTransfer.dropEffect = 'move';

        const target = event.target.closest('.draggable-column');
        if (target && target !== draggedElement) {
            // Remove existing drag-over class
            document.querySelectorAll('.drag-over')
                .forEach(el => el.classList.remove('drag-over'));
            target.classList.add('drag-over');

            // Show drop indicator
            showDropIndicator(target, event);
        }
    }

    function handleDrop(event) {
        event.preventDefault();

        const target = event.target.closest('.draggable-column');
        if (target && target !== draggedElement) {
            const draggedFieldId = draggedElement.dataset.fieldId;
            const targetFieldId = target.dataset.fieldId;

            // Move the column
            moveColumn(draggedFieldId, targetFieldId);

            // Mark order as changed
            markOrderChanged();
        }

        // Clean up
        cleanup();
    }

    function handleDragEnd(event) {
        cleanup();
    }

    function cleanup() {
        if (draggedElement) {
            draggedElement.classList.remove('dragging');
        }
        document.querySelectorAll('.drag-over')
            .forEach(el => el.classList.remove('drag-over'));
        hideDropIndicator();
        draggedElement = null;
    }

    function moveColumn(draggedFieldId, targetFieldId) {
        const headerRow = document.getElementById("column-header-row");
        const headers = Array.from(headerRow.querySelectorAll(".draggable-column"));

        const draggedIndex = headers.findIndex(h => h.dataset.fieldId === draggedFieldId);
        const targetIndex = headers.findIndex(h => h.dataset.fieldId === targetFieldId);

        if (draggedIndex === -1 || targetIndex === -1 || draggedIndex === targetIndex) return;

        // Move header
        const draggedHeader = headers[draggedIndex];
        if (targetIndex < draggedIndex) {
            headerRow.insertBefore(draggedHeader, headers[targetIndex]);
        } else {
            headerRow.insertBefore(draggedHeader, headers[targetIndex].nextSibling);
        }

        // Move data cells for each row
        const rows = document.querySelectorAll("#mainTable tbody tr");
        rows.forEach(row => {
            const cells = Array.from(row.querySelectorAll(".data-cell"));
            const draggedCell = cells[draggedIndex];
            if (!draggedCell) return;

            if (targetIndex < draggedIndex) {
                row.insertBefore(draggedCell, cells[targetIndex]);
            } else {
                row.insertBefore(draggedCell, cells[targetIndex].nextSibling);
            }
        });
    }

    function markOrderChanged() {
        orderChanged = true;
        document.getElementById("saveOrderBtn")
            .classList.add("show");
        document.getElementById("orderChangedIndicator")
            .classList.add("show");
    }

    function saveColumnOrder() {
        const headers = document.querySelectorAll(".draggable-column");
        const newOrder = Array.from(headers)
            .map(header => header.dataset.fieldId);

        fetch('/fields/reorder', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': getCsrfToken()
                },
                body: JSON.stringify(newOrder)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error("Failed to save order");
                }
                return response.text();
            })
            .then(data => {
                orderChanged = false;
                document.getElementById("saveOrderBtn")
                    .classList.remove("show");
                document.getElementById("orderChangedIndicator")
                    .classList.remove("show");
                console.log(data);
            })
            .catch(error => {
                alert("Error saving order: " + error.message);
            });
    }

    // Optional: CSRF token extraction if needed for Spring Security
    function getCsrfToken() {
        const tokenMeta = document.querySelector('meta[name="_csrf"]');
        return tokenMeta ? tokenMeta.getAttribute('content') : '';
    }

    function showDropIndicator(target, event) {
        const indicator = document.getElementById("dropIndicator");
        const rect = target.getBoundingClientRect();
        indicator.style.left = `${rect.left}px`;
        indicator.style.top = `${rect.top}px`;
        indicator.style.height = `${rect.height}px`;
        indicator.classList.add("show");
    }

    function hideDropIndicator() {
        document.getElementById("dropIndicator")
            .classList.remove("show");
    }

    // Section drag and drop functions - FIXED VERSION
    function handleSectionDragStart(event, sectionIdentifier, rateId) {
        draggedSection = {
            element: event.target.closest('.expanded-section'),
            identifier: sectionIdentifier,
            rateId: rateId
        };
        draggedSection.element.classList.add('dragging');
        currentRateId = rateId;
        event.dataTransfer.effectAllowed = 'move';
        event.dataTransfer.setData('text/plain', sectionIdentifier);
    }

    function handleSectionDragOver(event) {
        event.preventDefault();
        event.dataTransfer.dropEffect = 'move';

        const target = event.target.closest('.expanded-section');
        if (target && draggedSection && target !== draggedSection.element &&
            target.closest(`#rateCard_${currentRateId}`)) {

            // Remove existing drag-over class
            document.querySelectorAll('.drag-over')
                .forEach(el => el.classList.remove('drag-over'));
            target.classList.add('drag-over');
        }
    }

    function handleSectionDrop(event, targetIdentifier, rateId) {
        event.preventDefault();

        if (draggedSection && draggedSection.rateId === rateId && draggedSection.identifier !== targetIdentifier) {
            const sourceElement = draggedSection.element;
            const targetElement = event.target.closest('.expanded-section');

            if (sourceElement && targetElement) {
                // Get the parent container (should be the rate card content)
                const parent = sourceElement.parentElement;

                // Determine if we should insert before or after the target
                const sourceIndex = Array.from(parent.children)
                    .indexOf(sourceElement);
                const targetIndex = Array.from(parent.children)
                    .indexOf(targetElement);

                if (sourceIndex < targetIndex) {
                    // Moving down - insert after target
                    parent.insertBefore(sourceElement, targetElement.nextSibling);
                } else {
                    // Moving up - insert before target
                    parent.insertBefore(sourceElement, targetElement);
                }

                // Get new order from DOM - only count sections with data-section-id
                const sections = parent.querySelectorAll('[data-section-id]');
                const newOrder = Array.from(sections)
                    .map(el => el.getAttribute('data-section-id'));

                // Update the order in the database
                saveSectionOrder(rateId, newOrder);
            }
        }

        // Clean up
        cleanupSectionDrag();
    }

    function handleSectionDragEnd(event) {
        cleanupSectionDrag();
    }

    function cleanupSectionDrag() {
        if (draggedSection && draggedSection.element) {
            draggedSection.element.classList.remove('dragging');
        }
        document.querySelectorAll('.drag-over')
            .forEach(el => el.classList.remove('drag-over'));
        draggedSection = null;
        currentRateId = null;
    }

    // Save section order - single implementation
    function saveSectionOrder(rateId, newOrder) {
        fetch(`/sections/reorder?rateId=${rateId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(newOrder)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error("Failed to save section order");
                }
                return response.text();
            })
            .then(data => {
                showSectionOrderNotification("Section order updated successfully!", false);
            })
            .catch(error => {
                showSectionOrderNotification("Error saving section order: " + error.message, true);
            });
    }

    function showAddTableSectionForm(rateId) {
        const title = prompt('Enter table section title:');
        if (title && title.trim()) {
            addTableSectionToRate(rateId, title.trim());
        }
    }

    function showAddTextSectionForm(rateId) {
        const title = prompt('Enter text section title:');
        if (title && title.trim()) {
            const content = prompt('Enter text content:');
            addTextSectionToRate(rateId, title.trim(), content || '');
        }
    }

    function addTableSectionToRate(rateId, title) {
        fetch('/sections/add-table', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `rateId=${rateId}&title=${encodeURIComponent(title)}`
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error("Failed to add table section");
                }
                return response.text();
            })
            .then(data => {
                showSectionOrderNotification("Table section added successfully!", false);
                // Refresh the expanded card
                closeExpandedCard(rateId);
                setTimeout(() => showMoreInfo(rateId), 500);
            })
            .catch(error => {
                showSectionOrderNotification("Error adding table section: " + error.message, true);
            });
    }

    function addTextSectionToRate(rateId, title, content) {
        fetch('/sections/add-text', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `rateId=${rateId}&title=${encodeURIComponent(title)}&content=${encodeURIComponent(content)}`
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error("Failed to add text section");
                }
                return response.text();
            })
            .then(data => {
                showSectionOrderNotification("Text section added successfully!", false);
                // Refresh the expanded card
                closeExpandedCard(rateId);
                setTimeout(() => showMoreInfo(rateId), 500);
            })
            .catch(error => {
                showSectionOrderNotification("Error adding text section: " + error.message, true);
            });
    }

    function deleteSection(rateId, sectionIdentifier) {
        if (confirm('Are you sure you want to delete this section? This action cannot be undone.')) {
            fetch(`/sections/${sectionIdentifier}?rateId=${rateId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Failed to delete section");
                    }
                    return response.text();
                })
                .then(data => {
                    showSectionOrderNotification("Section deleted successfully!", false);
                    // Refresh the expanded card
                    closeExpandedCard(rateId);
                    setTimeout(() => showMoreInfo(rateId), 500);
                })
                .catch(error => {
                    showSectionOrderNotification("Error deleting section: " + error.message, true);
                });
        }
    }

    function showSectionOrderNotification(message, isError) {
        const notification = document.getElementById('sectionOrderNotification');
        notification.textContent = message;
        notification.classList.toggle('error', isError);
        notification.classList.add('show');

        setTimeout(() => {
            notification.classList.remove('show');
        }, 3000);
    }

    function showMoreInfo(rateId) {
        const rate = interestRatesData.find(r => r.id === rateId);
        if (!rate || !rate.moreInfo) return;

        // Close any currently expanded card
        if (currentExpandedCard && currentExpandedCard !== rateId) {
            closeExpandedCard(currentExpandedCard);
        }

        // Check if card already exists
        let existingCard = document.getElementById(`rateCard_${rateId}`);
        if (existingCard) {
            existingCard.remove();
            if (currentExpandedCard === rateId) {
                currentExpandedCard = null;
                return;
            }
        }

        // Find the table row that was clicked
        const tableRows = document.querySelectorAll('tbody tr');
        let targetRow = null;

        tableRows.forEach(row => {
            const button = row.querySelector('.mehr-info-btn');
            if (button && button.onclick && button.onclick.toString()
                .includes(`showMoreInfo(${rateId})`)) {
                targetRow = row;
            }
        });

        if (!targetRow) return;

        // Create new card
        const card = createRateCard(rate);

        // Create a new table row to hold the card
        const cardRow = document.createElement('tr');
        cardRow.id = `rateCardRow_${rateId}`;
        cardRow.innerHTML = `<td colspan="100%" style="padding: 0; background: transparent;"></td>`;

        // Insert the card into the cell
        cardRow.firstChild.appendChild(card);

        // Insert the card row after the clicked row
        targetRow.parentNode.insertBefore(cardRow, targetRow.nextSibling);

        // Scroll to the card
        card.scrollIntoView({
            behavior: 'smooth',
            block: 'center'
        });

        currentExpandedCard = rateId;
    }

    function createRateCard(rate) {
        const card = document.createElement('div');
        card.className = 'rate-card';
        card.id = `rateCard_${rate.id}`;

        const moreInfo = rate.moreInfo;
        if (!moreInfo) return card;

        // Get the section order from the data, default to empty array
        const sectionOrder = moreInfo.sectionOrder || [];

        // Create section content maps
        const tableSectionsMap = new Map();
        const textSectionsMap = new Map();

        // Map table sections by identifier
        if (moreInfo.tableSections) {
            moreInfo.tableSections.forEach(tableSection => {
                tableSectionsMap.set(tableSection.sectionIdentifier, tableSection);
            });
        }

        // Map text sections by identifier
        if (moreInfo.textSections) {
            moreInfo.textSections.forEach(textSection => {
                textSectionsMap.set(textSection.sectionIdentifier, textSection);
            });
        }

        // Helper function to create table sections
        const createTableSection = (tableSection) => {
            if (!tableSection || !tableSection.title || !tableSection.miniTableRows || tableSection.miniTableRows.length === 0) {
                return '';
            }
            return `
                    <div class="expanded-section draggable-section table-section"
                         draggable="true"
                         data-section-type="table"
                         data-section-id="${tableSection.sectionIdentifier}"
                         ondragstart="handleSectionDragStart(event, '${tableSection.sectionIdentifier}', ${rate.id})"
                         ondragover="handleSectionDragOver(event)"
                         ondrop="handleSectionDrop(event, '${tableSection.sectionIdentifier}', ${rate.id})"
                         ondragend="handleSectionDragEnd(event)">
                        <div class="section-drag-handle" title="Drag to reorder">‚ãÆ‚ãÆ</div>
                        <div class="section-controls">
                            <span class="section-type-indicator">Table</span>
                            <button class="delete-section-btn" onclick="deleteSection(${rate.id}, '${tableSection.sectionIdentifier}')" title="Delete section">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                        <h5 class="section-title">${tableSection.title}</h5>
                        <div class="info-table">
                            ${tableSection.miniTableRows.map(row => `
                                <div class="info-table-row">
                                    <div class="info-table-label">${row.label || ''}</div>
                                    <div class="info-table-value">${row.description || ''}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
        };

        // Helper function to create text sections
        const createTextSection = (textSection) => {
            if (!textSection || (!textSection.title && !textSection.content)) {
                return '';
            }
            return `
                    <div class="expanded-section draggable-section text-section"
                         draggable="true"
                         data-section-type="text"
                         data-section-id="${textSection.sectionIdentifier}"
                         ondragstart="handleSectionDragStart(event, '${textSection.sectionIdentifier}', ${rate.id})"
                         ondragover="handleSectionDragOver(event)"
                         ondrop="handleSectionDrop(event, '${textSection.sectionIdentifier}', ${rate.id})"
                         ondragend="handleSectionDragEnd(event)">
                        <div class="section-drag-handle" title="Drag to reorder">‚ãÆ‚ãÆ</div>
                        <div class="section-controls">
                            <span class="section-type-indicator">Text</span>
                            <button class="delete-section-btn" onclick="deleteSection(${rate.id}, '${textSection.sectionIdentifier}')" title="Delete section">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                        ${textSection.title ? `<h5 class="section-title">${textSection.title}</h5>` : ''}
                        <div class="text-content" style="text-align: left;">${textSection.content || ''}</div>
                    </div>
                `;
        };

        // Build sections in the correct order
        let sectionsHTML = '';
        sectionOrder.forEach(sectionIdentifier => {
            if (sectionIdentifier.startsWith('table-')) {
                const tableSection = tableSectionsMap.get(sectionIdentifier);
                if (tableSection) {
                    sectionsHTML += createTableSection(tableSection);
                }
            } else if (sectionIdentifier.startsWith('text-')) {
                const textSection = textSectionsMap.get(sectionIdentifier);
                if (textSection) {
                    sectionsHTML += createTextSection(textSection);
                }
            }
        });

        // Add any sections not in the order (fallback)
        tableSectionsMap.forEach((tableSection, identifier) => {
            if (!sectionOrder.includes(identifier)) {
                sectionsHTML += createTableSection(tableSection);
            }
        });

        textSectionsMap.forEach((textSection, identifier) => {
            if (!sectionOrder.includes(identifier)) {
                sectionsHTML += createTextSection(textSection);
            }
        });

        // Add section management buttons
        const managementButtons = `
                <div class="section-management-buttons">
                    <button class="add-section-btn table-btn" onclick="showAddTableSectionForm(${rate.id})" title="Add Table Section">
                        <i class="bi bi-table"></i> Add Table
                    </button>
                    <button class="add-section-btn text-btn" onclick="showAddTextSectionForm(${rate.id})" title="Add Text Section">
                        <i class="bi bi-text-paragraph"></i> Add Text
                    </button>
                </div>
            `;

        card.innerHTML = `
                <div class="rate-expanded-content show">
                    ${sectionsHTML}
                    ${managementButtons}
                </div>
            `;

        return card;
    }

    function closeExpandedCard(rateId) {
        const cardRow = document.getElementById(`rateCardRow_${rateId}`);
        if (cardRow) {
            cardRow.remove();
            if (currentExpandedCard === rateId) {
                currentExpandedCard = null;
            }
        }
    }

    // Show/hide edit form logic
    function showEditForm(fieldId) {
        if (currentEditForm) {
            currentEditForm.classList.remove('show');
        }
        const form = document.getElementById('editForm_' + fieldId);
        if (form) {
            form.classList.add('show');
            currentEditForm = form;
        }
    }

    function hideEditForm(fieldId) {
        const form = document.getElementById('editForm_' + fieldId);
        if (form) {
            form.classList.remove('show');
        }
        currentEditForm = null;
    }

    // Handle outside click to close header edit form
    document.addEventListener('click', function (e) {
        if (currentEditForm && !currentEditForm.contains(e.target) && !e.target.classList.contains('edit-header-btn')) {
            currentEditForm.classList.remove('show');
            currentEditForm = null;
        }
    });
</script>
</body>
</html>