<!DOCTYPE html>
<html xmlns:sec="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Edit Interest Rate</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.snow.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/css/dark-mode.css" rel="stylesheet">
    <style>
        @import url('https://api.fonts.coollabs.io/css2?family=Mona+Sans:wght@200;300;400;500;600;700;800;900&display=swap');

        * {
            font-family: 'Mona Sans', sans-serif !important;
        }
    </style>
    <style>
        /* Image Upload Styles */
        .image-upload-container {
            margin-top: 10px;
        }

        .image-upload-area {
            width: 100%;
        }

        .upload-zone {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
            position: relative;
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .upload-zone:hover {
            border-color: #007bff;
            background: #e7f3ff;
        }

        .upload-zone.drag-over {
            border-color: #28a745;
            background: #e8f5e8;
        }

        .upload-placeholder {
            text-align: center;
        }

        .upload-placeholder i {
            font-size: 2rem;
            color: #6c757d;
            margin-bottom: 10px;
        }

        .upload-placeholder p {
            margin: 8px 0 4px 0;
            font-weight: 500;
            color: #495057;
        }

        .upload-placeholder small {
            color: #6c757d;
        }

        .image-preview {
            position: relative;
            width: 100%;
            height: 100%;
        }

        .preview-image {
            max-width: 100%;
            max-height: 200px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .image-overlay {
            position: absolute;
            top: 5px;
            right: 5px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .image-preview:hover .image-overlay {
            opacity: 1;
        }

        .remove-image {
            background: rgba(220, 53, 69, 0.9);
            border: none;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .remove-image:hover {
            background: #dc3545;
            transform: scale(1.1);
        }

        .upload-progress {
            margin-top: 10px;
        }

        .upload-progress .progress {
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
        }

        .upload-progress .progress-bar {
            background: linear-gradient(45deg, #007bff, #0056b3);
            transition: width 0.3s ease;
            height: 100%;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .upload-zone {
                padding: 15px;
                min-height: 100px;
            }

            .upload-placeholder i {
                font-size: 1.5rem;
            }

            .preview-image {
                max-height: 150px;
            }
        }

        /* Animation for upload success */
        @keyframes uploadSuccess {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .upload-success {
            animation: uploadSuccess 0.6s ease;
        }

        /* Notification styles */
        #upload-notification {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border: none;
        }

        .edit-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin: 20px 0;
        }

        .edit-header {
            background: linear-gradient(135deg, #e3ded0, #0d00ff6e);
            color: #000;
            padding: 25px 30px;
            position: relative;
            overflow: hidden;
        }

        .edit-header h1 {
            margin: 0;
            font-weight: 700;
            font-size: 2rem;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .edit-badge {
            background: rgba(0, 0, 0, 0.15);
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .form-container {
            padding: 30px;
        }

        .section-header {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-left: 5px solid #ffc107;
            padding: 15px 20px;
            margin: 25px 0 15px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .section-header h5 {
            margin: 0;
            color: #495057;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .dynamic-section {
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
            transition: all 0.3s ease;
        }

        .dynamic-section:hover {
            border-color: #ffc107;
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.15);
        }

        .section-controls {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 8px;
        }

        .section-type-badge {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            position: absolute;
            top: 15px;
            left: 15px;
        }

        .remove-section-btn {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .remove-section-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
        }

        .add-section-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 10px 5px;
        }

        .add-section-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(40, 167, 69, 0.3);
        }

        .mini-table-row {
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
            position: relative;
            transition: all 0.3s ease;
        }

        .mini-table-row:hover {
            border-color: #007bff;
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.15);
        }

        .remove-row-btn {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: absolute;
            top: 10px;
            right: 10px;
        }

        .remove-row-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
        }

        .add-row-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .add-row-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(40, 167, 69, 0.2);
        }

        .rich-text-container {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            background: white;
            overflow: hidden;
            transition: border-color 0.3s ease;
        }

        .rich-text-container:focus-within {
            border-color: #007bff;
        }

        .ql-toolbar {
            border: none;
            border-bottom: 2px solid #e9ecef;
            background: #f8f9fa;
        }

        .ql-container {
            border: none;
            font-family: inherit;
        }

        .ql-editor {
            min-height: 150px;
            font-size: 14px;
            line-height: 1.6;
        }

        .format-toolbar {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 1px solid #dee2e6;
            border-radius: 8px 8px 0 0;
            padding: 10px 15px;
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .format-btn {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
        }

        .format-btn:hover {
            background: #e9ecef;
            transform: translateY(-1px);
        }

        .format-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .simple-editor {
            border: 1px solid #dee2e6;
            border-radius: 0 0 8px 8px;
            min-height: 100px;
            padding: 15px;
            font-family: inherit;
            font-size: 14px;
            line-height: 1.6;
            resize: vertical;
        }

        .simple-editor:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 0.25rem rgba(0, 123, 255, 0.25);
        }

        .sections-container {
            min-height: 200px;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 20px;
            background: #f8f9fa;
            position: relative;
        }

        .empty-sections-message {
            text-align: center;
            color: #6c757d;
            padding: 40px 20px;
        }

        .empty-sections-message i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .field-group {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .field-group:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transform: translateY(-2px);
        }

        .field-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .field-value {
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .action-buttons {
            background: #f8f9fa;
            padding: 25px 30px;
            border-top: 2px solid #e9ecef;
            display: flex;
            gap: 15px;
            align-items: center;
            margin-top: 30px;
            border-radius: 0 0 15px 15px;
        }

        .form-control {
            border-radius: 8px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        @media (max-width: 768px) {
            .dynamic-section {
                padding: 15px;
            }

            .section-controls {
                position: relative;
                top: auto;
                right: auto;
                justify-content: center;
                margin-bottom: 15px;
            }

            .section-type-badge {
                position: relative;
                top: auto;
                left: auto;
                display: inline-block;
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body class="bg-light">
<div sec:authorize="isAuthenticated()">
    <div class="container py-5">
        <div class="edit-container">
            <div class="edit-header">
                <h1>
                    <i class="bi bi-pencil-square"></i>
                    Edit Interest Rate
                    <span class="edit-badge">ID: [[${interestRate.id}]]</span>
                </h1>
                <p class="text-muted mt-2">Modify the interest rate details below and click "Update" to save changes</p>
            </div>

            <form class="form-container" id="editForm" method="post"
                  th:action="@{/interest-rate/update/{id}(id=${interestRate.id})}" th:object="${interestRate}">

                <!-- Basic Interest Rate Fields -->
                <div class="section-header">
                    <h5>
                        <i class="bi bi-info-circle-fill"></i>
                        Basic Information
                    </h5>
                </div>

                <div class="row g-3 mb-4" th:each="field : ${globalFields}">
                    <div class="col-md-6">
                        <div class="field-group">
                            <!-- Hidden field for fieldKey -->
                            <input type="hidden" th:name="${'fieldKey_' + field.id}" th:value="${field.fieldKey}" />

                            <label class="field-label" th:for="${'extra_' + field.id}">
                                <i class="bi bi-tag-fill"></i>
                                [[${field.label}]]
                                <span th:if="${field.atTable}" style="font-size: 0.8em;"> - At Table</span>
                                <span th:if="${field.atCompare}" style="font-size: 0.8em;"> - At Compare</span>
                            </label>
                            <div class="field-value"
                                 th:if="${fieldValues?.get(field.id) != null and !#strings.isEmpty(fieldValues.get(field.id))}">
                                Current value: <strong>[[${fieldValues.get(field.id)}]]</strong>
                            </div>
                            <input class="form-control"
                                   th:name="${'extra_' + field.id}"
                                   th:placeholder="${'Enter ' + field.label}"
                                   th:value="${fieldValues?.get(field.id) ?: ''}"
                                   type="text"/>
                        </div>
                    </div>
                </div>
                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <div class="field-group">
                            <label class="field-label" for="webLink">
                                <i class="bi bi-tag-fill"></i>
                                Web Link
                            </label>
                            <input class="form-control"
                                   id="webLink"
                                   placeholder="Enter link"
                                   th:field="*{webLink}"
                                   type="text"/>
                        </div>
                    </div>
                </div>

                <!-- Dynamic Sections -->
                <div class="section-header">
                    <h5>
                        <i class="bi bi-layers-fill"></i>
                        Additional Information Sections
                    </h5>
                </div>

                <div class="sections-container" id="sectionsContainer">
                    <!-- Existing Table Sections -->
                    <div th:if="${interestRate.moreInfo?.tableSections != null and !interestRate.moreInfo.tableSections.isEmpty()}">
                        <div class="dynamic-section" data-section-type="table"
                             th:attr="data-section-id='table_' + ${tableSection.sectionIdentifier}"
                             th:each="tableSection, iterStat : ${interestRate.moreInfo.tableSections}">
                            <div class="section-type-badge">
                                <i class="bi bi-table"></i> Table Section
                            </div>
                            <div class="section-controls">
                                <button class="remove-section-btn" onclick="removeSection(this)" title="Remove section"
                                        type="button">
                                    <i class="bi bi-x"></i>
                                </button>
                            </div>

                            <div style="margin-top: 40px;">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="bi bi-type-h1"></i>
                                        Table Title
                                    </label>
                                    <div class="field-value"
                                         th:if="${tableSection.title != null and !#strings.isEmpty(tableSection.title)}">
                                        Current: <strong>[[${tableSection.title}]]</strong>
                                    </div>
                                    <input class="form-control" placeholder="e.g. Interest Rate Details"
                                           th:name="'tableTitle_' + ${tableSection.sectionIdentifier}"
                                           th:value="${tableSection.title ?: ''}"
                                           type="text"/>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="bi bi-list-ul"></i>
                                        Table Rows
                                    </label>
                                    <div class="table-rows-container"
                                         th:attr="data-section=${tableSection.sectionIdentifier}">
                                        <div class="mini-table-row"
                                             th:each="row, rowStat : ${tableSection.miniTableRows}">
                                            <button class="remove-row-btn" onclick="removeTableRow(this)" title="Remove row"
                                                    type="button">
                                                <i class="bi bi-x"></i>
                                            </button>
                                            <div class="row g-3 align-items-start" style="margin-top: 20px;">
                                                <div class="col-md-3">
                                                    <label class="form-label small">Label</label>
                                                    <input class="form-control form-control-sm"
                                                           placeholder="Row label"
                                                           th:name="'tableRowLabels_' + ${tableSection.sectionIdentifier}"
                                                           th:value="${row.label ?: ''}"
                                                           type="text"/>
                                                </div>
                                                <div class="col-md-9">
                                                    <label class="form-label small">Description</label>
                                                    <div class="rich-text-row">
                                                        <div class="format-toolbar">
                                                            <button class="format-btn" onclick="formatText(this, 'bold')"
                                                                    title="Bold" type="button">
                                                                <i class="bi bi-type-bold"></i>
                                                            </button>
                                                            <button class="format-btn" onclick="formatText(this, 'italic')"
                                                                    title="Italic" type="button">
                                                                <i class="bi bi-type-italic"></i>
                                                            </button>
                                                            <button class="format-btn" onclick="formatText(this, 'underline')"
                                                                    title="Underline"
                                                                    type="button">
                                                                <i class="bi bi-type-underline"></i>
                                                            </button>
                                                            <span style="color: #6c757d; font-size: 12px;">Rich text formatting</span>
                                                        </div>
                                                        <div class="simple-editor"
                                                             contenteditable="true"
                                                             onblur="updateHiddenInput(this)"
                                                             onpaste="handlePaste(event)"
                                                             placeholder="Full text description with formatting..."
                                                             th:utext="${row.description ?: ''}"></div>
                                                        <input th:name="'tableRowDescriptions_' + ${tableSection.sectionIdentifier}"
                                                               th:value="${row.description ?: ''}"
                                                               type="hidden"/>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <button class="add-row-btn mt-2" onclick="addTableRowFromButton(this)"
                                            th:attr="data-section-id=${tableSection.sectionIdentifier}"
                                            type="button">
                                        <i class="bi bi-plus-circle"></i>
                                        Add Row
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Existing Text Sections -->
                    <div th:if="${interestRate.moreInfo?.textSections != null and !interestRate.moreInfo.textSections.isEmpty()}">
                        <div class="dynamic-section" data-section-type="text"
                             th:attr="data-section-id='text_' + ${textSection.sectionIdentifier}"
                             th:each="textSection, iterStat : ${interestRate.moreInfo.textSections}">
                            <div class="section-type-badge">
                                <i class="bi bi-text-paragraph"></i> Text Section
                            </div>
                            <div class="section-controls">
                                <button class="remove-section-btn" onclick="removeSection(this)" title="Remove section"
                                        type="button">
                                    <i class="bi bi-x"></i>
                                </button>
                            </div>

                            <div style="margin-top: 40px;">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="bi bi-type-h2"></i>
                                        Text Title
                                    </label>
                                    <div class="field-value"
                                         th:if="${textSection.title != null and !#strings.isEmpty(textSection.title)}">
                                        Current: <strong>[[${textSection.title}]]</strong>
                                    </div>
                                    <input class="form-control" placeholder="e.g. Additional Details"
                                           th:name="'textTitle_' + ${textSection.sectionIdentifier}"
                                           th:value="${textSection.title ?: ''}"
                                           type="text"/>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="bi bi-textarea-t"></i>
                                        Text Content
                                    </label>
                                    <div class="rich-text-container">
                                        <div style="min-height: 200px;"
                                             th:id="'textEditor_' + ${textSection.sectionIdentifier}"></div>
                                    </div>
                                    <textarea style="display: none;"
                                              th:name="'textContent_' + ${textSection.sectionIdentifier}" th:text="${textSection.content ?: ''}"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Empty message when no sections exist -->
                    <div class="empty-sections-message" id="emptySectionsMessage"
                         th:if="${interestRate.moreInfo == null or (interestRate.moreInfo.tableSections.isEmpty() and interestRate.moreInfo.textSections.isEmpty())}">
                        <i class="bi bi-plus-square"></i>
                        <h6>No sections added yet</h6>
                        <p>Click the buttons below to add table or text sections</p>
                    </div>
                </div>

                <!-- Add Section Buttons -->
                <div class="d-flex justify-content-center gap-3 my-4">
                    <button class="add-section-btn" onclick="addTableSection()" type="button">
                        <i class="bi bi-table"></i>
                        Add Table Section
                    </button>
                    <button class="add-section-btn" onclick="addTextSection()" type="button">
                        <i class="bi bi-text-paragraph"></i>
                        Add Text Section
                    </button>
                </div>

                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-success btn-lg" type="submit">
                        <i class="bi bi-check-circle"></i>
                        Update Interest Rate
                    </button>
                    <a class="btn btn-secondary btn-lg ms-2" th:href="@{/}">
                        <i class="bi bi-x-circle"></i>
                        Cancel
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>
<div sec:authorize="isAnonymous()">
    <script>
        window.location.href = '/';
    </script>
</div>
<script src="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.min.js"></script>
<script src="/js/dark-mode.js"></script>
<script>
    let sectionCounter = 1000;
    let quillEditors = new Map();

    document.getElementById('editForm')
        .addEventListener('submit', function (e) {
            console.log('=== FORM SUBMISSION STARTED ===');

            quillEditors.forEach((quill, counter) => {
                const textarea = document.querySelector(`textarea[name="textContent_${counter}"]`);
                if (textarea) {
                    textarea.value = quill.root.innerHTML;
                    console.log(`Updated Quill editor ${counter}:`, textarea.value.substring(0, 100) + '...');
                }
            });

            document.querySelectorAll('.simple-editor')
                .forEach(editor => {
                    updateHiddenInput(editor);
                });

            document.querySelectorAll('.dynamic-section[data-section-type="table"]')
                .forEach(section => {
                    const sectionId = section.dataset.sectionId.split('_')[1];
                    console.log(`\n=== PROCESSING TABLE SECTION: ${sectionId} ===`);

                    const labelInputs = section.querySelectorAll(`input[name="tableRowLabels_${sectionId}"]`);
                    console.log(`Found ${labelInputs.length} label inputs`);

                    const labels = [];
                    labelInputs.forEach((input, index) => {
                        console.log(`Label ${index} (${input.type}): "${input.value}"`);
                        if (input.value && input.value.trim()) {
                            if (input.value.includes('||')) {
                                const splitValues = input.value.split('||');
                                splitValues.forEach(val => {
                                    if (val.trim()) labels.push(val.trim());
                                });
                            } else {
                                labels.push(input.value.trim());
                            }
                        }
                    });

                    const descInputs = section.querySelectorAll(`input[name="tableRowDescriptions_${sectionId}"]`);
                    console.log(`Found ${descInputs.length} description inputs`);

                    const descriptions = [];
                    descInputs.forEach((input, index) => {
                        console.log(`Description ${index} (${input.type}): "${input.value}"`);
                        if (input.value && input.value.trim()) {
                            if (input.value.includes('||')) {
                                const splitValues = input.value.split('||');
                                splitValues.forEach(val => {
                                    if (val.trim()) descriptions.push(val.trim());
                                });
                            } else {
                                descriptions.push(input.value.trim());
                            }
                        }
                    });

                    console.log(`Collected ${labels.length} labels:`, labels);
                    console.log(`Collected ${descriptions.length} descriptions:`, descriptions);

                    labelInputs.forEach(input => input.remove());
                    descInputs.forEach(input => input.remove());

                    if (labels.length > 0) {
                        const labelsInput = document.createElement('input');
                        labelsInput.type = 'hidden';
                        labelsInput.name = `tableRowLabels_${sectionId}`;
                        labelsInput.value = labels.join('||');
                        section.appendChild(labelsInput);
                        console.log(`✓ Created combined labels input: "${labelsInput.value}"`);
                    }

                    if (descriptions.length > 0) {
                        const descriptionsInput = document.createElement('input');
                        descriptionsInput.type = 'hidden';
                        descriptionsInput.name = `tableRowDescriptions_${sectionId}`;
                        descriptionsInput.value = descriptions.join('||');
                        section.appendChild(descriptionsInput);
                        console.log(`✓ Created combined descriptions input: "${descriptionsInput.value}"`);
                    }
                });

            console.log('\n=== FINAL FORM DATA ===');
            const formData = new FormData(this);
            for (let [key, value] of formData.entries()) {
                if (key.includes('table')) {
                    console.log(`${key}: ${value}`);
                }
            }

            console.log('=== FORM SUBMISSION COMPLETE ===');
        });

    function addTextSection() {
        sectionCounter++;
        const sectionId = `text_${sectionCounter}`;
        const editorId = `textEditor_${sectionCounter}`;

        hideEmptyMessage();

        const sectionHtml = `
            <div class="dynamic-section" data-section-type="text" data-section-id="${sectionId}">
                <div class="section-type-badge">
                    <i class="bi bi-text-paragraph"></i> Text Section
                </div>
                <div class="section-controls">
                    <button type="button" class="remove-section-btn" onclick="removeSection(this)" title="Remove section">
                        <i class="bi bi-x"></i>
                    </button>
                </div>

                <div style="margin-top: 40px;">
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="bi bi-type-h2"></i>
                            Text Title
                        </label>
                        <input type="text" name="textTitle_${sectionCounter}" class="form-control"
                               placeholder="e.g. Additional Details" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="bi bi-textarea-t"></i>
                            Text Content
                        </label>
                        <div class="rich-text-container">
                            <div id="${editorId}" style="min-height: 200px;"></div>
                        </div>
                        <textarea name="textContent_${sectionCounter}" style="display: none;"></textarea>
                    </div>
                </div>
            </div>
        `;

        document.getElementById('sectionsContainer')
            .insertAdjacentHTML('beforeend', sectionHtml);

        const quill = new Quill(`#${editorId}`, {
            theme: 'snow',
            placeholder: 'Enter detailed content here. Use the toolbar to format your text...',
            modules: {
                toolbar: [
                    ['bold', 'italic', 'underline', 'strike'],
                    ['blockquote', 'code-block'],
                    [{ 'header': 1 }, { 'header': 2 }],
                    [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                    [{ 'script': 'sub' }, { 'script': 'super' }],
                    [{ 'indent': '-1' }, { 'indent': '+1' }],
                    [{ 'size': ['small', false, 'large', 'huge'] }],
                    [{ 'color': [] }, { 'background': [] }],
                    [{ 'align': [] }],
                    ['clean'],
                    ['link']
                ]
            }
        });

        quillEditors.set(sectionCounter, quill);

        quill.on('text-change', function () {
            const textarea = document.querySelector(`textarea[name="textContent_${sectionCounter}"]`);
            textarea.value = quill.root.innerHTML;
        });
    }

    function addTableSection() {
        sectionCounter++;
        const sectionId = `table_${sectionCounter}`;

        hideEmptyMessage();

        const sectionHtml = `
            <div class="dynamic-section" data-section-type="table" data-section-id="${sectionId}">
                <div class="section-type-badge">
                    <i class="bi bi-table"></i> Table Section
                </div>
                <div class="section-controls">
                    <button type="button" class="remove-section-btn" onclick="removeSection(this)" title="Remove section">
                        <i class="bi bi-x"></i>
                    </button>
                </div>

                <div style="margin-top: 40px;">
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="bi bi-type-h1"></i>
                            Table Title
                        </label>
                        <input type="text" name="tableTitle_${sectionCounter}" class="form-control"
                               placeholder="e.g. Interest Rate Details" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="bi bi-list-ul"></i>
                            Table Rows
                        </label>
                        <div class="table-rows-container" data-section="${sectionCounter}">
                            <div class="mini-table-row">
                                <button type="button" class="remove-row-btn" onclick="removeTableRow(this)" title="Remove row">
                                    <i class="bi bi-x"></i>
                                </button>
                                <div class="row g-3 align-items-start" style="margin-top: 20px;">
                                    <div class="col-md-3">
                                        <label class="form-label small">Label</label>
                                        <input type="text" name="tableRowLabels_${sectionCounter}" class="form-control form-control-sm" placeholder="Row label" />
                                    </div>
                                    <div class="col-md-9">
                                        <label class="form-label small">Description</label>
                                        <div class="rich-text-row">
                                            <div class="format-toolbar">
                                                <button type="button" class="format-btn" onclick="formatText(this, 'bold')" title="Bold">
                                                    <i class="bi bi-type-bold"></i>
                                                </button>
                                                <button type="button" class="format-btn" onclick="formatText(this, 'italic')" title="Italic">
                                                    <i class="bi bi-type-italic"></i>
                                                </button>
                                                <button type="button" class="format-btn" onclick="formatText(this, 'underline')" title="Underline">
                                                    <i class="bi bi-type-underline"></i>
                                                </button>
                                                <span style="color: #6c757d; font-size: 12px;">Rich text formatting</span>
                                            </div>
                                            <div class="simple-editor"
                                                 contenteditable="true"
                                                 placeholder="Full text description with formatting..."
                                                 onpaste="handlePaste(event)"
                                                 onblur="updateHiddenInput(this)"></div>
                                            <input type="hidden" name="tableRowDescriptions_${sectionCounter}" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="add-row-btn mt-2" onclick="addTableRow(${sectionCounter})">
                            <i class="bi bi-plus-circle"></i>
                            Add Row
                        </button>
                    </div>
                </div>
            </div>
        `;

        document.getElementById('sectionsContainer')
            .insertAdjacentHTML('beforeend', sectionHtml);
    }

    function addTableRow(sectionCounter) {
        console.log(`Adding table row to section ${sectionCounter}`);

        const container = document.querySelector(`[data-section="${sectionCounter}"]`);
        if (!container) {
            console.error(`Container not found for section ${sectionCounter}`);
            return;
        }

        const currentRows = container.querySelectorAll('.mini-table-row')
            .length;
        console.log(`Current rows in section ${sectionCounter}: ${currentRows}`);

        const newRowHtml = `
            <div class="mini-table-row">
                <button type="button" class="remove-row-btn" onclick="removeTableRow(this)" title="Remove row">
                    <i class="bi bi-x"></i>
                </button>
                <div class="row g-3 align-items-start" style="margin-top: 20px;">
                    <div class="col-md-3">
                        <label class="form-label small">Label</label>
                        <input type="text" name="tableRowLabels_${sectionCounter}" class="form-control form-control-sm" placeholder="Row label" />
                    </div>
                    <div class="col-md-9">
                        <label class="form-label small">Description</label>
                        <div class="rich-text-row">
                            <div class="format-toolbar">
                                <button type="button" class="format-btn" onclick="formatText(this, 'bold')" title="Bold">
                                    <i class="bi bi-type-bold"></i>
                                </button>
                                <button type="button" class="format-btn" onclick="formatText(this, 'italic')" title="Italic">
                                    <i class="bi bi-type-italic"></i>
                                </button>
                                <button type="button" class="format-btn" onclick="formatText(this, 'underline')" title="Underline">
                                    <i class="bi bi-type-underline"></i>
                                </button>
                                <span style="color: #6c757d; font-size: 12px;">Rich text formatting</span>
                            </div>
                            <div class="simple-editor"
                                 contenteditable="true"
                                 placeholder="Full text description with formatting..."
                                 onpaste="handlePaste(event)"
                                 onblur="updateHiddenInput(this)"></div>
                            <input type="hidden" name="tableRowDescriptions_${sectionCounter}" />
                        </div>
                    </div>
                </div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', newRowHtml);

        const newRowCount = container.querySelectorAll('.mini-table-row')
            .length;
        console.log(`After adding row, section ${sectionCounter} now has ${newRowCount} rows`);

        const allInputs = container.querySelectorAll('input');
        console.log(`All inputs in section ${sectionCounter}:`, Array.from(allInputs)
            .map(input => `${input.name} (${input.type})`));
    }

    function addTableRowFromButton(button) {
        const sectionId = button.getAttribute('data-section-id');
        console.log(`Adding row to existing section: ${sectionId}`);

        const section = button.closest('.dynamic-section');
        const container = section.querySelector('.table-rows-container');

        if (!container) {
            console.error(`Container not found for section ${sectionId}`);
            return;
        }

        const currentRows = container.querySelectorAll('.mini-table-row')
            .length;
        console.log(`Current rows in section ${sectionId}: ${currentRows}`);

        const newRowHtml = `
            <div class="mini-table-row">
                <button type="button" class="remove-row-btn" onclick="removeTableRow(this)" title="Remove row">
                    <i class="bi bi-x"></i>
                </button>
                <div class="row g-3 align-items-start" style="margin-top: 20px;">
                    <div class="col-md-3">
                        <label class="form-label small">Label</label>
                        <input type="text" name="tableRowLabels_${sectionId}" class="form-control form-control-sm" placeholder="Row label" />
                    </div>
                    <div class="col-md-9">
                        <label class="form-label small">Description</label>
                        <div class="rich-text-row">
                            <div class="format-toolbar">
                                <button type="button" class="format-btn" onclick="formatText(this, 'bold')" title="Bold">
                                    <i class="bi bi-type-bold"></i>
                                </button>
                                <button type="button" class="format-btn" onclick="formatText(this, 'italic')" title="Italic">
                                    <i class="bi bi-type-italic"></i>
                                </button>
                                <button type="button" class="format-btn" onclick="formatText(this, 'underline')" title="Underline">
                                    <i class="bi bi-type-underline"></i>
                                </button>
                                <span style="color: #6c757d; font-size: 12px;">Rich text formatting</span>
                            </div>
                            <div class="simple-editor"
                                 contenteditable="true"
                                 placeholder="Full text description with formatting..."
                                 onpaste="handlePaste(event)"
                                 onblur="updateHiddenInput(this)"></div>
                            <input type="hidden" name="tableRowDescriptions_${sectionId}" />
                        </div>
                    </div>
                </div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', newRowHtml);

        const newRowCount = container.querySelectorAll('.mini-table-row')
            .length;
        console.log(`After adding row, section ${sectionId} now has ${newRowCount} rows`);
    }

    function removeSection(button) {
        const section = button.closest('.dynamic-section');
        const sectionId = section.dataset.sectionId;

        if (sectionId && sectionId.startsWith('text_')) {
            const counter = sectionId.split('_')[1];
            quillEditors.delete(parseInt(counter));
        }

        section.remove();

        if (document.querySelectorAll('.dynamic-section')
            .length === 0) {
            showEmptyMessage();
        }
    }

    function removeTableRow(button) {
        const container = button.closest('.table-rows-container');
        const rows = container.querySelectorAll('.mini-table-row');

        if (rows.length > 1) {
            button.closest('.mini-table-row')
                .remove();
        } else {
            alert('At least one row is required per table section');
        }
    }

    function hideEmptyMessage() {
        const emptyMessage = document.getElementById('emptySectionsMessage');
        if (emptyMessage) {
            emptyMessage.style.display = 'none';
        }
    }

    function showEmptyMessage() {
        const emptyMessage = document.getElementById('emptySectionsMessage');
        if (emptyMessage) {
            emptyMessage.style.display = 'block';
        }
    }

    function formatText(button, command) {
        const editor = button.closest('.rich-text-row')
            .querySelector('.simple-editor');
        editor.focus();
        document.execCommand(command, false, null);
        button.classList.toggle('active');
        updateHiddenInput(editor);
    }

    function handlePaste(event) {
        event.preventDefault();
        const text = (event.originalEvent || event)
            .clipboardData.getData('text/plain');
        document.execCommand('insertText', false, text);
    }

    function updateHiddenInput(editor) {
        const hiddenInput = editor.parentElement.querySelector('input[type="hidden"]');
        if (hiddenInput) {
            hiddenInput.value = editor.innerHTML;
        }
    }

    document.addEventListener('DOMContentLoaded', function () {

        const existingTextSections = document.querySelectorAll('[data-section-type="text"]');
        existingTextSections.forEach(section => {
            const sectionId = section.dataset.sectionId;
            if (sectionId) {
                const identifier = sectionId.split('_')[1];
                const editorElement = document.getElementById(`textEditor_${identifier}`);
                const textareaElement = document.querySelector(`textarea[name="textContent_${identifier}"]`);

                if (editorElement && textareaElement) {
                    const quill = new Quill(`#textEditor_${identifier}`, {
                        theme: 'snow',
                        placeholder: 'Enter detailed content here. Use the toolbar to format your text...',
                        modules: {
                            toolbar: [
                                ['bold', 'italic', 'underline', 'strike'],
                                ['blockquote', 'code-block'],
                                [{ 'header': 1 }, { 'header': 2 }],
                                [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                                [{ 'script': 'sub' }, { 'script': 'super' }],
                                [{ 'indent': '-1' }, { 'indent': '+1' }],
                                [{ 'size': ['small', false, 'large', 'huge'] }],
                                [{ 'color': [] }, { 'background': [] }],
                                [{ 'align': [] }],
                                ['clean'],
                                ['link']
                            ]
                        }
                    });

                    if (textareaElement.value) {
                        quill.root.innerHTML = textareaElement.value;
                    }

                    quillEditors.set(identifier, quill);

                    quill.on('text-change', function () {
                        textareaElement.value = quill.root.innerHTML;
                    });
                }
            }
        });

        document.addEventListener('input', function (e) {
            if (e.target.classList.contains('simple-editor')) {
                updateHiddenInput(e.target);
            }
        });

        document.querySelectorAll('.simple-editor')
            .forEach(editor => {
                updateHiddenInput(editor);
            });

        const existingSections = document.querySelectorAll('.dynamic-section');
        if (existingSections.length > 0) {
            hideEmptyMessage();
        }
    });

    // Image Upload Component
    class ImageUploadManager {
        constructor() {
            this.maxFileSize = 5 * 1024 * 1024; // 5MB
            this.allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
            this.setupImageUploadFields();
        }

        setupImageUploadFields() {
            document.addEventListener('DOMContentLoaded', () => {
                this.initializeImageFields();
            });
        }

        initializeImageFields() {
            // Find all image field inputs
            const imageFields = document.querySelectorAll('input[name^="extra_"]:not([data-image-initialized])');

            imageFields.forEach(input => {
                const fieldName = input.getAttribute('name');
                // Check if this is the image field (assuming field ID 2 for image field)
                if (this.isImageField(input)) {
                    this.convertToImageUpload(input);
                    input.setAttribute('data-image-initialized', 'true');
                }
            });
        }

        isImageField(input) {
            // Get the fieldKey from the hidden input field
            const fieldGroup = input.closest('.field-group');
            const hiddenFieldKey = fieldGroup?.querySelector('input[type="hidden"][name*="fieldKey_"]');
            const fieldKey = hiddenFieldKey?.value?.toLowerCase() || '';

            const placeholder = input.getAttribute('placeholder')?.toLowerCase() || '';

            return fieldKey.includes('img') || placeholder.includes('image') ||
                   fieldKey.includes('photo') || placeholder.includes('photo') ||
                   fieldKey.includes('picture') || placeholder.includes('picture');
        }

        convertToImageUpload(originalInput) {
            const fieldGroup = originalInput.closest('.field-group');
            if (!fieldGroup) return;

            // Create image upload container
            const uploadContainer = document.createElement('div');
            uploadContainer.className = 'image-upload-container';
            uploadContainer.innerHTML = this.createImageUploadHTML(originalInput.getAttribute('name'));

            // Replace the original input
            originalInput.style.display = 'none';
            fieldGroup.appendChild(uploadContainer);

            // Setup event listeners
            this.setupImageUploadEvents(uploadContainer, originalInput);
        }

        createImageUploadHTML(fieldName) {
            return `
                <div class="image-upload-area" data-field="${fieldName}">
                    <div class="upload-zone" onclick="triggerFileInput('${fieldName}')">
                        <div class="upload-placeholder">
                            <i class="bi bi-cloud-upload" style="font-size: 2rem; color: #6c757d;"></i>
                            <p class="mb-1">Click to upload image</p>
                            <small class="text-muted">PNG, JPG, GIF up to 5MB</small>
                        </div>
                        <div class="image-preview" style="display: none;">
                            <img src="" alt="Preview" class="preview-image">
                            <div class="image-overlay">
                                <button type="button" class="btn btn-sm btn-danger remove-image" onclick="removeImage('${fieldName}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <input type="file" id="file-${fieldName}" accept="image/*" style="display: none;" onchange="handleImageUpload(event, '${fieldName}')">
                    <div class="upload-progress" style="display: none;">
                        <div class="progress">
                            <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            `;
        }

        setupImageUploadEvents(container, originalInput) {
            const fieldName = originalInput.getAttribute('name');
            const fileInput = container.querySelector(`#file-${fieldName}`);
            const uploadZone = container.querySelector('.upload-zone');
            const imagePreview = container.querySelector('.image-preview');
            const placeholder = container.querySelector('.upload-placeholder');

            // Drag and drop functionality
            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('drag-over');
            });

            uploadZone.addEventListener('dragleave', () => {
                uploadZone.classList.remove('drag-over');
            });

            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('drag-over');

                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    this.processImageFile(files[0], fieldName, originalInput);
                }
            });

            // Load existing image if present
            const existingValue = originalInput.value;
            if (existingValue && existingValue.startsWith('/images/')) {
                this.showImagePreview(existingValue, container);
            }
        }

        async processImageFile(file, fieldName, originalInput) {
            if (!this.validateImageFile(file)) {
                return;
            }

            const container = document.querySelector(`[data-field="${fieldName}"]`);
            const progressContainer = container.querySelector('.upload-progress');
            const progressBar = container.querySelector('.progress-bar');

            try {
                // Show progress
                progressContainer.style.display = 'block';
                progressBar.style.width = '0%';

                // Create FormData
                const formData = new FormData();
                formData.append('file', file);

                // Upload file
                const response = await fetch('/api/files/upload-image', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    // Update progress
                    progressBar.style.width = '100%';

                    // Update original input with file path
                    originalInput.value = result.path;

                    // Show image preview
                    this.showImagePreview(result.path, container);

                    // Hide progress after a short delay
                    setTimeout(() => {
                        progressContainer.style.display = 'none';
                    }, 1000);

                    this.showNotification('Image uploaded successfully', 'success');
                } else {
                    throw new Error(result.message);
                }

            } catch (error) {
                console.error('Upload error:', error);
                this.showNotification(error.message || 'Failed to upload image', 'error');
                progressContainer.style.display = 'none';
            }
        }

        showImagePreview(imagePath, container) {
            const placeholder = container.querySelector('.upload-placeholder');
            const imagePreview = container.querySelector('.image-preview');
            const previewImg = container.querySelector('.preview-image');

            previewImg.src = imagePath;
            placeholder.style.display = 'none';
            imagePreview.style.display = 'block';
        }

        hideImagePreview(container) {
            const placeholder = container.querySelector('.upload-placeholder');
            const imagePreview = container.querySelector('.image-preview');

            placeholder.style.display = 'block';
            imagePreview.style.display = 'none';
        }

        validateImageFile(file) {
            if (!this.allowedTypes.includes(file.type)) {
                this.showNotification('Please select a valid image file (PNG, JPG, GIF)', 'error');
                return false;
            }

            if (file.size > this.maxFileSize) {
                this.showNotification('File size must be less than 5MB', 'error');
                return false;
            }

            return true;
        }

        showNotification(message, type = 'info') {
            // Create notification element if it doesn't exist
            let notification = document.getElementById('upload-notification');
            if (!notification) {
                notification = document.createElement('div');
                notification.id = 'upload-notification';
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    z-index: 9999;
                    padding: 12px 20px;
                    border-radius: 4px;
                    color: white;
                    font-weight: 500;
                    opacity: 0;
                    transition: opacity 0.3s ease;
                `;
                document.body.appendChild(notification);
            }

            // Set message and style
            notification.textContent = message;
            notification.className = `alert alert-${type === 'error' ? 'danger' : 'success'}`;
            notification.style.backgroundColor = type === 'error' ? '#dc3545' : '#28a745';
            notification.style.opacity = '1';

            // Hide after 3 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
            }, 3000);
        }
    }

    // Global functions for onclick handlers
    function triggerFileInput(fieldName) {
        document.getElementById(`file-${fieldName}`).click();
    }

    function handleImageUpload(event, fieldName) {
        const file = event.target.files[0];
        if (file) {
            const originalInput = document.querySelector(`input[name="${fieldName}"]`);
            imageUploadManager.processImageFile(file, fieldName, originalInput);
        }
    }

    function removeImage(fieldName) {
        const originalInput = document.querySelector(`input[name="${fieldName}"]`);
        const container = document.querySelector(`[data-field="${fieldName}"]`);

        // Clear the original input
        originalInput.value = '';

        // Hide image preview
        imageUploadManager.hideImagePreview(container);

        imageUploadManager.showNotification('Image removed', 'success');
    }

    // Initialize when page loads
    const imageUploadManager = new ImageUploadManager();
</script>
</body>
</html>