<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interest Rate Offers</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/index.css">
</head>
<body class="bg-light" th:classappend="${#authorization.expression('isAuthenticated()')} ? 'authenticated' : 'guest'">
<div class="container py-4">

    <!-- Authentication Status Section -->
    <div sec:authorize="isAuthenticated()" class="auth-section">
        <div class="user-info">
            <div>
                <strong>Welcome, <span sec:authentication="name">User</span>!</strong>
                <span class="text-muted">• Administrator Mode</span>
            </div>
            <div>
                <a href="/admin/users" class="btn btn-outline-secondary btn-sm">Admin Dashboard</a>
            </div>
            <div>
                <a href="/" class="btn btn-outline-secondary btn-sm">How users see the page</a>
            </div>
            <div>
                <a href="/logout" class="btn btn-outline-secondary btn-sm">Logout</a>
            </div>
        </div>
    </div>

    <!-- Guest Notice -->
    <div sec:authorize="!isAuthenticated()" class="guest-notice">
        <div class="alert-heading"><strong>👁️ Read-Only Mode</strong></div>
        <p class="mb-2">You are viewing this page as a guest. All data is read-only.</p>
        <p class="mb-0">
            <a href="/login" class="btn btn-primary btn-sm me-2">Login</a>
            <a href="/register" class="btn btn-outline-primary btn-sm">Register</a>
            to access administrative features.
        </p>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
        <div class="d-flex align-items-center flex-wrap">
            <h2 class="me-3 mb-2 mb-md-0">Interest Rate Offers</h2>
            <!-- Admin-only order change indicator -->
            <span class="order-changed-indicator admin-only" id="orderChangedIndicator">
                Order changed - click save to persist
            </span>
            <button class="save-order-btn admin-only" id="saveOrderBtn" onclick="saveColumnOrder()">
                Save Order
            </button>
        </div>
        <!-- Admin-only add button -->
        <a class="btn btn-primary mt-2 mt-md-0 admin-only" href="/interest-rate/new" sec:authorize="isAuthenticated()">+ Add New Interest Rate</a>
    </div>

    <!-- Filter Section HTML -->
    <div class="filter-section" id="filterSection">
        <div class="filter-toggle" id="filterToggle" onclick="toggleFilters()">
            <h5>
                🔍 Filters
                <span class="filter-summary" id="filterSummary">Click to add filters</span>
            </h5>
            <span class="chevron">▼</span>
        </div>

        <div class="filter-content" id="filterContent">
            <!-- Active Filters Tags -->
            <div class="active-filters" id="activeFilters">
                <!-- Active filter tags will be populated here -->
            </div>

            <!-- Filter Grid -->
            <div class="filter-grid" id="filterGrid">
                <!-- Filter items will be populated here -->
            </div>

            <!-- Filter Actions -->
            <div class="filter-actions">
                <button class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
                <button class="btn btn-secondary" onclick="clearAllFilters()">Clear All</button>
                <button class="btn btn-outline-secondary" onclick="toggleFilters()">Close</button>
            </div>
        </div>
    </div>

    <!-- Admin-only form to add global fields -->
    <form class="mb-4 admin-only" method="post" th:action="@{/fields/add}" th:object="${newField}" sec:authorize="isAuthenticated()">
        <div class="row g-2">
            <div class="col-md-6 col-lg-4">
                <input class="form-control" placeholder="Label (e.g. Max Deposit)" th:field="*{label}"/>
            </div>
            <div class="col-md-6 col-lg-4">
                <button class="btn btn-primary w-100">Add Field</button>
            </div>
        </div>
    </form>

    <!-- View Toggle for Mobile -->
    <div class="view-toggle d-md-none">
        <div class="btn-group" role="group" aria-label="View toggle">
            <button type="button" class="btn btn-outline-primary active" id="stackedView">
                📱 Card View
            </button>
            <button type="button" class="btn btn-outline-primary" id="scrollView">
                📊 Table View
            </button>
        </div>
    </div>

    <!-- Pagination Controls - Top -->
    <div class="pagination-container">
        <div class="pagination-info">
            <div class="results-info" id="resultsInfo">
                Showing 1-5 of 25 results
            </div>
            <div class="page-size-selector">
                <label for="pageSize">Show:</label>
                <select id="pageSize" onchange="changePageSize(this.value)">
                    <option value="5" selected>5 per page</option>
                    <option value="10">10 per page</option>
                    <option value="25">25 per page</option>
                    <option value="50">50 per page</option>
                </select>
            </div>
        </div>

        <div class="pagination-controls">
            <div class="quick-nav">
                <button class="page-btn" id="firstPageBtn" onclick="goToPage(1)" title="First page">⏮</button>
                <button class="page-btn" id="prevPageBtn" onclick="goToPage(currentPage - 1)" title="Previous page">‹</button>
            </div>

            <div id="pageNumbers" class="quick-nav">
                <!-- Page numbers will be generated here -->
            </div>

            <div class="quick-nav">
                <button class="page-btn" id="nextPageBtn" onclick="goToPage(currentPage + 1)" title="Next page">›</button>
                <button class="page-btn" id="lastPageBtn" onclick="goToPage(totalPages)" title="Last page">⏭</button>
            </div>

            <div class="pagination-jump">
                <span>Go to:</span>
                <input type="number" id="pageJumpInput" class="page-input" min="1" placeholder="1">
                <button class="page-btn" onclick="jumpToPage()">Go</button>
            </div>
        </div>
    </div>

    <div class="card border-light mb-3">
        <div class="card-body py-2">
            <small class="text-muted">
                <i class="fas fa-info-circle me-1"></i>
                <span th:text="${lastUpdateMessage}"></span>
            </small>
        </div>
    </div>

    <div class="table-container">
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-spinner"></div>
        </div>

        <div class="scroll-indicator" id="scrollIndicator">← Scroll horizontally to see more →</div>

        <div class="table-responsive" id="tableContainer">
            <table class="table table-sm" id="mainTable">
                <thead class="table">
                <tr id="column-header-row">
                    <th th:each="field, iterStat : ${globalFields}"
                        th:class="${#authorization.expression('isAuthenticated()')} ? 'draggable-column sortable' : 'sortable'"
                        th:draggable="${#authorization.expression('isAuthenticated()')}"
                        th:attr="ondragend=${#authorization.expression('isAuthenticated()')} ? 'handleDragEnd(event)' : null,
                                 ondragover=${#authorization.expression('isAuthenticated()')} ? 'handleDragOver(event)' : null,
                                 ondragstart=${#authorization.expression('isAuthenticated()')} ? 'handleDragStart(event)' : null,
                                 ondrop=${#authorization.expression('isAuthenticated()')} ? 'handleDrop(event)' : null"
                        onclick="sortTable(this, event)"
                        th:data-field-id="${field.id}"
                        th:data-field-key="${field.fieldKey}"
                        th:data-column-index="${iterStat.index}">

                        <!-- Admin-only drag handle -->
                        <div class="drag-handle admin-only" sec:authorize="isAuthenticated()">⋮⋮</div>

                        <div class="header-container">
                            <span class="header-text" th:text="${field.label}"></span>
                            <!-- Admin-only edit and delete buttons -->
                            <button class="edit-header-btn admin-only"
                                    th:onclick="'showEditForm(' + ${field.id} + ')'"
                                    type="button"
                                    sec:authorize="isAuthenticated()">
                                ✎
                            </button>
                            <button class="delete-field-btn admin-only"
                                    th:data-id="${field.id}"
                                    th:data-label="${field.label}"
                                    onclick="handleFieldDeleteClick(this)"
                                    type="button"
                                    title="Delete this field"
                                    sec:authorize="isAuthenticated()">
                                🗑
                            </button>

                            <!-- Admin-only edit form -->
                            <div class="header-edit-form admin-only" th:id="'editForm_' + ${field.id}" sec:authorize="isAuthenticated()">
                                <form method="post" th:action="@{/fields/update}">
                                    <input name="fieldId" th:value="${field.id}" type="hidden"/>

                                    <div class="form-row">
                                        <label>Display Label:</label>
                                        <input name="label" required th:value="${field.label}" type="text"/>
                                    </div>

                                    <div class="form-buttons">
                                        <button class="save-btn" type="submit">Save</button>
                                        <button class="cancel-btn" th:onclick="'hideEditForm(' + ${field.id} + ')'"
                                                type="button">Cancel
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </th>
                    <th class="no-drag">Actions</th>
                </tr>
                </thead>

                <tbody id="tableBody">
                <!-- Data rows will be populated by JavaScript -->
                </tbody>
            </table>

            <!-- Empty state -->
            <div class="empty-state" id="emptyState" style="display: none;">
                <div>📊</div>
                <h5>No interest rates found</h5>
                <p>Try adjusting your search criteria or add a new interest rate.</p>
            </div>
        </div>
    </div>

    <!-- Pagination Controls - Bottom -->
    <div class="pagination-container">
        <div class="pagination-info">
            <div class="results-info" id="resultsInfoBottom">
                Showing 1-5 of 25 results
            </div>
        </div>

        <div class="pagination-controls">
            <div class="quick-nav">
                <button class="page-btn" onclick="goToPage(1)" title="First page">⏮</button>
                <button class="page-btn" onclick="goToPage(currentPage - 1)" title="Previous page">‹</button>
            </div>

            <div id="pageNumbersBottom" class="quick-nav">
                <!-- Page numbers will be generated here -->
            </div>

            <div class="quick-nav">
                <button class="page-btn" onclick="goToPage(currentPage + 1)" title="Next page">›</button>
                <button class="page-btn" onclick="goToPage(totalPages)" title="Last page">⏭</button>
            </div>
        </div>
    </div>
</div>

<!-- Admin-only modals -->
<div sec:authorize="isAuthenticated()">
    <!-- Field Delete Confirmation Modal -->
    <div class="delete-confirmation-modal" id="fieldDeleteConfirmationModal">
        <div class="delete-confirmation-content">
            <h5>⚠️ Delete Field</h5>
            <div class="field-info">
                <p><strong>Field:</strong> <span id="fieldToDeleteName">Field Name</span></p>
                <p><strong>ID:</strong> <span id="fieldToDeleteId">Field ID</span></p>
            </div>
            <p>Are you sure you want to delete this field (column)?</p>
            <div class="warning-text">
                ⚠️ This will permanently remove the field and ALL associated data for every interest rate!
            </div>
            <p><strong>This action cannot be undone.</strong></p>

            <div class="delete-confirmation-buttons">
                <button class="btn btn-danger" id="confirmFieldDeleteBtn">Yes, Delete Field</button>
                <button class="btn btn-secondary" onclick="hideFieldDeleteConfirmation()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Interest Rate Delete Confirmation Modal -->
    <div class="delete-confirmation-modal" id="deleteConfirmationModal">
        <div class="delete-confirmation-content">
            <h5>⚠️ Confirm Deletion</h5>
            <p>Are you sure you want to delete this interest rate?</p>
            <p><strong>This action cannot be undone.</strong></p>

            <div class="delete-confirmation-buttons">
                <button class="btn btn-danger" id="confirmDeleteBtn">Yes, Delete</button>
                <button class="btn btn-secondary" onclick="hideDeleteConfirmation()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Drop indicator -->
    <div class="drop-indicator" id="dropIndicator"></div>

    <!-- Delete notification -->
    <div class="delete-notification" id="deleteNotification">
        Action completed successfully!
    </div>
</div>

<!-- Include jQuery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script th:inline="javascript">
    // ============================================================================
    // GLOBAL VARIABLES AND STATE
    // ============================================================================

    // Add authentication state to JavaScript
    const isAuthenticated = /*[[${#authorization.expression('isAuthenticated()')}]]*/ false;

    // Global pagination variables
    let currentPage = /*[[${currentPage}]]*/ 1;
    let pageSize = /*[[${pageSize}]]*/ 5;
    let totalRecords = /*[[${totalElements}]]*/ 0;
    let totalPages = /*[[${totalPages}]]*/ 0;
    let currentSortColumn = /*[[${sortBy}]]*/ 'id';
    let currentSortDirection = /*[[${sortDir}]]*/ 'asc';
    let currentSearchTerm = /*[[${search}]]*/ '';

    // Server data
    let serverRateFieldValuesMap = /*[[${rateFieldValuesMap}]]*/ {};
    let globalFieldsCache = /*[[${globalFields}]]*/ [];
    let currentPageData = /*[[${interestRates}]]*/ [];

    // UI state variables
    let isLoading = false;
    let currentExpandedCard = null;
    let currentEditForm = null;
    let draggedElement = null;
    let orderChanged = false;
    let originalOrder = [];
    let pendingDeleteId = null;
    let pendingFieldDeleteId = null;
    let draggedSection = null;
    let currentRateId = null;

    // ============================================================================
    // INITIALIZATION AND DOCUMENT READY
    // ============================================================================

    document.addEventListener('DOMContentLoaded', function () {
        // Initialize pagination with server data
        initializePagination();

        if (isAuthenticated) {
            captureOriginalOrder();
        }

        initializeSortableHeaders();
        initializeSearch();

        // Render the initial data from server
        renderInitialData();
        initializeMobileScrolling();
    });

    document.addEventListener('DOMContentLoaded', function () {
        const stackedViewBtn = document.getElementById('stackedView');
        const scrollViewBtn = document.getElementById('scrollView');
        const tableContainer = document.getElementById('tableContainer');

        if (stackedViewBtn && scrollViewBtn && tableContainer) {
            stackedViewBtn.addEventListener('click', function () {
                stackedViewBtn.classList.add('active');
                scrollViewBtn.classList.remove('active');
                tableContainer.classList.add('mobile-stack');
            });

            scrollViewBtn.addEventListener('click', function () {
                scrollViewBtn.classList.add('active');
                stackedViewBtn.classList.remove('active');
                tableContainer.classList.remove('mobile-stack');
            });
        }
    });

    function initializePagination() {
        // Set pagination controls based on server data
        updatePaginationControls();
        updatePaginationInfo();

        // Set initial page size selector
        const pageSizeSelect = document.getElementById('pageSize');
        if (pageSizeSelect) {
            pageSizeSelect.value = pageSize;
        }
    }

    function initializeSortableHeaders() {
        const headers = document.querySelectorAll('.draggable-column, .sortable');
        headers.forEach(header => {
            header.classList.add('sortable');
        });
    }

    function initializeSearch() {
        // Create search input if it doesn't exist
        let searchContainer = document.querySelector('.search-container');
        if (!searchContainer) {
            searchContainer = document.createElement('div');
            searchContainer.className = 'search-container mb-3';
            searchContainer.innerHTML = `
                <div class="row g-2">
                    <div class="col-md-6">
                        <div class="input-group">
                           <input type="text" class="form-control" id="searchInput"
                               placeholder="Search interest rates..."
                               th:value="${currentSearchTerm != null} ? ${currentSearchTerm} : ''" />
                            <button class="btn btn-outline-secondary" type="button" onclick="performSearch()">
                                🔍 Search
                            </button>
                            <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">
                                ✕ Clear
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // Insert after the view toggle or before the pagination
            const viewToggle = document.querySelector('.view-toggle');
            const paginationTop = document.querySelector('.pagination-container');
            if (viewToggle) {
                viewToggle.parentNode.insertBefore(searchContainer, viewToggle.nextSibling);
            } else if (paginationTop) {
                paginationTop.parentNode.insertBefore(searchContainer, paginationTop);
            }
        }

        // Add enter key support
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });
        }
    }

    window.addEventListener("load", () => {
        const emptyState = document.getElementById("emptyState");

        if (emptyState && emptyState.style.display !== "none") {
            const params = new URLSearchParams(window.location.search);
            let page = parseInt(params.get("page") || "1", 10);

            if (page >= 1) {
                params.set("page", page - 1);
                window.location.href = `/?${params.toString()}`;
            }
        }
    });

    // ============================================================================
    // DATA LOADING AND API CALLS
    // ============================================================================

    function renderInitialData() {
        // Render the data that was already loaded from server
        renderTableData(currentPageData);
    }

    // Load page from server - this is the main pagination function
    function loadPageFromServer(page, searchTerm = '', sortBy = null, sortDir = null) {
        if (isLoading) return;

        showLoading();

        const params = new URLSearchParams({
            page: page - 1, // Convert to 0-based for backend
            size: pageSize,
            sortBy: sortBy || currentSortColumn,
            sortDir: sortDir || currentSortDirection
        });

        if (searchTerm && searchTerm.trim()) {
            params.append('search', searchTerm.trim());
        }

        // Use the correct endpoint that matches your controller
        fetch(`/api/interest-rates?${params.toString()}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch data');
                }
                return response.json();
            })
            .then(data => {
                // Update all pagination state
                currentPage = page;
                totalPages = data.totalPages;
                totalRecords = data.totalElements;
                currentSearchTerm = searchTerm || '';

                // Update sort state if provided
                if (sortBy) currentSortColumn = sortBy;
                if (sortDir) currentSortDirection = sortDir;

                // Update data arrays
                currentPageData = data.content;
                serverRateFieldValuesMap = data.rateFieldValuesMap;

                // Render the new data
                renderTableData(data.content);
                updatePaginationControls();
                updatePaginationInfo();
                hideLoading();

                // Close any expanded cards when changing pages
                if (currentExpandedCard) {
                    closeExpandedCard(currentExpandedCard);
                }

                // Update URL without page reload (optional)
                updateBrowserUrl(page, searchTerm, sortBy, sortDir);
            })
            .catch(error => {
                console.error('Error loading page:', error);
                showDeleteNotification('Error loading data: ' + error.message, true);
                hideLoading();
            });
    }

    function fetchRateDetails(rateId) {
        return fetch(`/api/interest-rate/${rateId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch rate details');
                }
                return response.json();
            })
            .catch(error => {
                console.error('Error fetching rate details:', error);
                showDeleteNotification('Error loading rate details: ' + error.message, true);
                return null;
            });
    }

    function updateFieldValueAjax(rateId, fieldId, value) {
        if (!isAuthenticated) {
            showDeleteNotification('You must be logged in to make changes.', true);
            return;
        }

        const formData = new FormData();
        formData.append('rateId', rateId);
        formData.append('fieldId', fieldId);
        formData.append('value', value);

        fetch('/field-values/update', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to update field value');
                }
                // Update local cache
                if (!serverRateFieldValuesMap[rateId]) {
                    serverRateFieldValuesMap[rateId] = {};
                }
                serverRateFieldValuesMap[rateId][fieldId] = value;
            })
            .catch(error => {
                console.error('Error updating field value:', error);
                showDeleteNotification('Error updating field value: ' + error.message, true);
            });
    }

    // ============================================================================
    // TABLE RENDERING AND DATA DISPLAY
    // ============================================================================

    function renderTableData(data) {
        const tbody = document.getElementById('tableBody');
        const emptyState = document.getElementById('emptyState');

        if (!data || data.length === 0) {
            tbody.innerHTML = '';
            emptyState.style.display = 'block';
            return;
        }

        emptyState.style.display = 'none';
        renderTableRows(data, tbody);
    }

    function renderTableRows(data, tbody) {
        if (!data || data.length === 0) {
            tbody.innerHTML = '';
            return;
        }

        tbody.innerHTML = data.map(rate => {
            // Get current field order from headers (this is the key part)
            const headers = document.querySelectorAll('.draggable-column, .sortable');
            const currentFieldOrder = Array.from(headers)
                .map(header => ({
                    id: header.dataset.fieldId,
                    fieldKey: header.dataset.fieldKey,
                    label: header.querySelector('.header-text').textContent.trim()
                }));

            // Generate cells in the new column order
            const fieldCells = currentFieldOrder.map(field => {
                const fieldValue = serverRateFieldValuesMap[rate.id]?.[field.id] || '';

    if (field.fieldKey && field.fieldKey.toLowerCase().includes('img')) {
        if (isAuthenticated) {
            return `
                <td class="data-cell image-cell" data-field-id="${field.id}" data-label="${field.label}">
                    <div class="image-container clickable-image" onclick="showImageUpload(${rate.id}, ${field.id}, '${fieldValue}', this)">
                        ${fieldValue ? `<img src="${fieldValue}" alt="Interest Rate Logo" class="interest-rate-logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />` : ''}
                        <div class="no-image-placeholder" style="${fieldValue ? 'display:none' : 'display:block'}">
                            <span>No Image</span>
                            <small>Click to upload</small>
                        </div>
                    </div>
                    <div class="image-upload-overlay" id="imageUpload_${rate.id}_${field.id}" style="display: none;">
                        <form class="image-upload-form" onsubmit="uploadImage(event, ${rate.id}, ${field.id}, this)" enctype="multipart/form-data">
                            <div class="upload-area">
                                <input type="file"
                                       accept="image/*"
                                       class="file-input"
                                       id="fileInput_${rate.id}_${field.id}"
                                       onchange="previewImage(this, ${rate.id}, ${field.id})" />
                                <label for="fileInput_${rate.id}_${field.id}" class="upload-label">
                                    <div class="upload-icon">📁</div>
                                    <span>Choose Image</span>
                                </label>
                            </div>
                            <div class="image-preview" id="preview_${rate.id}_${field.id}" style="display: none;">
                                <img src="" alt="Preview" />
                            </div>
                            <div class="upload-buttons">
                                <button type="submit" class="btn btn-success btn-sm" disabled id="uploadBtn_${rate.id}_${field.id}">Upload</button>
                                ${fieldValue ? `<button type="button" class="btn btn-danger btn-sm" onclick="deleteImage(${rate.id}, ${field.id})">Delete</button>` : ''}
                                <button type="button" class="btn btn-secondary btn-sm" onclick="cancelImageUpload(${rate.id}, ${field.id})">Cancel</button>
                            </div>
                        </form>
                    </div>
                </td>
            `;
        } else {
            return `
                <td class="data-cell image-cell" data-field-id="${field.id}" data-label="${field.label}">
                    <div class="image-container">
                        ${fieldValue ? `<img src="${fieldValue}" alt="Interest Rate Logo" class="interest-rate-logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />` : ''}
                        <div class="no-image-placeholder" style="${fieldValue ? 'display:none' : 'display:block'}">No Image</div>
                    </div>
                </td>
            `;
        }
        } else {
                // Regular field handling (non-image fields)
                if (isAuthenticated) {
                    return `
                        <td class="data-cell" data-field-id="${field.id}" data-label="${field.label}">
                            <form class="d-flex justify-content-center" method="post" action="/field-values/update">
                                <input name="rateId" value="${rate.id}" type="hidden"/>
                                <input name="fieldId" value="${field.id}" type="hidden"/>
                                <input class="form-control form-control-sm text-center"
                                       name="value"
                                       value="${fieldValue}"
                                       type="text"
                                       onchange="updateFieldValueAjax(${rate.id}, ${field.id}, this.value)"/>
                            </form>
                        </td>
                    `;
                } else {
                    return `
                        <td class="data-cell" data-field-id="${field.id}" data-label="${field.label}">
                            <div class="form-control form-control-sm text-center"
                                 style="border: none; background: transparent; cursor: default;">
                                ${fieldValue || '-'}
                            </div>
                        </td>
                    `;
                }
            }
        }).join('');

        // Action buttons (unchanged)
        let actionButtons = '';
        if (isAuthenticated) {
            actionButtons = `
                <div class="action-buttons">
                    <button class="mehr-info-btn"
                            ${rate.moreInfo ? '' : 'disabled'}
                            onclick="showMoreInfo(${rate.id})"
                            title="${rate.moreInfo ? 'Show more info' : 'No additional info available'}">
                        ${rate.moreInfo ? 'MEHR INFO' : 'No Info'}
                    </button>
                    <a class="angebot-btn"
                       href="${rate.webLink || '#'}"
                       target="_blank"
                       title="Open Link">
                        ZUM ANGEBOT
                    </a>
                    <a class="btn-edit" href="/interest-rate/edit/${rate.id}" title="Edit Interest Rate">
                        ✎ Edit
                    </a>
                    <button class="btn-delete"
                            onclick="showDeleteConfirmation(${rate.id})"
                            title="Delete Interest Rate">
                        🗑 Delete
                    </button>
                </div>
            `;
        } else {
            actionButtons = `
                <div class="action-buttons">
                    <button class="mehr-info-btn"
                            ${rate.moreInfo ? '' : 'disabled'}
                            onclick="showMoreInfo(${rate.id})"
                            title="${rate.moreInfo ? 'Show more info' : 'No additional info available'}">
                        ${rate.moreInfo ? 'MEHR INFO' : 'No Info'}
                    </button>
                    <a class="angebot-btn"
                       href="${rate.webLink || '#'}"
                       target="_blank"
                       title="Open Link">
                        ZUM ANGEBOT
                    </a>
                </div>
            `;
        }

        return `
            <tr data-rate-id="${rate.id}">
                ${fieldCells}
                <td data-label="Actions">
                    ${actionButtons}
                </td>
            </tr>
        `;
    }).join('');
}



    function showImageUpload(rateId, fieldId, currentValue, container) {
        if (!isAuthenticated) {
            showDeleteNotification('You must be logged in to upload images.', true);
            return;
        }

        // Hide the image container and show the upload form
        const imageContainer = container;
        const uploadOverlay = document.getElementById(`imageUpload_${rateId}_${fieldId}`);

        if (uploadOverlay) {
            imageContainer.style.display = 'none';
            uploadOverlay.style.display = 'block';
        }
    }

    function previewImage(input, rateId, fieldId) {
        const file = input.files[0];
        const preview = document.getElementById(`preview_${rateId}_${fieldId}`);
        const uploadBtn = document.getElementById(`uploadBtn_${rateId}_${fieldId}`);

        if (file) {
            // Validate file type
            if (!file.type.startsWith('image/')) {
                showDeleteNotification('Please select a valid image file.', true);
                input.value = '';
                return;
            }

            // Validate file size (5MB limit)
            if (file.size > 5 * 1024 * 1024) {
                showDeleteNotification('File size must be less than 5MB.', true);
                input.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                preview.querySelector('img').src = e.target.result;
                preview.style.display = 'block';
                uploadBtn.disabled = false;
            };
            reader.readAsDataURL(file);
        } else {
            preview.style.display = 'none';
            uploadBtn.disabled = true;
        }
    }

    function uploadImage(event, rateId, fieldId, form) {
        event.preventDefault();

        const fileInput = form.querySelector('input[type="file"]');
        const uploadBtn = document.getElementById(`uploadBtn_${rateId}_${fieldId}`);

        if (!fileInput.files[0]) {
            showDeleteNotification('Please select an image to upload.', true);
            return;
        }

        const formData = new FormData();
        formData.append('image', fileInput.files[0]);
        formData.append('rateId', rateId);
        formData.append('fieldId', fieldId);

        // Disable upload button and show loading
        uploadBtn.disabled = true;
        uploadBtn.textContent = 'Uploading...';

        fetch('/api/upload-image', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Upload failed');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Update the image display
                const imageContainer = form.closest('.image-cell').querySelector('.image-container');
                const uploadOverlay = form.closest('.image-upload-overlay');

                updateImageAfterUpload(imageContainer, data.imagePath);

                // Update server data map
                if (!serverRateFieldValuesMap[rateId]) {
                    serverRateFieldValuesMap[rateId] = {};
                }
                serverRateFieldValuesMap[rateId][fieldId] = data.imagePath;

                // Hide upload form and show image container
                uploadOverlay.style.display = 'none';
                imageContainer.style.display = 'block';

                // Update the onclick attribute with new value
                imageContainer.setAttribute('onclick', `showImageUpload(${rateId}, ${fieldId}, '${data.imagePath}', this)`);

                showDeleteNotification('Image uploaded successfully!', false);
                window.location.reload();
            } else {
                throw new Error(data.message || 'Upload failed');
            }
        })
        .catch(error => {
            showDeleteNotification('Error uploading image: ' + error.message, true);
        })
        .finally(() => {
            // Reset form
            uploadBtn.disabled = false;
            uploadBtn.textContent = 'Upload';
            fileInput.value = '';
            const preview = document.getElementById(`preview_${rateId}_${fieldId}`);
            if (preview) preview.style.display = 'none';
        });
    }

    function deleteImage(rateId, fieldId) {
        if (!confirm('Are you sure you want to delete this image?')) {
            return;
        }

        fetch('/api/delete-image', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                rateId: rateId,
                fieldId: fieldId
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Delete failed');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Update the image display
                const imageContainer = document.querySelector(`[onclick*="showImageUpload(${rateId}, ${fieldId}"]`);
                const uploadOverlay = document.getElementById(`imageUpload_${rateId}_${fieldId}`);

                updateImageAfterDelete(imageContainer);

                // Update server data map
                if (serverRateFieldValuesMap[rateId]) {
                    serverRateFieldValuesMap[rateId][fieldId] = '';
                }

                // Hide upload form and show image container
                uploadOverlay.style.display = 'none';
                imageContainer.style.display = 'block';

                showDeleteNotification('Image deleted successfully!', false);
            } else {
                throw new Error(data.message || 'Delete failed');
            }
        })
        .catch(error => {
            showDeleteNotification('Error deleting image: ' + error.message, true);
        });
    }

    function cancelImageUpload(rateId, fieldId) {
        const imageContainer = document.querySelector(`[onclick*="showImageUpload(${rateId}, ${fieldId}"]`);
        const uploadOverlay = document.getElementById(`imageUpload_${rateId}_${fieldId}`);

        // Reset form
        const fileInput = uploadOverlay.querySelector('input[type="file"]');
        const preview = document.getElementById(`preview_${rateId}_${fieldId}`);
        const uploadBtn = document.getElementById(`uploadBtn_${rateId}_${fieldId}`);

        fileInput.value = '';
        if (preview) preview.style.display = 'none';
        uploadBtn.disabled = true;

        // Hide form and show image
        if (imageContainer && uploadOverlay) {
            uploadOverlay.style.display = 'none';
            imageContainer.style.display = 'block';
        }
    }

    function updateImageAfterUpload(imageContainer, imagePath) {
        const img = imageContainer.querySelector('img');
        const placeholder = imageContainer.querySelector('.no-image-placeholder');

        if (img) {
            img.src = imagePath;
            img.style.display = 'block';
        } else {
            // Create new img element
            const newImg = document.createElement('img');
            newImg.src = imagePath;
            newImg.alt = 'Interest Rate Logo';
            newImg.className = 'interest-rate-logo';
            newImg.onerror = function() {
                this.style.display = 'none';
                placeholder.style.display = 'block';
            };
            imageContainer.insertBefore(newImg, placeholder);
        }
        placeholder.style.display = 'none';
    }

    function updateImageAfterDelete(imageContainer) {
        const img = imageContainer.querySelector('img');
        const placeholder = imageContainer.querySelector('.no-image-placeholder');

        if (img) {
            img.style.display = 'none';
        }
        placeholder.style.display = 'block';
        placeholder.innerHTML = `
            <span>No Image</span>
            <small>Click to upload</small>
        `;
    }

    // Helper function to update image display when path is changed
    function updateImageDisplay(inputElement, imagePath) {
        const imageContainer = inputElement.closest('.data-cell').querySelector('.image-container');
        const img = imageContainer.querySelector('img');
        const placeholder = imageContainer.querySelector('.no-image-placeholder');

        if (imagePath && imagePath.trim()) {
            if (img) {
                img.src = imagePath;
                img.style.display = 'block';
                placeholder.style.display = 'none';
            } else {
                // Create new img element if it doesn't exist
                const newImg = document.createElement('img');
                newImg.src = imagePath;
                newImg.alt = 'Interest Rate Logo';
                newImg.className = 'interest-rate-logo';
                newImg.onerror = function() {
                    this.style.display = 'none';
                    placeholder.style.display = 'block';
                };
                imageContainer.insertBefore(newImg, placeholder);
                placeholder.style.display = 'none';
            }
        } else {
            if (img) {
                img.style.display = 'none';
            }
            placeholder.style.display = 'block';
        }
    }

    function updateBrowserUrl(page, search, sortBy, sortDir) {
        const url = new URL(window.location);
        url.searchParams.set('page', page - 1); // 0-based for URL consistency
        if (search) {
            url.searchParams.set('search', search);
        } else {
            url.searchParams.delete('search');
        }
        url.searchParams.set('sortBy', sortBy || currentSortColumn);
        url.searchParams.set('sortDir', sortDir || currentSortDirection);
        url.searchParams.set('size', pageSize);

        window.history.replaceState({}, '', url);
    }

    // ============================================================================
    // PAGINATION FUNCTIONALITY
    // ============================================================================

    function updatePaginationControls() {
        const firstPageBtn = document.getElementById('firstPageBtn');
        const prevPageBtn = document.getElementById('prevPageBtn');
        const nextPageBtn = document.getElementById('nextPageBtn');
        const lastPageBtn = document.getElementById('lastPageBtn');

        if (firstPageBtn) firstPageBtn.disabled = currentPage === 1;
        if (prevPageBtn) prevPageBtn.disabled = currentPage === 1;
        if (nextPageBtn) nextPageBtn.disabled = currentPage >= totalPages;
        if (lastPageBtn) lastPageBtn.disabled = currentPage >= totalPages;

        updatePageNumbers();

        const pageJumpInput = document.getElementById('pageJumpInput');
        if (pageJumpInput) {
            pageJumpInput.max = totalPages;
            pageJumpInput.placeholder = currentPage;
        }
    }

    function updatePageNumbers() {
        const pageNumbers = document.getElementById('pageNumbers');
        const pageNumbersBottom = document.getElementById('pageNumbersBottom');

        if (!pageNumbers) return;

        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, startPage + 4);

        if (endPage - startPage < 4) {
            startPage = Math.max(1, endPage - 4);
        }

        let html = '';
        for (let i = startPage; i <= endPage; i++) {
            html += `
                <button class="page-btn ${i === currentPage ? 'active' : ''}"
                        onclick="goToPage(${i})">${i}</button>
            `;
        }

        pageNumbers.innerHTML = html;
        if (pageNumbersBottom) {
            pageNumbersBottom.innerHTML = html;
        }
    }

    function updatePaginationInfo() {
        const startRecord = totalRecords === 0 ? 0 : (currentPage - 1) * pageSize + 1;
        const endRecord = Math.min(currentPage * pageSize, totalRecords);

        const infoText = `Showing ${startRecord}-${endRecord} of ${totalRecords} results`;

        const resultsInfo = document.getElementById('resultsInfo');
        const resultsInfoBottom = document.getElementById('resultsInfoBottom');

        if (resultsInfo) resultsInfo.textContent = infoText;
        if (resultsInfoBottom) resultsInfoBottom.textContent = infoText;
    }

    // Main navigation function - always loads from server
    function goToPage(page) {
        if (page < 1 || page > totalPages || page === currentPage || isLoading) return;
        loadPageFromServer(page, currentSearchTerm);
    }

    function jumpToPage() {
        const input = document.getElementById('pageJumpInput');
        const page = parseInt(input.value);

        if (page && page >= 1 && page <= totalPages) {
            goToPage(page);
            input.value = '';
        }
    }

    function changePageSize(newSize) {
        pageSize = parseInt(newSize);
        currentPage = 1;
        loadPageFromServer(1, currentSearchTerm);
    }

    // ============================================================================
    // SEARCH FUNCTIONALITY
    // ============================================================================

    function performSearch() {
        const searchInput = document.getElementById('searchInput');
        const searchTerm = searchInput ? searchInput.value.trim() : '';

        if (isInfiniteScrollEnabled) {
            // Reset infinite scroll state
            loadedPages.clear();
            allLoadedData = [];
            hasMoreData = true;
            currentPage = 1;

            // Hide indicators
            hideInfiniteScrollIndicator();
            hideLoadingMoreIndicator();
            const endIndicator = document.getElementById('endOfDataIndicator');
            if (endIndicator) endIndicator.style.display = 'none';

            // Load first page with search and current filters
            loadPageFromServerWithInfiniteScroll(1, searchTerm, currentSortColumn, currentSortDirection);
        } else {
            // Use normal search with filters
            currentPage = 1;
            loadPageFromServerWithFilters(1, searchTerm, currentSortColumn, currentSortDirection, activeFilters);
        }
    }

    function clearSearch() {
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.value = '';
        }

        if (isInfiniteScrollEnabled) {
            // Reset infinite scroll state
            loadedPages.clear();
            allLoadedData = [];
            hasMoreData = true;
            currentPage = 1;

            // Hide indicators
            hideInfiniteScrollIndicator();
            hideLoadingMoreIndicator();
            const endIndicator = document.getElementById('endOfDataIndicator');
            if (endIndicator) endIndicator.style.display = 'none';

            // Load first page without search but with current filters
            loadPageFromServerWithInfiniteScroll(1, '', currentSortColumn, currentSortDirection);
        } else {
            // Use normal clear with filters
            currentPage = 1;
            loadPageFromServerWithFilters(1, '', currentSortColumn, currentSortDirection, activeFilters);
        }
    }

    // ============================================================================
    // SORTING FUNCTIONALITY
    // ============================================================================

    function sortTable(headerElement, event) {
        if (event && event.type === 'click' && headerElement.classList.contains('dragging')) {
            return;
        }

        const fieldId = headerElement.dataset.fieldId;
        const sortBy = `field_${fieldId}`;

        let sortDirection = 'asc';
        if (currentSortColumn === sortBy) {
            sortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
        }

        // Update UI indicators
        document.querySelectorAll('.sortable')
            .forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });
        headerElement.classList.add(sortDirection === 'asc' ? 'sort-asc' : 'sort-desc');

        // Load data with new sort
        currentPage = 1;
        loadPageFromServer(1, currentSearchTerm, sortBy, sortDirection);
    }

    // ============================================================================
    // LOADING STATES AND UI FEEDBACK
    // ============================================================================

    function showLoading() {
        isLoading = true;
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) overlay.classList.add('show');
    }

    function hideLoading() {
        isLoading = false;
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) overlay.classList.remove('show');
    }

    function showDeleteNotification(message, isError) {
        const notification = document.getElementById('deleteNotification');
        if (notification) {
            notification.textContent = message;
            notification.classList.toggle('error', isError);
            notification.classList.toggle('success', !isError);
            notification.classList.add('show');

            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
    }

    // ============================================================================
    // MORE INFO AND EXPANDED CARDS
    // ============================================================================

    function showMoreInfo(rateId) {
        let rate = currentPageData.find(r => r.id === rateId);

        // If not found in current page data, try to find in all loaded data (for infinite scroll)
        if (!rate && typeof allLoadedData !== 'undefined' && allLoadedData.length > 0) {
            rate = allLoadedData.find(r => r.id === rateId);
        }

        if (!rate) {
            fetchRateDetails(rateId)
                .then(rateData => {
                    if (rateData && rateData.moreInfo) {
                        displayRateCard(rateData);
                    }
                });
            return;
        }

        if (!rate.moreInfo) {
            showDeleteNotification('No additional information available for this rate.', false);
            return;
        }

        displayRateCard(rate);
    }


    function displayRateCard(rate) {
        if (currentExpandedCard && currentExpandedCard !== rate.id) {
            closeExpandedCard(currentExpandedCard);
        }

        let existingCard = document.getElementById(`rateCardRow_${rate.id}`);
        if (existingCard) {
            existingCard.style.display = 'none';
            setTimeout(() => {
                if (existingCard.parentNode) {
                    existingCard.parentNode.removeChild(existingCard);
                }
            }, 0);

            if (currentExpandedCard === rate.id) {
                currentExpandedCard = null;
                return;
            }
        }

        // FIXED: Better debugging and target identification
        console.log('Looking for rate ID:', rate.id);

        // Check if we're in mobile card view
        const tableContainer = document.getElementById('tableContainer');
        const isMobileCardView = tableContainer && tableContainer.classList.contains('mobile-stack');

        console.log('Mobile card view active:', isMobileCardView);

        let targetRow = null;

        if (isMobileCardView) {
            // In mobile card view, look for the TR with class mobile-card-row
            targetRow = document.querySelector(`div.mobile-card-row[data-rate-id="${rate.id}"]`);
            console.log('Found mobile card row:', targetRow);
        } else {
            // In table view, look for regular table row
            targetRow = document.querySelector(`tr[data-rate-id="${rate.id}"]`);
            console.log('Found table row:', targetRow);
        }

        if (!targetRow) {
            console.error('Target row not found for rate ID:', rate.id);
            // Try alternative selectors as fallback
            targetRow = document.querySelector(`[data-rate-id="${rate.id}"]`);
            console.log('Fallback found:', targetRow);

            if (!targetRow) {
                console.error('No element found with rate ID:', rate.id);
                return;
            }

            // If we found a non-TR element, find its closest TR parent
            if (targetRow.tagName !== 'TR') {
                targetRow = targetRow.closest('tr');
                console.log('Closest TR:', targetRow);
            }
        }

        if (!targetRow) {
            console.error('Still no target row found');
            return;
        }

        console.log('Target row details:', {
            tagName: targetRow.tagName,
            className: targetRow.className,
            dataRateId: targetRow.dataset.rateId,
            nextSibling: targetRow.nextSibling,
            nextElementSibling: targetRow.nextElementSibling
        });

        const card = createRateCard(rate);
        const cardRow = document.createElement('tr');
        cardRow.id = `rateCardRow_${rate.id}`;
        cardRow.className = 'rate-card-row show';
        cardRow.innerHTML = `<td colspan="100%" class="rate-card-cell"></td>`;

        cardRow.querySelector('.rate-card-cell')
            .appendChild(card);

        // FIXED: Use insertAdjacentElement for more predictable positioning
        try {
            targetRow.insertAdjacentElement('afterend', cardRow);
            console.log('Successfully inserted card row after target');
        } catch (error) {
            console.error('Error inserting card row:', error);
            // Fallback to original method
            if (targetRow.parentNode) {
                targetRow.parentNode.insertBefore(cardRow, targetRow.nextSibling);
                console.log('Used fallback insertion method');
            } else {
                console.error('Target row has no parent node');
                return;
            }
        }

        setTimeout(() => {
            card.scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });
        }, 50);

        currentExpandedCard = rate.id;
    }


    function createRateCard(rate) {
        const card = document.createElement('div');
        card.className = 'rate-card';
        card.id = `rateCard_${rate.id}`;

        const moreInfo = rate.moreInfo;
        if (!moreInfo) return card;

        const sectionOrder = moreInfo.sectionOrder || [];
        const tableSectionsMap = new Map();
        const textSectionsMap = new Map();

        if (moreInfo.tableSections) {
            moreInfo.tableSections.forEach(tableSection => {
                tableSectionsMap.set(tableSection.sectionIdentifier, tableSection);
            });
        }

        if (moreInfo.textSections) {
            moreInfo.textSections.forEach(textSection => {
                textSectionsMap.set(textSection.sectionIdentifier, textSection);
            });
        }

        const createTableSection = (tableSection) => {
            if (!tableSection || !tableSection.title || !tableSection.miniTableRows || tableSection.miniTableRows.length === 0) {
                return '';
            }

            let dragAttributes = '';
            let dragHandle = '';
            let sectionControls = '';

            if (isAuthenticated) {
                dragAttributes = `
                    draggable="true"
                    ondragstart="handleSectionDragStart(event, '${tableSection.sectionIdentifier}', ${rate.id})"
                    ondragover="handleSectionDragOver(event)"
                    ondrop="handleSectionDrop(event, '${tableSection.sectionIdentifier}', ${rate.id})"
                    ondragend="handleSectionDragEnd(event)"
                `;
                dragHandle = `<div class="section-drag-handle" title="Drag to reorder">⋮⋮</div>`;
                sectionControls = `
                    <div class="section-controls">
                        <span class="section-type-indicator">Table</span>
                    </div>
                `;
            }

            return `
                <div class="expanded-section ${isAuthenticated ? 'draggable-section' : ''} table-section"
                     data-section-type="table"
                     data-section-id="${tableSection.sectionIdentifier}"
                     ${dragAttributes}>
                    ${dragHandle}
                    ${sectionControls}
                    <h5 class="section-title">${tableSection.title}</h5>
                    <div class="info-table">
                        ${tableSection.miniTableRows.map(row => `
                            <div class="info-table-row">
                                <div class="info-table-label">${row.label || ''}</div>
                                <div class="info-table-value">${row.description || ''}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        };

        const createTextSection = (textSection) => {
            if (!textSection || (!textSection.title && !textSection.content)) {
                return '';
            }

            let dragAttributes = '';
            let dragHandle = '';
            let sectionControls = '';

            if (isAuthenticated) {
                dragAttributes = `
                    draggable="true"
                    ondragstart="handleSectionDragStart(event, '${textSection.sectionIdentifier}', ${rate.id})"
                    ondragover="handleSectionDragOver(event)"
                    ondrop="handleSectionDrop(event, '${textSection.sectionIdentifier}', ${rate.id})"
                    ondragend="handleSectionDragEnd(event)"
                `;
                dragHandle = `<div class="section-drag-handle" title="Drag to reorder">⋮⋮</div>`;
                sectionControls = `
                    <div class="section-controls">
                        <span class="section-type-indicator">Text</span>
                    </div>
                `;
            }

            return `
                <div class="expanded-section ${isAuthenticated ? 'draggable-section' : ''} text-section"
                     data-section-type="text"
                     data-section-id="${textSection.sectionIdentifier}"
                     ${dragAttributes}>
                    ${dragHandle}
                    ${sectionControls}
                    ${textSection.title ? `<h5 class="section-title">${textSection.title}</h5>` : ''}
                    <div class="text-content" style="text-align: left;">${textSection.content || ''}</div>
                </div>
            `;
        };

        let sectionsHTML = '';
        sectionOrder.forEach(sectionIdentifier => {
            if (sectionIdentifier.startsWith('table-')) {
                const tableSection = tableSectionsMap.get(sectionIdentifier);
                if (tableSection) {
                    sectionsHTML += createTableSection(tableSection);
                }
            } else if (sectionIdentifier.startsWith('text-')) {
                const textSection = textSectionsMap.get(sectionIdentifier);
                if (textSection) {
                    sectionsHTML += createTextSection(textSection);
                }
            }
        });

        // Add any sections not in order
        tableSectionsMap.forEach((tableSection, identifier) => {
            if (!sectionOrder.includes(identifier)) {
                sectionsHTML += createTableSection(tableSection);
            }
        });

        textSectionsMap.forEach((textSection, identifier) => {
            if (!sectionOrder.includes(identifier)) {
                sectionsHTML += createTextSection(textSection);
            }
        });

        card.innerHTML = `
            <div class="rate-expanded-content show">
                ${sectionsHTML}
            </div>
        `;

        return card;
    }

    function closeExpandedCard(rateId) {
        const cardRow = document.getElementById(`rateCardRow_${rateId}`);
        if (cardRow) {
            cardRow.style.display = 'none';
            cardRow.classList.remove('show');

            requestAnimationFrame(() => {
                if (cardRow.parentNode) {
                    cardRow.parentNode.removeChild(cardRow);
                }
            });

            if (currentExpandedCard === rateId) {
                currentExpandedCard = null;
            }
        }
    }

    // ============================================================================
    // DELETE FUNCTIONALITY
    // ============================================================================

    function showDeleteConfirmation(rateId) {
        if (!isAuthenticated) {
            showDeleteNotification('You must be logged in to delete items.', true);
            return;
        }

        pendingDeleteId = rateId;
        document.getElementById('deleteConfirmationModal')
            .style.display = 'flex';
        document.getElementById('confirmDeleteBtn')
            .onclick = function () {
                deleteInterestRate(rateId);
            };
    }

    function deleteInterestRate(rateId) {
        if (!isAuthenticated) {
            showDeleteNotification('You must be logged in to delete items.', true);
            return;
        }

        fetch(`/interest-rate/${rateId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to delete interest rate');
                }
                return response.text();
            })
            .then(data => {
                hideDeleteConfirmation();
                showDeleteNotification('Interest rate deleted successfully!', false);
                closeExpandedCard(rateId);

            // Redirect to home after deletion
                setTimeout(() => {
                    window.location.reload();
                }, 500);
            })
            .catch(error => {
                hideDeleteConfirmation();
                showDeleteNotification('Error deleting interest rate: ' + error.message, true);
            });
    }

    function hideDeleteConfirmation() {
        document.getElementById('deleteConfirmationModal')
            .style.display = 'none';
        pendingDeleteId = null;
    }

    // ============================================================================
    // FIELD MANAGEMENT (ADMIN ONLY)
    // ============================================================================

    function showEditForm(fieldId) {
        if (!isAuthenticated) {
            showDeleteNotification('You must be logged in to edit fields.', true);
            return;
        }

        if (currentEditForm) {
            currentEditForm.classList.remove('show');
        }
        const form = document.getElementById('editForm_' + fieldId);
        if (form) {
            form.classList.add('show');
            currentEditForm = form;
        }
    }

    function hideEditForm(fieldId) {
        const form = document.getElementById('editForm_' + fieldId);
        if (form) {
            form.classList.remove('show');
        }
        currentEditForm = null;
    }

    function showFieldDeleteConfirmation(fieldId, fieldLabel) {
        if (!isAuthenticated) return;

        pendingFieldDeleteId = fieldId;
        document.getElementById('fieldToDeleteName')
            .textContent = fieldLabel;
        document.getElementById('fieldToDeleteId')
            .textContent = fieldId;
        document.getElementById('fieldDeleteConfirmationModal')
            .style.display = 'flex';

        document.getElementById('confirmFieldDeleteBtn')
            .onclick = function () {
                deleteGlobalField(fieldId);
            };
    }

    function hideFieldDeleteConfirmation() {
        if (!isAuthenticated) return;

        document.getElementById('fieldDeleteConfirmationModal')
            .style.display = 'none';
        pendingFieldDeleteId = null;
    }

    function deleteGlobalField(fieldId) {
        if (!isAuthenticated) return;

        const confirmBtn = document.getElementById('confirmFieldDeleteBtn');
        const originalText = confirmBtn.textContent;
        confirmBtn.textContent = 'Deleting...';
        confirmBtn.disabled = true;

        fetch(`/fields/delete/${fieldId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to delete field');
                }
                return response.text();
            })
            .then(data => {
                hideFieldDeleteConfirmation();
                showDeleteNotification('Field deleted successfully! Page will reload...', false);
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            })
            .catch(error => {
                confirmBtn.textContent = originalText;
                confirmBtn.disabled = false;
                showDeleteNotification('Error deleting field: ' + error.message, true);
            });
    }

    function handleFieldDeleteClick(button) {
        if (!isAuthenticated) {
            showDeleteNotification('You must be logged in to delete fields.', true);
            return;
        }

        const fieldId = button.dataset.id;
        const fieldLabel = button.dataset.label;
        showFieldDeleteConfirmation(fieldId, fieldLabel);
    }

    // ============================================================================
    // COLUMN DRAG AND DROP (ADMIN ONLY)
    // ============================================================================

    function captureOriginalOrder() {
        if (!isAuthenticated) return;
        const headers = document.querySelectorAll('.draggable-column');
        originalOrder = Array.from(headers)
            .map(header => header.dataset.fieldId);
    }

    function handleDragStart(event) {
        if (!isAuthenticated) return;

        draggedElement = event.target;
        event.target.classList.add('dragging');
        event.dataTransfer.effectAllowed = 'move';
        event.dataTransfer.setData('text/html', event.target.outerHTML);
    }

    function handleDragOver(event) {
        if (!isAuthenticated) return;

        event.preventDefault();
        event.dataTransfer.dropEffect = 'move';

        const target = event.target.closest('.draggable-column');
        if (target && target !== draggedElement) {
            document.querySelectorAll('.drag-over')
                .forEach(el => el.classList.remove('drag-over'));
            target.classList.add('drag-over');
            showDropIndicator(target, event);
        }
    }

    function handleDrop(event) {
        if (!isAuthenticated) return;

        event.preventDefault();

        const target = event.target.closest('.draggable-column');
        if (target && target !== draggedElement) {
            const draggedFieldId = draggedElement.dataset.fieldId;
            const targetFieldId = target.dataset.fieldId;

            moveColumn(draggedFieldId, targetFieldId);
            markOrderChanged();
        }

        cleanup();
    }

    function handleDragEnd(event) {
        cleanup();
    }

    function cleanup() {
        if (draggedElement) {
            draggedElement.classList.remove('dragging');
        }
        document.querySelectorAll('.drag-over')
            .forEach(el => el.classList.remove('drag-over'));
        hideDropIndicator();
        draggedElement = null;
    }

    function moveColumn(draggedFieldId, targetFieldId) {
        if (!isAuthenticated) return;

        const headerRow = document.getElementById("column-header-row");
        const headers = Array.from(headerRow.querySelectorAll(".draggable-column"));

        const draggedIndex = headers.findIndex(h => h.dataset.fieldId === draggedFieldId);
        const targetIndex = headers.findIndex(h => h.dataset.fieldId === targetFieldId);

        if (draggedIndex === -1 || targetIndex === -1 || draggedIndex === targetIndex) return;

        // Move the header element
        const draggedHeader = headers[draggedIndex];
        if (targetIndex < draggedIndex) {
            headerRow.insertBefore(draggedHeader, headers[targetIndex]);
        } else {
            headerRow.insertBefore(draggedHeader, headers[targetIndex].nextSibling);
        }

        // Re-render the table body with current page data to match new column order
        const tbody = document.getElementById('tableBody');
        renderTableRows(currentPageData, tbody);
    }

    function markOrderChanged() {
        if (!isAuthenticated) return;

        orderChanged = true;
        document.getElementById("saveOrderBtn")
            .classList.add("show");
        document.getElementById("orderChangedIndicator")
            .classList.add("show");
    }

    function saveColumnOrder() {
        if (!isAuthenticated) {
            showDeleteNotification('You must be logged in to save changes.', true);
            return;
        }

        const headers = document.querySelectorAll(".draggable-column");
        const newOrder = Array.from(headers)
            .map(header => header.dataset.fieldId);

        const saveBtn = document.getElementById("saveOrderBtn");
        const originalText = saveBtn.textContent;
        saveBtn.textContent = "Saving...";
        saveBtn.disabled = true;

        fetch('/fields/reorder', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': getCsrfToken()
                },
                body: JSON.stringify(newOrder)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error("Failed to save order");
                }
                return response.text();
            })
            .then(data => {
                orderChanged = false;
                saveBtn.classList.remove("show");
                document.getElementById("orderChangedIndicator")
                    .classList.remove("show");
                updateGlobalFieldsCache();
                showDeleteNotification('Column order saved successfully!', false);
                saveBtn.textContent = originalText;
                saveBtn.disabled = false;
            })
            .catch(error => {
                saveBtn.textContent = originalText;
                saveBtn.disabled = false;
                showDeleteNotification("Error saving order: " + error.message, true);
            });
    }

    function updateGlobalFieldsCache() {
        if (!isAuthenticated) return;

        const headers = document.querySelectorAll('.draggable-column');
        const currentOrder = Array.from(headers)
            .map(header => ({
                id: header.dataset.fieldId,
                label: header.querySelector('.header-text')
                    .textContent
            }));

        if (globalFieldsCache) {
            globalFieldsCache = currentOrder.map(orderItem =>
                    globalFieldsCache.find(field => field.id == orderItem.id)
                )
                .filter(Boolean);
        }
    }

    function showDropIndicator(target, event) {
        if (!isAuthenticated) return;

        const indicator = document.getElementById("dropIndicator");
        if (indicator) {
            const rect = target.getBoundingClientRect();
            indicator.style.left = `${rect.left}px`;
            indicator.style.top = `${rect.top}px`;
            indicator.style.height = `${rect.height}px`;
            indicator.classList.add("show");
        }
    }

    function hideDropIndicator() {
        const indicator = document.getElementById("dropIndicator");
        if (indicator) {
            indicator.classList.remove("show");
        }
    }

    // ============================================================================
    // SECTION DRAG AND DROP (ADMIN ONLY)
    // ============================================================================

    function handleSectionDragStart(event, sectionIdentifier, rateId) {
        if (!isAuthenticated) return;

        draggedSection = {
            element: event.target.closest('.expanded-section'),
            identifier: sectionIdentifier,
            rateId: rateId
        };
        draggedSection.element.classList.add('dragging');
        currentRateId = rateId;
        event.dataTransfer.effectAllowed = 'move';
        event.dataTransfer.setData('text/plain', sectionIdentifier);
    }

    function handleSectionDragOver(event) {
        if (!isAuthenticated) return;

        event.preventDefault();
        event.dataTransfer.dropEffect = 'move';

        const target = event.target.closest('.expanded-section');
        if (target && draggedSection && target !== draggedSection.element &&
            target.closest(`#rateCard_${currentRateId}`)) {

            document.querySelectorAll('.drag-over')
                .forEach(el => el.classList.remove('drag-over'));
            target.classList.add('drag-over');
        }
    }

    function handleSectionDrop(event, targetIdentifier, rateId) {
        if (!isAuthenticated) return;

        event.preventDefault();

        if (draggedSection && draggedSection.rateId === rateId && draggedSection.identifier !== targetIdentifier) {
            const sourceElement = draggedSection.element;
            const targetElement = event.target.closest('.expanded-section');

            if (sourceElement && targetElement) {
                const parent = sourceElement.parentElement;
                const sourceIndex = Array.from(parent.children)
                    .indexOf(sourceElement);
                const targetIndex = Array.from(parent.children)
                    .indexOf(targetElement);

                if (sourceIndex < targetIndex) {
                    parent.insertBefore(sourceElement, targetElement.nextSibling);
                } else {
                    parent.insertBefore(sourceElement, targetElement);
                }

                const sections = parent.querySelectorAll('[data-section-id]');
                const newOrder = Array.from(sections)
                    .map(el => el.getAttribute('data-section-id'));

                saveSectionOrder(rateId, newOrder);
            }
        }

        cleanupSectionDrag();
    }

    function handleSectionDragEnd(event) {
        cleanupSectionDrag();
    }

    function cleanupSectionDrag() {
        if (draggedSection && draggedSection.element) {
            draggedSection.element.classList.remove('dragging');
        }
        document.querySelectorAll('.drag-over')
            .forEach(el => el.classList.remove('drag-over'));
        draggedSection = null;
        currentRateId = null;
    }

    function saveSectionOrder(rateId, newOrder) {
        fetch(`/sections/reorder?rateId=${rateId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(newOrder)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error("Failed to save section order");
                }
                return response.text();
            })
            .catch(error => {
                showDeleteNotification("Error saving section order: " + error.message, true);
            });
    }

    // ============================================================================
    // UTILITY FUNCTIONS
    // ============================================================================

    function getCsrfToken() {
        const tokenMeta = document.querySelector('meta[name="_csrf"]');
        return tokenMeta ? tokenMeta.getAttribute('content') : '';
    }

    // ============================================================================
    // EVENT LISTENERS AND KEYBOARD NAVIGATION
    // ============================================================================

    // Close edit forms when clicking outside
    document.addEventListener('click', function (e) {
        if (currentEditForm && !currentEditForm.contains(e.target) && !e.target.classList.contains('edit-header-btn')) {
            currentEditForm.classList.remove('show');
            currentEditForm = null;
        }
    });

    // Enhanced keyboard navigation for pagination
    document.addEventListener('keydown', function (e) {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

        switch (e.key) {
        case 'ArrowLeft':
            if (currentPage > 1) {
                e.preventDefault();
                goToPage(currentPage - 1);
            }
            break;
        case 'ArrowRight':
            if (currentPage < totalPages) {
                e.preventDefault();
                goToPage(currentPage + 1);
            }
            break;
        case 'Home':
            e.preventDefault();
            goToPage(1);
            break;
        case 'End':
            e.preventDefault();
            goToPage(totalPages);
            break;
        }
    });

    // Handle Enter key in page jump input
    document.addEventListener('DOMContentLoaded', function () {
        const pageJumpInput = document.getElementById('pageJumpInput');
        if (pageJumpInput) {
            pageJumpInput.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    jumpToPage();
                }
            });
        }
    });

    // ============================================================================
    // FILTERS
    // ============================================================================

    // Filter Management JavaScript
    let availableFilters = [];
    let activeFilters = new Map(); // fieldId -> Set of selected values
    let filterExpanded = false;

    // Initialize filters when page loads
    document.addEventListener('DOMContentLoaded', function () {
        initializeFilters();
    });

    async function initializeFilters() {
        try {
            // Load available filters from server
            const response = await fetch('/filters/available');
            if (response.ok) {
                availableFilters = await response.json();
                renderFilterGrid();

                // Initialize with any existing filters from URL
                initializeFromUrlParams();
                updateFilterSummary();
            }
        } catch (error) {
            console.error('Error loading filters:', error);
        }
    }

    function initializeFromUrlParams() {
        const urlParams = new URLSearchParams(window.location.search);

        for (const [key, value] of urlParams.entries()) {
            if (key.startsWith('filter_')) {
                const fieldId = key.substring(7);
                // FIXED: Decode the URL-encoded value and split by pipe
                const decodedValue = decodeURIComponent(value);
                const values = decodedValue.includes('|') ? decodedValue.split('|') : [decodedValue];
                activeFilters.set(fieldId, new Set(values));
            }
        }

        if (activeFilters.size > 0) {
            updateActiveFiltersDisplay();
            updateFilterCheckboxes();
        }
    }

    function toggleFilters() {
        const content = document.getElementById('filterContent');
        const toggle = document.getElementById('filterToggle');

        filterExpanded = !filterExpanded;

        if (filterExpanded) {
            content.classList.add('show');
            toggle.classList.add('expanded');
        } else {
            content.classList.remove('show');
            toggle.classList.remove('expanded');
        }
    }

    function renderFilterGrid() {
        const grid = document.getElementById('filterGrid');

        grid.innerHTML = availableFilters.map(filter => `
            <div class="filter-item" data-field-id="${filter.fieldId}">
                <h6>
                    ${filter.label}
                    <span class="text-muted">(${filter.options.length})</span>
                </h6>
                <div class="filter-options" id="options_${filter.fieldId}">
                    ${filter.options.map(option => `
                        <div class="filter-option" onclick="toggleFilterOption(${filter.fieldId}, '${option.value}')">
                            <input type="checkbox"
                                   id="filter_${filter.fieldId}_${option.value.replace(/[^a-zA-Z0-9]/g, '_')}"
                                   value="${option.value}">
                            <label for="filter_${filter.fieldId}_${option.value.replace(/[^a-zA-Z0-9]/g, '_')}">
                                ${option.label}
                            </label>
                        </div>
                    `).join('')}
                </div>
            </div>
        `)
            .join('');
    }

    function toggleFilterOption(fieldId, value) {
        const fieldIdStr = fieldId.toString();

        if (!activeFilters.has(fieldIdStr)) {
            activeFilters.set(fieldIdStr, new Set());
        }

        const fieldFilters = activeFilters.get(fieldIdStr);

        if (fieldFilters.has(value)) {
            fieldFilters.delete(value);
            if (fieldFilters.size === 0) {
                activeFilters.delete(fieldIdStr);
            }
        } else {
            fieldFilters.add(value);
        }

        updateFilterCheckboxes();
        updateActiveFiltersDisplay();
        updateFilterSummary();
    }

    function updateFilterCheckboxes() {
        availableFilters.forEach(filter => {
            const fieldIdStr = filter.fieldId.toString();
            const selectedValues = activeFilters.get(fieldIdStr) || new Set();

            filter.options.forEach(option => {
                const checkboxId = `filter_${filter.fieldId}_${option.value.replace(/[^a-zA-Z0-9]/g, '_')}`;
                const checkbox = document.getElementById(checkboxId);
                if (checkbox) {
                    checkbox.checked = selectedValues.has(option.value);
                }
            });
        });
    }

    function updateActiveFiltersDisplay() {
        const container = document.getElementById('activeFilters');
        const tags = [];

        activeFilters.forEach((values, fieldId) => {
            const filter = availableFilters.find(f => f.fieldId.toString() === fieldId);
            if (filter) {
                values.forEach(value => {
                    tags.push(`
                        <span class="filter-tag">
                            ${filter.label}: ${value}
                            <button class="remove-filter" onclick="removeFilterTag('${fieldId}', '${value}')" title="Remove filter">
                                ✕
                            </button>
                        </span>
                    `);
                });
            }
        });

        container.innerHTML = tags.join('');
        container.style.display = tags.length > 0 ? 'flex' : 'none';
    }

    function updateFilterSummary() {
        const summary = document.getElementById('filterSummary');
        const totalActive = Array.from(activeFilters.values())
            .reduce((sum, set) => sum + set.size, 0);

        if (totalActive === 0) {
            summary.textContent = 'Click to add filters';
            summary.style.color = '#666';
        } else {
            summary.textContent = `${totalActive} filter${totalActive > 1 ? 's' : ''} active`;
            summary.style.color = '#007bff';
            summary.style.fontWeight = '600';
        }
    }

    function removeFilterTag(fieldId, value) {
        if (activeFilters.has(fieldId)) {
            activeFilters.get(fieldId)
                .delete(value);
            if (activeFilters.get(fieldId)
                .size === 0) {
                activeFilters.delete(fieldId);
            }
        }

        updateFilterCheckboxes();
        updateActiveFiltersDisplay();
        updateFilterSummary();

        // FIXED: Auto-apply filters when removing tags, with proper infinite scroll handling
        applyFilters();
    }

    function clearAllFilters() {
        activeFilters.clear();
        updateFilterCheckboxes();
        updateActiveFiltersDisplay();
        updateFilterSummary();

        // FIXED: Apply cleared filters with proper infinite scroll handling
        applyFilters();
    }


    function applyFilters() {
        // Build filter parameters for the API call
        const params = new URLSearchParams();

        // Add existing parameters
        params.set('page', '0'); // Reset to first page when applying filters
        params.set('size', pageSize.toString());
        params.set('sortBy', currentSortColumn);
        params.set('sortDir', currentSortDirection);

        if (currentSearchTerm) {
            params.set('search', currentSearchTerm);
        }

        // FIXED: Add filter parameters using pipe separator instead of comma
        activeFilters.forEach((values, fieldId) => {
            if (values.size > 0) {
                // Use pipe (|) as separator and URL encode the entire value
                const filterValue = Array.from(values).join('|');
                params.set(`filter_${fieldId}`, encodeURIComponent(filterValue));
            }
        });

        // Check if we're in infinite scroll mode and handle accordingly
        if (isInfiniteScrollEnabled) {
            // Reset infinite scroll state for filters
            loadedPages.clear();
            allLoadedData = [];
            hasMoreData = true;
            currentPage = 1;

            // Hide indicators while loading
            hideInfiniteScrollIndicator();
            hideLoadingMoreIndicator();
            const endIndicator = document.getElementById('endOfDataIndicator');
            if (endIndicator) endIndicator.style.display = 'none';

            // Load first page with filters in infinite scroll mode
            loadPageFromServerWithInfiniteScroll(1, currentSearchTerm, currentSortColumn, currentSortDirection);
        } else {
            // Normal pagination mode
            currentPage = 1;
            loadPageFromServerWithFilters(1, currentSearchTerm, currentSortColumn, currentSortDirection, activeFilters);
        }

        // Update URL
        updateBrowserUrlWithFilters();

        // Close filters panel on mobile after applying
        if (window.innerWidth <= 768) {
            toggleFilters();
        }
    }

    function loadPageFromServerWithFilters(page, searchTerm = '', sortBy = null, sortDir = null, filters = new Map()) {
        if (isLoading) return;

        showLoading();

        const params = new URLSearchParams({
            page: page - 1, // Convert to 0-based for backend
            size: pageSize,
            sortBy: sortBy || currentSortColumn,
            sortDir: sortDir || currentSortDirection
        });

        if (searchTerm && searchTerm.trim()) {
            params.append('search', searchTerm.trim());
        }

        // FIXED: Add filter parameters using pipe separator
        filters.forEach((values, fieldId) => {
            if (values.size > 0) {
                const filterValue = Array.from(values).join('|');
                params.set(`filter_${fieldId}`, encodeURIComponent(filterValue));
            }
        });

        fetch(`/api/interest-rates?${params.toString()}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch data');
                }
                return response.json();
            })
            .then(data => {
                // Update all pagination state
                currentPage = page;
                totalPages = data.totalPages;
                totalRecords = data.totalElements;
                currentSearchTerm = searchTerm || '';

                // Update sort state if provided
                if (sortBy) currentSortColumn = sortBy;
                if (sortDir) currentSortDirection = sortDir;

                // Update data arrays
                currentPageData = data.content;
                serverRateFieldValuesMap = data.rateFieldValuesMap;

                // Render the new data
                renderTableData(data.content);
                updatePaginationControls();
                updatePaginationInfo();
                hideLoading();

                // Close any expanded cards when changing pages
                if (currentExpandedCard) {
                    closeExpandedCard(currentExpandedCard);
                }

                // Update URL without page reload
                updateBrowserUrlWithFilters();
            })
            .catch(error => {
                console.error('Error loading page:', error);
                showDeleteNotification('Error loading data: ' + error.message, true);
                hideLoading();
            });
    }

    function updateBrowserUrlWithFilters() {
        const url = new URL(window.location);

        // Clear existing filter parameters
        for (const [key] of url.searchParams.entries()) {
            if (key.startsWith('filter_')) {
                url.searchParams.delete(key);
            }
        }

        // FIXED: Add current filter parameters using pipe separator
        activeFilters.forEach((values, fieldId) => {
            if (values.size > 0) {
                const filterValue = Array.from(values).join('|');
                url.searchParams.set(`filter_${fieldId}`, encodeURIComponent(filterValue));
            }
        });

        // Update other parameters
        url.searchParams.set('page', currentPage - 1);
        if (currentSearchTerm) {
            url.searchParams.set('search', currentSearchTerm);
        } else {
            url.searchParams.delete('search');
        }
        url.searchParams.set('sortBy', currentSortColumn);
        url.searchParams.set('sortDir', currentSortDirection);
        url.searchParams.set('size', pageSize);

        window.history.replaceState({}, '', url);
    }

    // Override the existing loadPageFromServer function to support filters
    const originalLoadPageFromServer = window.loadPageFromServer;
    window.d = function (page, searchTerm = '', sortBy = null, sortDir = null) {
        loadPageFromServerWithFilters(page, searchTerm, sortBy, sortDir, activeFilters);
    };


    // Add filter refresh capability
    function refreshFiltersFromServer() {
        initializeFilters();
    }

    // Export functions for use in main application
    window.filterFunctions = {
        toggleFilters,
        applyFilters,
        clearAllFilters,
        refreshFiltersFromServer,
        loadPageFromServerWithFilters
    };

    // ============================================================================
    // MOBILE INFINITE SCROLL FUNCTIONALITY
    // ============================================================================

    // Mobile-specific variables
    let isMobileView = false;
    let isInfiniteScrollEnabled = false;
    let loadedPages = new Set();
    let allLoadedData = [];
    let isLoadingMore = false;
    let hasMoreData = true;
    let scrollThreshold = 200; // pixels from bottom to trigger load
    // FIXED: Enhanced mobile scroll initialization
    function initializeMobileScrolling() {
        // Detect mobile view changes
        checkMobileView();
        window.addEventListener('resize', debounce(checkMobileView, 250));

        // Initialize scroll listener
        window.addEventListener('scroll', debounce(handleScroll, 100));

        // FIXED: Better monitor view toggle buttons with enhanced event handling
        const stackedViewBtn = document.getElementById('stackedView');
        const scrollViewBtn = document.getElementById('scrollView');

        if (stackedViewBtn && scrollViewBtn) {
            // Remove any existing listeners
            stackedViewBtn.replaceWith(stackedViewBtn.cloneNode(true));
            scrollViewBtn.replaceWith(scrollViewBtn.cloneNode(true));

            // Get the new elements and add fresh listeners
            const newStackedBtn = document.getElementById('stackedView');
            const newScrollBtn = document.getElementById('scrollView');

            newStackedBtn.addEventListener('click', function () {
                enableMobileCardView();
            });

            newScrollBtn.addEventListener('click', function () {
                disableMobileCardView();
            });
        }
    }


    function checkMobileView() {
        const wasMobile = isMobileView;
        isMobileView = window.innerWidth <= 768;

        // Check if we're in card view mode
        const tableContainer = document.getElementById('tableContainer');
        const isCardView = tableContainer && tableContainer.classList.contains('mobile-stack');

        // Get current button states
        const stackedViewBtn = document.getElementById('stackedView');
        const scrollViewBtn = document.getElementById('scrollView');

        // NEW: Auto-enable card view when switching to mobile
        if (!wasMobile && isMobileView) {
            // Switching from desktop to mobile - enable card view by default
            if (stackedViewBtn && scrollViewBtn && tableContainer) {
                stackedViewBtn.classList.add('active');
                scrollViewBtn.classList.remove('active');
                tableContainer.classList.add('mobile-stack');
                enableInfiniteScroll();
                return; // Early return to avoid further logic
            }
        }

        const stackedActive = stackedViewBtn && stackedViewBtn.classList.contains('active');

        // Enable infinite scroll only on mobile in card view AND when stacked view is active
        const shouldEnable = isMobileView && isCardView && stackedActive;

        if (shouldEnable !== isInfiniteScrollEnabled) {
            if (shouldEnable) {
                enableInfiniteScroll();
            } else {
                disableInfiniteScroll();
            }
        }

        // If switching from mobile to desktop, ensure proper table view
        if (wasMobile && !isMobileView) {
            // Force disable infinite scroll
            if (isInfiniteScrollEnabled) {
                disableInfiniteScroll();
            }

            // Ensure table view is properly set
            if (tableContainer && tableContainer.classList.contains('mobile-stack')) {
                if (scrollViewBtn && stackedViewBtn) {
                    scrollViewBtn.classList.add('active');
                    stackedViewBtn.classList.remove('active');
                    tableContainer.classList.remove('mobile-stack');
                    renderTableData(currentPageData);
                }
            }
        }
    }

    function enableMobileCardView() {
        const stackedViewBtn = document.getElementById('stackedView');
        const scrollViewBtn = document.getElementById('scrollView');
        const tableContainer = document.getElementById('tableContainer');

        if (stackedViewBtn && scrollViewBtn && tableContainer) {
            stackedViewBtn.classList.add('active');
            scrollViewBtn.classList.remove('active');
            tableContainer.classList.add('mobile-stack');

            // Enable infinite scroll if on mobile
            if (isMobileView) {
                enableInfiniteScroll();
            }
        }
    }

    function disableMobileCardView() {
        const stackedViewBtn = document.getElementById('stackedView');
        const scrollViewBtn = document.getElementById('scrollView');
        const tableContainer = document.getElementById('tableContainer');

        if (stackedViewBtn && scrollViewBtn && tableContainer) {
            scrollViewBtn.classList.add('active');
            stackedViewBtn.classList.remove('active');
            tableContainer.classList.remove('mobile-stack');

            // FIXED: Disable infinite scroll and revert to normal table
            if (isInfiniteScrollEnabled) {
                disableInfiniteScroll();
            }

            // FIXED: Force re-render as normal table
            setTimeout(() => {
                renderTableData(currentPageData);
            }, 100);
        }
    }

    function enableInfiniteScroll() {
        if (isInfiniteScrollEnabled) return;

        isInfiniteScrollEnabled = true;

        // Hide pagination controls
        hidePaginationControls();

        // Initialize with current data
        loadedPages.clear();
        loadedPages.add(currentPage);
        allLoadedData = [...currentPageData];
        hasMoreData = currentPage < totalPages;

        // Render all loaded data as cards
        renderMobileCards(allLoadedData);

        // Show loading indicator at bottom
        showInfiniteScrollIndicator();

        console.log('Infinite scroll enabled');
    }

    function disableInfiniteScroll() {
        if (!isInfiniteScrollEnabled) return;

        isInfiniteScrollEnabled = false;
        isLoadingMore = false;

        // Show pagination controls
        showPaginationControls();

        // Hide infinite scroll indicators
        hideInfiniteScrollIndicator();
        hideLoadingMoreIndicator();
        const endIndicator = document.getElementById('endOfDataIndicator');
        if (endIndicator) endIndicator.style.display = 'none';

        // FIXED: Reset to normal table view with proper data
        resetToNormalPagination();

        console.log('Infinite scroll disabled');
    }


    function resetToNormalPagination() {
        // Reset data arrays
        loadedPages.clear();
        allLoadedData = [];
        hasMoreData = true;

        // FIXED: Use current page data if available, otherwise reload
        if (currentPageData && currentPageData.length > 0) {
            renderTableData(currentPageData);
            updatePaginationControls();
            updatePaginationInfo();
        } else {
            // Reload current page normally
            loadPageFromServer(currentPage, currentSearchTerm, currentSortColumn, currentSortDirection);
        }
    }

    // ============================================================================
    // SCROLL HANDLING
    // ============================================================================

    function handleScroll() {
        if (!isInfiniteScrollEnabled || isLoadingMore || !hasMoreData) return;

        // Check if we're near the bottom of the page
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const windowHeight = window.innerHeight;
        const documentHeight = document.documentElement.scrollHeight;

        const distanceFromBottom = documentHeight - (scrollTop + windowHeight);

        if (distanceFromBottom <= scrollThreshold) {
            loadMoreData();
        }
    }

    async function loadMoreData() {
        if (isLoadingMore || !hasMoreData) return;

       const nextPage = loadedPages.size + 1;

        if (nextPage > totalPages) {
            hasMoreData = false;
            hideInfiniteScrollIndicator();
            showEndOfDataIndicator();
            return;
        }

        isLoadingMore = true;
        showLoadingMoreIndicator();

        console.log('Loading more data, page:', nextPage); // Debug log

        try {
            // FIXED: Pass current sort and search parameters, fetchPageData will handle filters
            const data = await fetchPageData(nextPage, currentSearchTerm, currentSortColumn, currentSortDirection);

            if (data && data.content && data.content.length > 0) {
                // Add new data to our collection
                allLoadedData = [...allLoadedData, ...data.content];
                loadedPages.add(nextPage);

                // Update server data map
                Object.assign(serverRateFieldValuesMap, data.rateFieldValuesMap || {});

                // Re-render all cards with new data
                renderMobileCards(allLoadedData);

                // Update pagination info for user feedback
                updateInfiniteScrollInfo();

                // Check if there's more data
                hasMoreData = nextPage < totalPages;

                console.log('Loaded page:', nextPage, 'Total items now:', allLoadedData.length); // Debug log

                if (!hasMoreData) {
                    hideInfiniteScrollIndicator();
                    showEndOfDataIndicator();
                }
            } else {
                hasMoreData = false;
                hideInfiniteScrollIndicator();
                showEndOfDataIndicator();
            }
        } catch (error) {
            console.error('Error loading more data:', error);
            showDeleteNotification('Error loading more data: ' + error.message, true);
        } finally {
            isLoadingMore = false;
            hideLoadingMoreIndicator();
        }
    }


   async function fetchPageData(page, searchTerm = '', sortBy = null, sortDir = null) {
        const params = new URLSearchParams({
            page: page - 1, // Convert to 0-based for backend
            size: pageSize,
            sortBy: sortBy || currentSortColumn,
            sortDir: sortDir || currentSortDirection
        });

        if (searchTerm && searchTerm.trim()) {
            params.append('search', searchTerm.trim());
        }

        // FIXED: Add filter parameters from activeFilters using pipe separator
        if (typeof activeFilters !== 'undefined' && activeFilters.size > 0) {
            activeFilters.forEach((values, fieldId) => {
                if (values.size > 0) {
                    const filterValue = Array.from(values).join('|');
                    params.set(`filter_${fieldId}`, encodeURIComponent(filterValue));
                }
            });
        }

        console.log('Fetching page with params:', params.toString()); // Debug log

        const response = await fetch(`/api/interest-rates?${params.toString()}`);

        if (!response.ok) {
            throw new Error('Failed to fetch data');
        }

        return await response.json();
    }

    // ============================================================================
    // MOBILE CARD RENDERING
    // ============================================================================

    function renderMobileCards(data) {
        const tbody = document.getElementById('tableBody');
        const emptyState = document.getElementById('emptyState');

        if (!data || data.length === 0) {
            tbody.innerHTML = '';
            emptyState.style.display = 'block';
            return;
        }

        emptyState.style.display = 'none';

        // Create card-based layout for mobile
        tbody.innerHTML = data.map(rate => createMobileCard(rate))
            .join('');
    }

    // Replace the createMobileCard function in your existing code with this enhanced version

    function createMobileCard(rate) {
        // Get current field order from headers
        const headers = document.querySelectorAll('.draggable-column, .sortable');
        const currentFieldOrder = Array.from(headers)
            .map(header => ({
                id: header.dataset.fieldId,
                fieldKey: header.dataset.fieldKey,
                label: header.querySelector('.header-text')
                    .textContent.trim()
            }));

        // Generate field rows for the card
        const fieldRows = currentFieldOrder.map(field => {
            const fieldValue = serverRateFieldValuesMap[rate.id]?.[field.id] || '';

    if (field.fieldKey && field.fieldKey.toLowerCase().includes('img')) {
    if (isAuthenticated) {
        return `
            <div class="card-field-row">
                <label class="card-field-label">${field.label}:</label>
                <div class="card-field-value">
                    <div class="mobile-image-container" data-field-id="${field.id}" data-label="${field.label}">
                        <div class="image-display clickable-image" onclick="showMobileImageUpload(${rate.id}, ${field.id}, '${fieldValue}', this)">
                            ${fieldValue ? `<img src="${fieldValue}" alt="Interest Rate Logo" class="interest-rate-logo mobile-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />` : ''}
                            <div class="no-image-placeholder mobile-placeholder" style="${fieldValue ? 'display:none' : 'display:block'}">
                                <span>No Image</span>
                                <small>Tap to upload</small>
                            </div>
                        </div>

                        <!-- Mobile Image Upload Form (initially hidden) -->
                        <div class="mobile-image-upload" id="mobileImageUpload_${rate.id}_${field.id}" style="display: none;">
                            <form class="mobile-upload-form" onsubmit="uploadMobileImage(event, ${rate.id}, ${field.id}, this)" enctype="multipart/form-data">
                                <div class="mobile-upload-area">
                                    <input type="file"
                                           accept="image/*"
                                           class="mobile-file-input hidden-file-input"
                                           id="mobileFileInput_${rate.id}_${field.id}"
                                           onchange="previewMobileImage(this, ${rate.id}, ${field.id})" />
                                    <label for="mobileFileInput_${rate.id}_${field.id}" class="mobile-upload-label">
                                        <div class="upload-icon">📁</div>
                                        <span>Choose Image</span>
                                    </label>
                                </div>

                                <div class="mobile-image-preview" id="mobilePreview_${rate.id}_${field.id}" style="display: none;">
                                    <img src="" alt="Preview" class="mobile-preview-img" />
                                </div>

                                <div class="mobile-upload-buttons">
                                    <button type="button"
                                            class="btn btn-success btn-sm mobile-upload-btn"
                                            id="mobileUploadBtn_${rate.id}_${field.id}"
                                            onclick="uploadMobileImage(event, ${rate.id}, ${field.id})"
                                            disabled>
                                        Upload
                                    </button>
                                    ${fieldValue ? `<button type="button" class="btn btn-danger btn-sm mobile-delete-btn" onclick="deleteMobileImage(${rate.id}, ${field.id})">Delete</button>` : ''}
                                    <button type="button" class="btn btn-secondary btn-sm mobile-cancel-btn" onclick="cancelMobileImageUpload(${rate.id}, ${field.id})">
                                        Cancel
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        `;
    } else {
                    // Guest view - display only
                    return `
                        <div class="card-field-row">
                            <label class="card-field-label">${field.label}:</label>
                            <div class="card-field-value">
                                <div class="mobile-image-container readonly">
                                    ${fieldValue ? `<img src="${fieldValue}" alt="Interest Rate Logo" class="interest-rate-logo mobile-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />` : ''}
                                    <div class="no-image-placeholder mobile-placeholder" style="${fieldValue ? 'display:none' : 'display:block'}">No Image</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            } else {
                // Regular non-image field (existing logic)
                if (isAuthenticated) {
                    return `
                        <div class="card-field-row">
                            <label class="card-field-label">${field.label}:</label>
                            <div class="card-field-value">
                                <form class="d-flex" method="post" action="/field-values/update">
                                    <input name="rateId" value="${rate.id}" type="hidden"/>
                                    <input name="fieldId" value="${field.id}" type="hidden"/>
                                    <input class="form-control form-control-sm"
                                           name="value"
                                           value="${fieldValue}"
                                           type="text"
                                           onchange="updateFieldValueAjax(${rate.id}, ${field.id}, this.value)"/>
                                </form>
                            </div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="card-field-row">
                            <label class="card-field-label">${field.label}:</label>
                            <div class="card-field-value">
                                <span class="card-field-display">${fieldValue || '-'}</span>
                            </div>
                        </div>
                    `;
                }
            }
        }).join('');

        // Action buttons (existing logic)
        let actionButtons = '';
        if (isAuthenticated) {
            actionButtons = `
                <div class="card-actions">
                    <button class="btn btn-info btn-sm mehr-info-btn-card"
                            ${rate.moreInfo ? '' : 'disabled'}
                            onclick="showMoreInfo(${rate.id})"
                            title="${rate.moreInfo ? 'Show more info' : 'No additional info available'}">
                        ${rate.moreInfo ? 'MEHR INFO' : 'No Info'}
                    </button>
                    <a class="btn btn-primary btn-sm angebot-btn-card"
                       href="${rate.webLink || '#'}"
                       target="_blank"
                       title="Open Link">
                        ZUM ANGEBOT
                    </a>
                    <div class="card-admin-actions">
                        <a class="btn btn-outline-secondary btn-sm" href="/interest-rate/edit/${rate.id}" title="Edit">
                            ✎ Edit
                        </a>
                        <button class="btn btn-outline-danger btn-sm"
                                onclick="showDeleteConfirmation(${rate.id})"
                                title="Delete">
                            🗑 Delete
                        </button>
                    </div>
                </div>
            `;
        } else {
            actionButtons = `
                <div class="card-actions">
                    <button class="btn btn-info btn-sm mehr-info-btn-card"
                            ${rate.moreInfo ? '' : 'disabled'}
                            onclick="showMoreInfo(${rate.id})"
                            title="${rate.moreInfo ? 'Show more info' : 'No additional info available'}">
                        ${rate.moreInfo ? 'MEHR INFO' : 'No Info'}
                    </button>
                    <a class="btn btn-primary btn-sm angebot-btn-card"
                       href="${rate.webLink || '#'}"
                       target="_blank"
                       title="Open Link">
                        ZUM ANGEBOT
                    </a>
                </div>
            `;
        }

        return `
            <div class="mobile-card-row" data-rate-id="${rate.id}">
                <div colspan="100%">
                    <div class="mobile-interest-card" data-rate-id="${rate.id}">
                        <div class="card-header">
                            <h6 class="card-title mb-0">Interest Rate #${rate.id}</h6>
                        </div>
                        <div class="card-body">
                            ${fieldRows}
                            ${actionButtons}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // Mobile-specific image upload functions
    function showMobileImageUpload(rateId, fieldId, currentValue, container) {
        if (!isAuthenticated) {
            showDeleteNotification('You must be logged in to upload images.', true);
            return;
        }

        // Hide the image display and show the upload form
        const imageDisplay = container;
        const uploadForm = document.getElementById(`mobileImageUpload_${rateId}_${fieldId}`);

        if (uploadForm) {
            imageDisplay.style.display = 'none';
            uploadForm.style.display = 'block';
        }
    }

    function previewMobileImage(input, rateId, fieldId) {
        const file = input.files[0];
        const preview = document.getElementById(`mobilePreview_${rateId}_${fieldId}`);
        const uploadBtn = document.getElementById(`mobileUploadBtn_${rateId}_${fieldId}`);

        if (file) {
            // Validate file type
            if (!file.type.startsWith('image/')) {
                showDeleteNotification('Please select a valid image file.', true);
                input.value = '';
                return;
            }

            // Validate file size (5MB limit)
            if (file.size > 5 * 1024 * 1024) {
                showDeleteNotification('File size must be less than 5MB.', true);
                input.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                preview.querySelector('img').src = e.target.result;
                preview.style.display = 'block';
                uploadBtn.disabled = false;
            };
            reader.readAsDataURL(file);
        } else {
            preview.style.display = 'none';
            uploadBtn.disabled = true;
        }
    }

    function uploadMobileImage(event, rateId, fieldId) {
        event.preventDefault();

        const fileInput = document.getElementById(`mobileFileInput_${rateId}_${fieldId}`);
        const uploadBtn = document.getElementById(`mobileUploadBtn_${rateId}_${fieldId}`);

        if (!fileInput || !fileInput.files[0]) {
            showDeleteNotification('Please select an image to upload.', true);
            return;
        }

        const formData = new FormData();
        formData.append('image', fileInput.files[0]);
        formData.append('rateId', rateId);
        formData.append('fieldId', fieldId);

        uploadBtn.disabled = true;
        uploadBtn.textContent = 'Uploading...';

        fetch('/api/upload-image', {
            method: 'POST',
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                showDeleteNotification('Image uploaded successfully!', false);
                 setTimeout(() => {
                window.location.reload();
            }, 200);
            } else {
                throw new Error(data.message || 'Upload failed');
            }
        })
        .catch(err => {
            showDeleteNotification('Error: ' + err.message, true);
        })
        .finally(() => {
            uploadBtn.disabled = false;
            uploadBtn.textContent = 'Upload';
        });
    }


    function deleteMobileImage(rateId, fieldId) {
        if (!confirm('Are you sure you want to delete this image?')) {
            return;
        }

        fetch('/api/delete-image', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                rateId: rateId,
                fieldId: fieldId
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Delete failed');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Update server data map
                if (serverRateFieldValuesMap[rateId]) {
                    serverRateFieldValuesMap[rateId][fieldId] = '';
                }

                showDeleteNotification('Image deleted successfully!', false);

                // Re-render the mobile cards
                if (isInfiniteScrollEnabled) {
                    renderMobileCards(allLoadedData);
                } else {
                    renderMobileCards(currentPageData);
                }
            } else {
                throw new Error(data.message || 'Delete failed');
            }
        })
        .catch(error => {
            showDeleteNotification('Error deleting image: ' + error.message, true);
        });
    }

    function cancelMobileImageUpload(rateId, fieldId) {
        const imageDisplay = document.querySelector(`#mobileImageUpload_${rateId}_${fieldId}`)?.previousElementSibling;
        const uploadForm = document.getElementById(`mobileImageUpload_${rateId}_${fieldId}`);

        // Reset form
        const fileInput = uploadForm.querySelector('input[type="file"]');
        const preview = document.getElementById(`mobilePreview_${rateId}_${fieldId}`);
        const uploadBtn = document.getElementById(`mobileUploadBtn_${rateId}_${fieldId}`);

        if (fileInput) fileInput.value = '';
        if (preview) preview.style.display = 'none';
        if (uploadBtn) uploadBtn.disabled = true;

        // Hide form and show image
        if (imageDisplay && uploadForm) {
            uploadForm.style.display = 'none';
            imageDisplay.style.display = 'block';
        }
    }

    function updateMobileFieldValue(rateId, fieldId, value) {
        updateFieldValueAjax(rateId, fieldId, value);
    }

    function updateMobileImageDisplay(inputElement, imagePath) {
        const container = inputElement.closest('.mobile-image-container');
        const img = container.querySelector('img');
        const placeholder = container.querySelector('.no-image-placeholder');

        if (imagePath && imagePath.trim()) {
            if (img) {
                img.src = imagePath;
                img.style.display = 'block';
                placeholder.style.display = 'none';
            } else {
                // Create new img element if it doesn't exist
                const newImg = document.createElement('img');
                newImg.src = imagePath;
                newImg.alt = 'Interest Rate Logo';
                newImg.className = 'interest-rate-logo mobile-image';
                newImg.onerror = function() {
                    this.style.display = 'none';
                    placeholder.style.display = 'block';
                };
                container.querySelector('.image-display').insertBefore(newImg, placeholder);
                placeholder.style.display = 'none';
            }
        } else {
            if (img) {
                img.style.display = 'none';
            }
            placeholder.style.display = 'block';
            placeholder.innerHTML = `
                <span>No Image</span>
                <small>Tap to upload</small>
            `;
        }
    }

    // ============================================================================
    // UI INDICATORS AND CONTROLS
    // ============================================================================

    function hidePaginationControls() {
        const paginationContainers = document.querySelectorAll('.pagination-container');
        paginationContainers.forEach(container => {
            container.style.display = 'none';
        });
    }

    function showPaginationControls() {
        const paginationContainers = document.querySelectorAll('.pagination-container');
        paginationContainers.forEach(container => {
            container.style.display = 'flex';
        });
    }

    function showInfiniteScrollIndicator() {
        let indicator = document.getElementById('infiniteScrollIndicator');
        if (!indicator) {
            indicator = document.createElement('div');
            indicator.id = 'infiniteScrollIndicator';
            indicator.className = 'infinite-scroll-indicator';
            indicator.innerHTML = `
            <div class="text-center py-3">
                <div class="text-muted">Scroll down to load more...</div>
            </div>
        `;

            // Insert after the table container
            const tableContainer = document.querySelector('.table-container');
            if (tableContainer) {
                tableContainer.parentNode.insertBefore(indicator, tableContainer.nextSibling);
            }
        }
        indicator.style.display = 'block';
    }

    function hideInfiniteScrollIndicator() {
        const indicator = document.getElementById('infiniteScrollIndicator');
        if (indicator) {
            indicator.style.display = 'none';
        }
    }

    function showLoadingMoreIndicator() {
        let indicator = document.getElementById('loadingMoreIndicator');
        if (!indicator) {
            indicator = document.createElement('div');
            indicator.id = 'loadingMoreIndicator';
            indicator.className = 'loading-more-indicator';
            indicator.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border spinner-border-sm me-2" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <span class="text-muted">Loading more rates...</span>
            </div>
        `;

            const tableContainer = document.querySelector('.table-container');
            if (tableContainer) {
                tableContainer.parentNode.insertBefore(indicator, tableContainer.nextSibling);
            }
        }
        indicator.style.display = 'block';
    }

    function hideLoadingMoreIndicator() {
        const indicator = document.getElementById('loadingMoreIndicator');
        if (indicator) {
            indicator.style.display = 'none';
        }
    }

    function showEndOfDataIndicator() {
        let indicator = document.getElementById('endOfDataIndicator');
        if (!indicator) {
            indicator = document.createElement('div');
            indicator.id = 'endOfDataIndicator';
            indicator.className = 'end-of-data-indicator';
            indicator.innerHTML = `
            <div class="text-center py-3">
                <div class="text-muted">
                    <div>📊</div>
                    <small>You've reached the end of the results</small>
                </div>
            </div>
        `;

            const tableContainer = document.querySelector('.table-container');
            if (tableContainer) {
                tableContainer.parentNode.insertBefore(indicator, tableContainer.nextSibling);
            }
        }
        indicator.style.display = 'block';
    }

    function updateInfiniteScrollInfo() {
        const totalLoaded = allLoadedData.length;
        const infoText = `Showing ${totalLoaded} of ${totalRecords} results`;

        // Update the results info at the top
        const resultsInfo = document.getElementById('resultsInfo');
        if (resultsInfo) {
            resultsInfo.textContent = infoText;
        }
    }

    // ============================================================================
    // UTILITY FUNCTIONS
    // ============================================================================

    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // ============================================================================
    // OVERRIDE EXISTING FUNCTIONS FOR MOBILE COMPATIBILITY
    // ============================================================================

    // Override search functions to work with infinite scroll
    const originalPerformSearchMobile = window.performSearch;
    window.performSearch = function () {
        const searchInput = document.getElementById('searchInput');
        const searchTerm = searchInput ? searchInput.value.trim() : '';

        if (isInfiniteScrollEnabled) {
            // Reset infinite scroll state
            loadedPages.clear();
            allLoadedData = [];
            hasMoreData = true;
            currentPage = 1;

            // Load first page with search
            loadPageFromServerWithInfiniteScroll(1, searchTerm);
        } else {
            // Use normal search
            originalPerformSearchMobile();
        }
    };

    const originalClearSearchMobile = window.clearSearch;
    window.clearSearch = function () {
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.value = '';
        }

        if (isInfiniteScrollEnabled) {
            // Reset infinite scroll state
            loadedPages.clear();
            allLoadedData = [];
            hasMoreData = true;
            currentPage = 1;

            // Load first page without search
            loadPageFromServerWithInfiniteScroll(1, '');
        } else {
            // Use normal clear
            originalClearSearchMobile();
        }
    };

    // Special function for loading data in infinite scroll mode
    async function loadPageFromServerWithInfiniteScroll(page, searchTerm = '', sortBy = null, sortDir = null) {
        if (isLoadingMore && page > 1) return; // Only block additional page loads, not filter resets

        showLoading();

        try {
            // FIXED: Use the enhanced fetchPageData which now includes filters
            const data = await fetchPageData(page, searchTerm, sortBy, sortDir);

            // Update pagination state
            currentPage = page;
            totalPages = data.totalPages;
            totalRecords = data.totalElements;
            currentSearchTerm = searchTerm || '';

            // Update sort state if provided
            if (sortBy) currentSortColumn = sortBy;
            if (sortDir) currentSortDirection = sortDir;

            // Initialize infinite scroll data
            loadedPages.clear();
            loadedPages.add(page);
            allLoadedData = [...data.content];
            serverRateFieldValuesMap = data.rateFieldValuesMap || {};

            // Render cards
            renderMobileCards(allLoadedData);

            // Update UI
            updateInfiniteScrollInfo();
            hasMoreData = page < totalPages;

            console.log('Loaded page:', page, 'Total pages:', totalPages, 'Has more:', hasMoreData); // Debug log

            if (hasMoreData) {
                showInfiniteScrollIndicator();
            } else {
                hideInfiniteScrollIndicator();
                showEndOfDataIndicator();
            }

            hideLoading();
        } catch (error) {
            console.error('Error loading page:', error);
            showDeleteNotification('Error loading data: ' + error.message, true);
            hideLoading();
        }
    }

    // ============================================================================
    // INITIALIZATION
    // ============================================================================

    document.addEventListener('DOMContentLoaded', function () {
        const stackedViewBtn = document.getElementById('stackedView');
        const scrollViewBtn = document.getElementById('scrollView');
        const tableContainer = document.getElementById('tableContainer');

        if (stackedViewBtn && scrollViewBtn && tableContainer) {
            stackedViewBtn.addEventListener('click', function () {
                enableMobileCardView();
            });

            scrollViewBtn.addEventListener('click', function () {
                disableMobileCardView();
            });
        }
    });

    // Export functions for debugging
    window.mobileScrollFunctions = {
        enableInfiniteScroll,
        disableInfiniteScroll,
        loadMoreData,
        renderMobileCards,
        checkMobileView
    };


    // FIXED: Override the original functions to use the fixed versions
    window.createMobileCard = createMobileCard;
    window.showMoreInfo = showMoreInfo;
    window.displayRateCard = displayRateCard;
    window.enableMobileCardView = enableMobileCardView;
    window.disableMobileCardView = disableMobileCardView;
    window.disableInfiniteScroll = disableInfiniteScroll;
    window.resetToNormalPagination = resetToNormalPagination;
    window.checkMobileView = checkMobileView;
    window.initializeMobileScrolling = initializeMobileScrolling;
    window.applyFilters = applyFilters;
    window.removeFilterTag = removeFilterTag;
    window.clearAllFilters = clearAllFilters;
    window.performSearch = performSearch;
    window.clearSearch = clearSearch;
    window.loadMoreData = loadMoreData;
    window.fetchPageData = fetchPageData;
    window.loadPageFromServerWithInfiniteScroll = loadPageFromServerWithInfiniteScroll;

    // Debug function to check current filter state
    window.debugFilters = function () {
        console.log('Active filters:', activeFilters);
        console.log('Is infinite scroll enabled:', isInfiniteScrollEnabled);
        console.log('Current page:', currentPage);
        console.log('Total pages:', totalPages);
        console.log('Has more data:', hasMoreData);
        console.log('Loaded pages:', loadedPages);
        console.log('All loaded data length:', allLoadedData.length);
    };

    console.log('Filter integration for infinite scroll has been fixed!');
</script>
</body>
</html>